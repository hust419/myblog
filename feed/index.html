<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>三两带走</title>
	<atom:link href="http://rentb.vicp.net/feed" rel="self" type="application/rss+xml" />
	<link>http://huster.top/</link>
	<description>(任天兵)龙安的博客</description>
	<lastBuildDate>Fri, 03 Jul 2020 04:16:34 +0000</lastBuildDate>
	<language>zh-CN</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.9.10</generator>

<image>
	<url>https://huster.top/wp-content/uploads/2018/09/cropped-fish_112.18181818182px_1208536_easyicon.net_-32x32.png</url>
	<title>三两带走</title>
	<link>http://huster.top/</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>生产FullGC问题排查</title>
		<link>https://huster.top/htmls/720.html</link>
		<comments>https://huster.top/htmls/720.html#respond</comments>
		<pubDate>Sun, 28 Jun 2020 08:13:08 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[Java学习]]></category>

		<guid isPermaLink="false">https://huster.top/?p=720</guid>
		<description><![CDATA[FullGC时间过长 &#160; 问题 突然来了一波gc时间过长的告警，类似下面这个，接着接二连三的来了很多 &#8230; <a href="https://huster.top/htmls/720.html" class="more-link">继续阅读<span class="screen-reader-text">“生产FullGC问题排查”</span></a>]]></description>
				<content:encoded><![CDATA[<h1>FullGC时间过长</h1>
<p>&nbsp;</p>
<div class="lake-content-editor-core lake-engine lake-typography-classic" data-lake-element="root" data-selection-180554="%7B%22path%22%3A%5B%5B92%2C0%2C4%5D%2C%5B92%2C0%2C4%5D%5D%2C%22uuid%22%3A%22180554%22%2C%22active%22%3Atrue%7D">
<h1 id="qzE4Q" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 28px; line-height: 36px;" data-lake-id="23466eb074f518106519e48041dcbfbc">问题</h1>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="fb2a5ed1334fa4fc14d39ef94751d2d5">突然来了一波gc时间过长的告警，类似下面这个，接着接二连三的来了很多机器都是同样的情况，看来集群同时发生了FullGC, 而且时间还不短。</p>
<p data-lake-id="fb2a5ed1334fa4fc14d39ef94751d2d5">
<p data-lake-id="fb2a5ed1334fa4fc14d39ef94751d2d5">
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="ba09d0a0fac50dc3dc4d19644d8111a0"><a href="https://huster.top/wp-content/uploads/2020/06/1.png"><img class="alignnone size-full wp-image-724" src="https://huster.top/wp-content/uploads/2020/06/1.png" alt="" width="463" height="511" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="d1e4f9bc7064e7585bfb2d7389136d9a"><a href="https://huster.top/wp-content/uploads/2020/06/2-2.png"><img class="alignnone size-full wp-image-728" src="https://huster.top/wp-content/uploads/2020/06/2-2.png" alt="" width="746" height="170" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="f12de10e6a0999082df1a65692ccf1ff">通常来说，fullGC也不是什么问题，即使你的GC时间超过了500ms，也没有影响业务, 没有上游业务的超时告警。但是你看看，这个old区的内存max最大设置了7个G, 而且我们每周至少发布一次，还发生了fullGC，就有点说不过去了，值得好好看一下. 有这么大的空间要GC，当然超过了500ms也不足为奇了.</p>
<p data-lake-id="f12de10e6a0999082df1a65692ccf1ff">
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="6d47003f0b7653742770eba079725170">2020-06-14T21:11:03.623+0800: 347435.070: [GC (CMS Final Remark) [YG occupancy: 1425258 K (3145472 K)]2020-06-14T21:11:03.624+0800: 347435.071: [Rescan (parallel) , 0.2118361 secs]2020-06-14T21:11:03.836+0800: 347435.283: [weak refs processing, 0.3505888 secs]2020-06-14T21:11:04.186+0800: 347435.634: [class unloading, 0.0493179 secs]2020-06-14T21:11:04.236+0800: 347435.683: [scrub symbol table, 0.0162566 secs]2020-06-14T21:11:04.252+0800: 347435.699: [scrub string table, 0.0022326 secs][1 CMS-remark: 4334730K(6990848K)] 5759989K(10136320K), 0.6480160 secs] [Times: user=1.97 sys=0.00, real=0.65 secs]</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="76b3014e114231eb7105c707c3d6afcc">主要时间耗费在了scan和weak refs processing, 说明里面的对象非常多</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="b132c337d2a1a4e23410c32d40b8c2e2">一打开流量，old区就增加，一直到full gc. 一停止流量，old区就基本不变，这个太奇怪了。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="7136a11e9f6c272d727c332514776ca1"><span class="lake-card-margin-top lake-card-margin-bottom" data-card-type="inline" data-lake-card="image"><a href="https://huster.top/wp-content/uploads/2020/06/3.png"><img class="alignnone size-full wp-image-729" src="https://huster.top/wp-content/uploads/2020/06/3.png" alt="" width="598" height="183" /></a></span></p>
<h1 id="OYwXB" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 28px; line-height: 36px;" data-lake-id="8ec2cf89768a5fcca7ee6d4e56a3ee1b">heap dump分析开始推测</h1>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="578a7e771e174212c688b934fa81201c">要分析gc问题，就离不开heap dump， 将机器拉下线，然后 jmap -dump:format=b,file=xxxxxx.hprof pid</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="0c3917228bf50fa248fe508626bdb0e0">进行dump，把dump文件压缩一下，不压缩有3个G, 压缩完只有400M，压缩比还是非常高的。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="df56d928d1bedfeff1615a134580bae1">前几次没有压缩，使用sz从服务器上download，没有断点续传，一掉线就得从头开始。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="53416bf2a133903ceeacda027ff3501b">继续看dump文件，发现里面有一些可疑的地方。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="10bc82abc0c27023811f2d8f88fc0942">使用mat打开dump文件，使用Leak Suspects:功能，提示有三个问题。都是java自身的类，这就比较头大了。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="61312a27bb5d76013f2f958630437f53">我dump了很多次，挨个分析，</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="52725384ba0f2e7f6ce94905635d0a35">dump1的提示</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="03ce0249ceea2680142ff746038940db"><a href="https://huster.top/wp-content/uploads/2020/06/4.png"><img class="alignnone size-full wp-image-730" src="https://huster.top/wp-content/uploads/2020/06/4.png" alt="" width="621" height="619" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="990b0019e0128897bba401a2606980b3">dump2的提示</p>
<p data-lake-id="990b0019e0128897bba401a2606980b3"><a href="https://huster.top/wp-content/uploads/2020/06/5.png"><img class="alignnone size-full wp-image-731" src="https://huster.top/wp-content/uploads/2020/06/5.png" alt="" width="633" height="463" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="839192297bc77bb8277e9cf43a572fea">
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="9d4272a577ba78a2f9d397613a577027">dump3的提示</p>
<p data-lake-id="9d4272a577ba78a2f9d397613a577027"><a href="https://huster.top/wp-content/uploads/2020/06/6.png"><img class="alignnone size-full wp-image-732" src="https://huster.top/wp-content/uploads/2020/06/6.png" alt="" width="638" height="617" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="6e651c1c451d661f6ba667e2ff4d9ec1">
<h2 id="1CPbD" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 24px; line-height: 32px;" data-lake-id="07e0ddc7a09b0ab00578a5f36a1cef16">java.lang.Thread</h2>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="5334eae8bf21ce29e2e38ac80ca20c7e">每个dump文件里都有java.lang.Thread的这个东西，于是打开tree看看，终于看到了熟悉的我们自己写的类，原来这是一个配置文件的类，他里面有很多的配置，有些配置本身比较大，是json对象，导致了占用了很多空间。再仔细看看，持有的这个对象在所有线程里都是同一个，内存地址一样的。所以虽然thread占据了空间，但是其实是同一个对象的重复统计了.而且可以明显的看到，每个线程的hetained heap大小基本一致, 所以这个暂时就先排除了。</p>
<h2 id="Lbdxo" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 24px; line-height: 32px;" data-lake-id="a45bfcba86c64ed34953f50342fd444d">java.lang.ref.Finalizer</h2>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="ed3ce9e2a10743817c38a353de2dae62">那么是不是这个? java.lang.ref.Finalizer</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="5aefa8b8380dee7279f9fcd50f2894b3">打开tree进一步分析，发现java.lang.ref.Finalizer占了很多的内存。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="52ad3243fccbd1257d75d7fcb0a35619"><span class="lake-card-margin-top lake-card-margin-bottom" data-card-type="inline" data-lake-card="image"><a href="https://huster.top/wp-content/uploads/2020/06/76.png"><img class="alignnone size-full wp-image-733" src="https://huster.top/wp-content/uploads/2020/06/76.png" alt="" width="718" height="498" /></a></span></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="2568f62636d5ed1f3294dc560c95c1d4">接着使用这个功能 ， show retained set</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="a78828decaa77f0c91335cfc167f9f93"><a href="https://huster.top/wp-content/uploads/2020/06/8.png"><img class="alignnone size-full wp-image-734" src="https://huster.top/wp-content/uploads/2020/06/8.png" alt="" width="746" height="271" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="7e20eacf061749ec7ca6a1f706b1ac13">打开看到了和java.net.SocksSocketImpl发生了关联</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="a7d77f4fab88e17afa9979d8b5c140f4"><a href="https://huster.top/wp-content/uploads/2020/06/9.png"><img class="alignnone size-full wp-image-735" src="https://huster.top/wp-content/uploads/2020/06/9.png" alt="" width="694" height="551" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="a73780db20152583002665a76802f038">于是，一顿Google后了解到，Finalizer是一个优先级很低的资源回收线程，一般是实现了Object.finalize的类，会被这个线程给调用，由于他的优先级很低，所以轮不到他调度，要被调用的对象就被丢到队列里越积越多。而一般用户自己是不会去实现finalize这个方法的，恰恰SocksSocketImpl就实现了这个方法。这个是为了防止内存泄露，有的人忘记close，他会在SocksSocketImpl的finalize帮你去关闭资源。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="342016b7ee84919fb9af02d7be84e220">这样的文章很多，可以搜 java.lang.ref.Finalizer memory leak 关键字.</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="26ba749915a71a3808abbd76e71e4405">恰好，我们的系统作为一个服务端，就是一个线程很吃紧的服务，因为各种原因，应用一共开了接近3000个线程，导致了Finalizer肯定是被调度不到了，也就造成了内存不断的增加，最后导致fullGC.</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="06e1f181851ca0d3b0d2afc116402b28">感觉很像。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="325c68b52b33ffa3d08bdc863a582842">到底是不是这个东西呢？ 我分别dump了两次，一次是未接流量前，然后打开流量跑一个小时，再进行对比，对比发现Finalizer增加的非常快，看来是这个东西无疑了</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="4010ca35b7fc7f509ca8dc2ee9ada6d7"><a href="https://huster.top/wp-content/uploads/2020/06/10.png"><img class="alignnone size-full wp-image-736" src="https://huster.top/wp-content/uploads/2020/06/10.png" alt="" width="746" height="500" /></a></p>
<h1 id="IxUe0" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 28px; line-height: 36px;" data-lake-id="28a8dd4b1ae0ab026bfab581d66b2d64">寻找真凶</h1>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="ed16c449a6e00e851cac7aab74f49183">原理和推测我们基本搞清楚了，也算有了一个方向，那么我们就要寻找，到底是谁用了SocksSocketImpl这个东西，并且没有手动的close，放任他内存泄露呢？</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="c000fc63cf2f60bfe63a932050cfd253">这些都是jdk自己的类，而且是第三方的jar包调用的，不是业务代码，在代码里根本找不到关联。通过搜索SocksSocketImpl的调用方，根本关联不起来。这就非常头大了。</p>
<h2 id="EfnFH" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 24px; line-height: 32px;" data-lake-id="ea6ab92d804497d61bca75bb95191698">怀疑是不是内部的定时任务</h2>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="203d82d8eb3064ea6c1442fdd3b64f7e">看到代码里有两个定时任务，是从hdfs拉取模型数据的，最开始是怀疑这个东西，如果他没有用线程池，每次都发起新的连接，然后又不关闭的话，应该是会导致内存泄露的，能够和我们的分析对的上号。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="95793160c9e7aa21dddb465d972cbb91">但是奇怪的是，流量停止了之后为什么就不增加了呢？ 而流量停止了，我们的定时任务实际上仍然是在执行的。这个有点悖论，讲不通。</p>
<h2 id="VMLU3" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 24px; line-height: 32px;" data-lake-id="d303d6b38e3cd3a9f2bdf8c1e2382156">使用Arthas大杀器继续寻找真凶</h2>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="9790ee7b19de6c4752268f33b1a2be2f">将流量拉下线之后，我们使用Arthas这个大杀器。这个是使用了javaaent的技术，注入到原有的代码里，跟踪代码的运行情况的。我们使用trace功能，trace一下到底是谁new SocksSocketImpl这个东西。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="9bc8f0f33ab432320a6781200a27d21b">trace java.net.SocksSocketImpl *init* . 最开始用构造函数SocksSocketImpl不成功，使用sm java.net.SocksSocketImpl打开类里面加载的到底是个什么东西，发现函数不是SocksSocketImpl而是叫init.</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="61cffd3f416f4b79a16795ef4de415f9"><a href="https://huster.top/wp-content/uploads/2020/06/11.png"><img class="alignnone size-full wp-image-737" src="https://huster.top/wp-content/uploads/2020/06/11.png" alt="" width="746" height="448" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="89b15a2b846a456a1417cb6de11f1932">虽然没啥有用的信息，但是找到了一条关键的线索: commons-pool-evictor-thread, 又去Google发现是redis client使用的commons-pool线程池引进来的。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="763c68613dc7783ae992bb1d239fe9f2">然后打开这个线程池的类，再去搜哪里用到了他，依然是搜不到的，再次陷入了僵局。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="256783c66e5265dcfcfc8eae17b76188">jstack把线程打出来，依然找不到任何线索，那么这个东西到底是如何work的呢？</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="8bfd69491e3261a3c926adbd5a9bf753"><a href="https://huster.top/wp-content/uploads/2020/06/12.png"><img class="alignnone size-full wp-image-738" src="https://huster.top/wp-content/uploads/2020/06/12.png" alt="" width="746" height="201" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="ea28d8168b3aefd15798c3a434f8d6fb">本地debug开启，打开断点，停在断点的时候，可以看到调用的堆栈。发现果然是redis拉起来的，这是一个定时任务，从evictor这个单词可以看出，这个东西就是清除空闲线程作用的。这就很奇怪了，清楚空闲的线程跟SocksSocketImpl是如何关联上的呢？ 代码又不能搜索被谁用的，太麻烦了。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="2bbb5973c52c239972c9daef15001c7f">既然是定时程序，那么肯定也就跟流量无关了，本地也可以触发。于是把SocksSocketImpl打满了断点，</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="0477bea52f43a2aa68db7b1372d05775"><a href="https://huster.top/wp-content/uploads/2020/06/13.png"><img class="alignnone size-full wp-image-739" src="https://huster.top/wp-content/uploads/2020/06/13.png" alt="" width="387" height="323" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="7d3448a481a801c542c490dd64eb34a2">总算捕获到了这个断点，然后从idea的调用栈里面去寻找。理清楚了他们之间的关系。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="e0e5dfbe6599784b2b6200e76c6d0fd6">原来系统起来的时候，会去初始化redis client, redis.clients.jedis.connect这个类被初始化的时候，就会拉起一个定时任务来清楚空闲的线程，线程名字就叫做 commons-pool-evictor-thread， 接着这线程开始工作。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="ec7248ee01ea8f5cde45fd1175b6ffb2">这个线程是属于commons-pool这个池化的jar包里的内容，跟业务其实是不相关的。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="3142e7575210089924e7e281da9a2173">这个线程的入口在</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="0bcffc34a4b83bc5959b4ef42489c85d">org.apache.commons.pool2.impl.BaseGenericObjectPool.Evictor.run</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="2e16a4259e6cd2e4e7735a291a319874">这个run干了两件事， 先evict清楚空闲线程，再重新创建.</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="016365f5cd4a8c0a3e4e26d87cfdabea"><a href="https://huster.top/wp-content/uploads/2020/06/14.png"><img class="alignnone size-full wp-image-740" src="https://huster.top/wp-content/uploads/2020/06/14.png" alt="" width="746" height="477" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="e8b66697415a62c61d6d263e3e6b970f">如何去清楚空闲线程呢？</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="f4f0f0ff0779b2ec29111efef2c34152">    evict = evictionPolicy.evict(evictionConfig, underTest,</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="09994cc6657d368eb24116a46f26b619">                               idleObjects.size());</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="c4401f72ed4559693f12c96e9e1863fd">在这个方法里，这个underTest记录了最后使用的时间，然后和当前的时间比较，如果超过了空闲的时间（有默认配置）, 就会把他干掉。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="ada3c8216033c2e2fc11459352ea6081">org.apache.commons.pool2.impl.GenericObjectPool.ensureIdle这个方法就是重新拉起一个连接，具体实现在</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="46f6baf18fcc1c3fc46a962e7346f9d6">JedisFactory.makeObject里的 jedis.connect();这行代码，redis.clients.jedis方法如下</p>
<div id="hbPV8" class="lake-card-margin" data-card-type="block" data-lake-card="codeblock" data-language="java">
<div class="lake-codeblock-content" style="border: 1px solid #e8e8e8; max-width: 750px; color: #595959; margin: 0px; padding: 0px; background: #f9f9f9;">
<div class="" style="color: #595959; margin: 0px; padding: 16px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">
<pre class="cm-s-default" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">public</span> <span class="cm-type" style="color: #22863a; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">void</span> <span class="cm-def" style="color: #005cc5; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">connect</span>() {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">        <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">if</span> (<span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">!</span><span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">isConnected</span>()) {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">            <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">try</span> {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">new</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">Socket</span>();
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">setReuseAddress</span>(<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">true</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">setKeepAlive</span>(<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">true</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">setTcpNoDelay</span>(<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">true</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">setSoLinger</span>(<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">true</span>, <span class="cm-number" style="color: #005cc5; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">0</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">connect</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">new</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">InetSocketAddress</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">host</span>, <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">port</span>), <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">connectionTimeout</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">setSoTimeout</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">soTimeout</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">if</span> (<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">ssl</span>) {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">if</span> (<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">null</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">==</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">sslSocketFactory</span>) {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                        <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">sslSocketFactory</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> (<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">SSLSocketFactory</span>)<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">SSLSocketFactory</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">getDefault</span>();
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    }
</span></span>
<span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">sslSocketFactory</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">createSocket</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>, <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">host</span>, <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">port</span>, <span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">true</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">if</span> (<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">null</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">!=</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">sslParameters</span>) {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                        ((<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">SSLSocket</span>)<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>).<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">setSSLParameters</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">sslParameters</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    }
</span></span>
<span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">if</span> (<span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">null</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">!=</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">hostnameVerifier</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">&amp;&amp;</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">!</span><span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">hostnameVerifier</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">verify</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">host</span>, ((<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">SSLSocket</span>)<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>).<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">getSession</span>())) {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                        <span class="cm-type" style="color: #22863a; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">String</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">message</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> <span class="cm-type" style="color: #22863a; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">String</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">format</span>(<span class="cm-string" style="color: #669900; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">"The connection to '%s' failed ssl/tls hostname verification."</span>, <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">host</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                        <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">throw</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">new</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">JedisConnectionException</span>(<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">message</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                    }
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                }
</span></span>
<span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">outputStream</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">new</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">RedisOutputStream</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">getOutputStream</span>());
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">inputStream</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">new</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">RedisInputStream</span>(<span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">socket</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">getInputStream</span>());
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">            } <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">catch</span> (<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">IOException</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">var2</span>) {
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">broken</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">=</span> <span class="cm-atom" style="color: #990055; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">true</span>;
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">                <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">throw</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">new</span> <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">JedisConnectionException</span>(<span class="cm-string" style="color: #669900; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">"Failed connecting to host "</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">+</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">host</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">+</span> <span class="cm-string" style="color: #669900; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">":"</span> <span class="cm-operator" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">+</span> <span class="cm-keyword" style="color: #d73a49; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">this</span>.<span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">port</span>, <span class="cm-variable" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">var2</span>);
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">            }
</span></span><span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">        }
</span></span>
<span class="lake-preview-line" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);"><span class="lake-preview-codeblock-content" style="color: #595959; margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);">    }
</span></span></pre>
</div>
</div>
</div>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="3d2f7b6cc66d97ddbbc81a5a41017835">可以清楚的看到是 new Socket();打开了一个连接，而因为是连接池的原因是不能关闭的。</p>
<h2 id="TZOeu" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 24px; line-height: 32px;" data-lake-id="c0196a19e771e7bc6363ee69bb1bdfdb">找到问题</h2>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="5f728301bdad5f09aa65b66897e9163f">最终我们知道了， 确实redis client导致了不断的去new Socket(). 最开始走了弯路是因为，我问了负责的开发，我们的系统是没有用redis的。那为什么会出现redis client呢？ 原因是我们的代码的算法模块来自于以前叫gateway的应用，这个应用依赖了redis，迁移过来的时候没有删除。因为单单删除application.yml里的redis的配置，系统起不来，只好保留了。</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="8c11939d99a34a456b74e7b9464af819">仔细来看，其实是因为pom.xml一旦引入了redis-spring-boot的依赖，他就会尝试初始化一个redis的client出来，如果application.yml里少了redis的配置，那当然是起不来的。</p>
<h1 id="FnlSo" style="padding: 7px 0px; margin: 0px; font-weight: bold; font-size: 28px; line-height: 36px;" data-lake-id="9b4e1db1b26bdb833a13f65256256423">验证</h1>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="33bc8fa38ea70c98279a462e5f8f21d1">还是找这台机器，修改配置，删除redis-spring-boot的jar包重启应用进行观察. 首先old区的增长没有那么快了</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="46b1c6b901ad06c8d17be338ffecd44b"><a href="https://huster.top/wp-content/uploads/2020/06/15.png"><img class="alignnone size-full wp-image-741" src="https://huster.top/wp-content/uploads/2020/06/15.png" alt="" width="603" height="828" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="5e45d1caadc55ffe5cccf4a92ace8680">别的机器是这样的</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="3ea333188a60b4a46b510095d3738568"><a href="https://huster.top/wp-content/uploads/2020/06/16.png"><img class="alignnone size-full wp-image-742" src="https://huster.top/wp-content/uploads/2020/06/16.png" alt="" width="621" height="827" /></a></p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="128da665398d3b8044205ce0f1062747">首先old区增长没有这么快了，另外就是young区gc完了之后，释放了更多的内存，说明更多的对象在youngGC的时候就已经清理掉了.</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="c6d513754e6b3a59a5b74cfa587a93c5">还需要更长时间，更多的观察数据，发布前最近7天的数据</p>
<p style="font-size: 14px; color: #262626; line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;" data-lake-id="d4f61c2f0c99d73a2778485821e52085"><a href="https://huster.top/wp-content/uploads/2020/06/17.png"><img class="alignnone size-full wp-image-743" src="https://huster.top/wp-content/uploads/2020/06/17.png" alt="" width="746" height="222" /></a></p>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/720.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink读取kafka数据未能触发watermark</title>
		<link>https://huster.top/htmls/713.html</link>
		<comments>https://huster.top/htmls/713.html#respond</comments>
		<pubDate>Wed, 05 Feb 2020 10:33:25 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=713</guid>
		<description><![CDATA[过年被病毒闹的出不了门，就顺带着把flink秒级统计的逻辑写了一下，逻辑很简单，就是从kafka消费数据，然后 &#8230; <a href="https://huster.top/htmls/713.html" class="more-link">继续阅读<span class="screen-reader-text">“flink读取kafka数据未能触发watermark”</span></a>]]></description>
				<content:encoded><![CDATA[<p>过年被病毒闹的出不了门，就顺带着把flink秒级统计的逻辑写了一下，逻辑很简单，就是从kafka消费数据，然后select count(*) from xxx group by xxx来一秒产出一个打点。程序代码非常简单</p>
<p><span id="more-713"></span></p>
<p>&#8220;`java</p>
<pre>StreamExecutionEnvironment bsEnv = StreamExecutionEnvironment.getExecutionEnvironment();
EnvironmentSettings bsSettings = EnvironmentSettings.newInstance().useBlinkPlanner().inStreamingMode().build();
StreamTableEnvironment bsTableEnv = StreamTableEnvironment.create(bsEnv, bsSettings);
bsEnv.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);
//并发数量小于等于kafka的partition数量,否则不会触发水位线
bsEnv.setParallelism(1);
//get input from kafka
String[] fieldNamesOriginal = new String[]{"i","t","op"};
TypeInformation[] typesOriginal = new TypeInformation[]{Types.STRING(), Types.JAVA_BIG_DEC(), Types.STRING()};
Properties properties = new Properties();
properties.setProperty("bootstrap.servers", "xxxx.com:9200");
properties.setProperty("group.id", "xxxxxxx");
//主动提交offset,不利用flink的job
properties.put("enable.auto.commit", "true");
properties.put("auto.commit.interval.ms", "1000");
FlinkKafkaConsumer011&lt;Row&gt; kafkaConsumer011 = new FlinkKafkaConsumer011&lt;&gt;("xxxxxxxx",
        new JsonRowDeserializationSchema(new RowTypeInfo(typesOriginal, fieldNamesOriginal)), properties);
kafkaConsumer011.setStartFromLatest();
DataStream&lt;Row&gt; streamSource = bsEnv
        .addSource(kafkaConsumer011)
        .uid("from_kafka_topic_is");
TypeInformation[] returnTypeTmp = new TypeInformation[]{Types.STRING(), Types.SQL_TIME(), Types.STRING()};
DataStream&lt;Row&gt; dataStreamWithTime = streamSource.map(new MapFunction&lt;Row, Row&gt;() {
    @Override
    public Row map(Row value) throws Exception {
        //SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        Row row = new Row(3);
        BigDecimal time = (BigDecimal)value.getField(1);
        row.setField(0, value.getField(0));
        row.setField(1, new Time(time.longValue()));
        row.setField(2, value.getField(2));
        return row;
    }
})
        .returns(new RowTypeInfo(returnTypeTmp, fieldNamesOriginal))
        .uid("add_time")
        .assignTimestampsAndWatermarks(new BoundedOutOfOrdernessTimestampExtractor&lt;Row&gt;(org.apache.flink.streaming.api.windowing.time.Time.seconds(2)) {
            @Override
            public long extractTimestamp(Row element) {
                return ((Time)element.getField(1)).getTime();
            }
        });
bsTableEnv.registerDataStream("_source_table", dataStreamWithTime, "i,t,op, rowtime.rowtime");
bsTableEnv.connect(new Kafka()
        .version("0.11")
        .topic("s-log")
        .property("bootstrap.servers", "abc.com:9200")
        .startFromEarliest())
        .withFormat(new Json().jsonSchema("{\"type\":\"object\",\"properties\":{\"index_name\":{\"type\":\"string\"},\"event_time_log\":{\"type\":\"string\"},\"op_type\":{\"type\":\"string\"},\"count_result\":{\"type\":\"number\"}}}"))
        .withSchema(new Schema()
                .field("index_name", Types.STRING())
                .field("event_time_log", Types.STRING())
                .field("op_type", Types.STRING())
                .field("count_result", Types.LONG()))
        .inAppendMode()
        .registerTableSink("operator_log_result");
bsTableEnv.sqlUpdate("insert into operator_log_result " +
        "select  i as index_name,  DATE_FORMAT(TUMBLE_END(rowtime, INTERVAL '1' SECOND), 'yyyy-MM-dd HH:mm:ss') as event_time_log, op as op_type, count(op) as count_result " +
        "from _source_table group by TUMBLE(rowtime, INTERVAL '1' SECOND) , i, op");
bsEnv.execute("data-metrics");




</pre>
<p>代码如上，非常简单，输入的数据类似于</p>
<p>&#8220;`json</p>
<p class="p1"><span class="s1">{&#8220;t&#8221;:1580896327330,&#8221;st&#8221;:&#8221;DIRECT&#8221;,&#8221;i&#8221;:&#8221;hitch_passenger_order_2020_01_22_23_50_40&#8243;,&#8221;op&#8221;:&#8221;es_sink&#8221;,&#8221;id&#8221;:&#8221;,guid:15756341902141200002900&#8243;,&#8221;ut&#8221;:&#8221;,order_update_time:2020-02-05 17:52:07.190435&#8243;,&#8221;msg&#8221;:&#8221;&#8221;,&#8221;rId&#8221;:&#8221;0.1.1.1&#8243;}</span></p>
<p class="p1"><span class="s1">{&#8220;t&#8221;:1580896327831,&#8221;st&#8221;:&#8221;DIRECT&#8221;,&#8221;i&#8221;:&#8221;hitch_passenger_order_2020_01_22_23_50_40&#8243;,&#8221;op&#8221;:&#8221;es_sink&#8221;,&#8221;id&#8221;:&#8221;,guid:15756341902141200002900&#8243;,&#8221;ut&#8221;:&#8221;,order_update_time:2020-02-05 17:52:07.687468&#8243;,&#8221;msg&#8221;:&#8221;&#8221;,&#8221;rId&#8221;:&#8221;0.1.1.1&#8243;}</span></p>
<p class="p1"><span class="s1">{&#8220;t&#8221;:1580896328131,&#8221;st&#8221;:&#8221;DIRECT&#8221;,&#8221;i&#8221;:&#8221;hitch_passenger_order_2020_01_22_23_50_40&#8243;,&#8221;op&#8221;:&#8221;es_sink&#8221;,&#8221;id&#8221;:&#8221;,guid:15756341902141200002900&#8243;,&#8221;ut&#8221;:&#8221;,order_update_time:2020-02-05 17:52:08.047474&#8243;,&#8221;msg&#8221;:&#8221;&#8221;,&#8221;rId&#8221;:&#8221;0.1.1.1&#8243;}</span></p>
<p>&nbsp;</p>
<p>然而，死活就是无法输出正确的统计数据。但是当我把setParallelism并发设置为1的时候，就能正常输出统计数据。太神奇了，为什么跟并发度有关系呢？</p>
<p>于是我在本地打开了跟踪调试功能，我发现问题出在StatusWatermarkValve这个类里，这个类的这个方法是这么写的</p>
<p>&#8220;`java</p>
<pre>private void findAndOutputNewMinWatermarkAcrossAlignedChannels() {
   long newMinWatermark = Long.MAX_VALUE;
   boolean hasAlignedChannels = false;

   // determine new overall watermark by considering only watermark-aligned channels across all channels
   for (InputChannelStatus channelStatus : channelStatuses) {
      if (channelStatus.isWatermarkAligned) {
         hasAlignedChannels = true;
         newMinWatermark = Math.min(channelStatus.watermark, newMinWatermark);
      }
   }

   // we acknowledge and output the new overall watermark if it really is aggregated
   // from some remaining aligned channel, and is also larger than the last output watermark
   if (hasAlignedChannels &amp;&amp; newMinWatermark &gt; lastOutputWatermark) {
      lastOutputWatermark = newMinWatermark;
      outputHandler.handleWatermark(new Watermark(lastOutputWatermark));
   }
}</pre>
<p>这个方法跟踪调试，正常的时候是这样的也是比较符合我们预期的，到点了就该触发了。</p>
<p><a href="https://huster.top/wp-content/uploads/2020/02/b1.png"><img class="alignnone size-full wp-image-714" src="https://huster.top/wp-content/uploads/2020/02/b1.png" alt="" width="2432" height="474" /></a></p>
<p>而不正常的时候，多个并发的时候，是这样的</p>
<p><a href="https://huster.top/wp-content/uploads/2020/02/b2.png"><img class="alignnone size-full wp-image-715" src="https://huster.top/wp-content/uploads/2020/02/b2.png" alt="" width="2384" height="982" /></a></p>
<p>可以看到其他的subtask取到的watermark是一个负值，也就是初始值。</p>
<p>&nbsp;</p>
<p>这个时候flink怎么处理的呢？根据刚刚的代码，他会取并发里面最小的一个值作为watermark，也就是那个最小的long型值。</p>
<p>然后一比较，跟默认值等的，不满足触发的条件，也就未能触发事件了。</p>
<p>看到一篇文章是这么写的</p>
<p><a href="https://huster.top/wp-content/uploads/2020/02/a3.jpg"><img class="alignnone size-full wp-image-716" src="https://huster.top/wp-content/uploads/2020/02/a3.jpg" alt="" width="1518" height="1400" /></a></p>
<p>&nbsp;</p>
<p>文章引用： https://www.jianshu.com/p/753e8cf803bb</p>
<p>&nbsp;</p>
<p>我感觉是flink的代码不合理导致的，至此，困扰我多日的一个问题终于有了答案。</p>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/713.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink使用时间戳作为起始offset消费kafka的问题</title>
		<link>https://huster.top/htmls/708.html</link>
		<comments>https://huster.top/htmls/708.html#respond</comments>
		<pubDate>Mon, 21 Oct 2019 15:59:05 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=708</guid>
		<description><![CDATA[代码如下 private static voidtest2()throwsException {     En &#8230; <a href="https://huster.top/htmls/708.html" class="more-link">继续阅读<span class="screen-reader-text">“flink使用时间戳作为起始offset消费kafka的问题”</span></a>]]></description>
				<content:encoded><![CDATA[<div>代码如下</div>
<div></div>
<div></div>
<div>private static voidtest2()throwsException {</div>
<div>    EnvironmentSettings fsSettings = EnvironmentSettings.newInstance().useOldPlanner().inStreamingMode().build();</div>
<div>   StreamExecutionEnvironment fsEnv = StreamExecutionEnvironment.getExecutionEnvironment();</div>
<div>   StreamTableEnvironment tttt = StreamTableEnvironment.create(fsEnv,fsSettings);</div>
<div>   Properties properties =newProperties();</div>
<div>   properties.setProperty(&#8220;bootstrap.servers&#8221;,&#8221;localhost:9092&#8243;);</div>
<div>    properties.setProperty(&#8220;<a href="http://group.id/">group.id</a>&#8220;,&#8221;test&#8221;+ System.currentTimeMillis());</div>
<div>   FlinkKafkaConsumer011&lt;String&gt; kafkaConsumer011 =newFlinkKafkaConsumer011&lt;String&gt;(&#8220;test&#8221;, newSimpleStringSchema(),properties);</div>
<div>   kafkaConsumer011.setStartFromTimestamp(System.currentTimeMillis());</div>
<div>   DataStream&lt;String&gt; stream = fsEnv.addSource(kafkaConsumer011);</div>
<div>   stream.print();</div>
<div>   fsEnv.execute(&#8220;test&#8221;);</div>
<div>}2019-10-21 23:06:58.970 [Thread-8] INFO  o.a.f.s.connectors.kafka.FlinkKafkaConsumerBase &#8211; Consumer subtask 0 creating fetcher with offsets {}.</div>
<div></div>
<div>表现为，无法收到kafka发送过来的消息。这就很奇怪了，因为我使用kafka-consumer-console.sh的方式可以看到实际上是有消息产出的，但是这里死活就收不到数据。</div>
<div></div>
<p><span id="more-708"></span></p>
<div></div>
<div>进一步的测试，我把timestamp改成提前了很长的时间，就能正常工作。</div>
<div></div>
<div>进一步测试，如果刚好设置的timestamp那个点有消息产生，那么也能正常工作。</div>
<div></div>
<div></div>
<div>对比了下，能拿到数据和不能拿到数据的区别。下面是不能拿到数据时候的日志输出，</div>
<div></div>
<div></div>
<div>2019-10-21 23:06:58.970 [Thread-10] INFO  o.a.f.s.connectors.kafka.FlinkKafkaConsumerBase &#8211; Consumer subtask 3 creating fetcher with offsets {}.</div>
<div>2019-10-21 23:06:58.970 [Thread-7] INFO  o.a.f.s.connectors.kafka.FlinkKafkaConsumerBase &#8211; Consumer subtask 1 creating fetcher with offsets {}.</div>
<div>2019-10-21 23:07:01.100 [Source: Custom Source -&gt; Sink: Print to Std. Out (3/4)] INFO  o.a.f.s.connectors.kafka.FlinkKafkaConsumerBase &#8211; Consumer subtask 2 initially has no partitions to read from.</div>
<div>2019-10-21 23:07:01.108 [Thread-9] INFO  o.a.f.s.connectors.kafka.FlinkKafkaConsumerBase &#8211; Consumer subtask 2 creating fetcher with offsets {}.</div>
<div></div>
<div></div>
<div>而下面是能拿到数据时候的日志输出, 可以看到有一个task成功拿到了这个partition的offset</div>
<div></div>
<div></div>
<div>2019-10-21 23:14:11.871 [Thread-7] INFO  o.a.f.s.connectors.kafka.FlinkKafkaConsumerBase &#8211; Consumer subtask 2 creating fetcher with offsets {KafkaTopicPartition{topic=&#8217;test&#8217;, partition=0}=35}.</div>
<div></div>
<div></div>
<div>所以原因是因为，通过kafka的consumer的api，consumer.offsetsForTimes的时候，能否拿到offset，如果拿不到在KafkaConsumerThread的线程的run方法里，有一个这个代码表明这个方法是阻塞的，一直等到有新的partition到来，才会继续。而新的partition不会到来，所以这里就有问题了。。。</div>
<div></div>
<div>try {</div>
<div>   if (hasAssignedPartitions) {</div>
<div>      newPartitions = unassignedPartitionsQueue.pollBatch();</div>
<div>   }</div>
<div>   else {</div>
<div>      // if no assigned partitions block until we get at least one</div>
<div>      // instead of hot spinning this loop. We rely on a fact that</div>
<div>      // unassignedPartitionsQueue will be closed on a shutdown, so</div>
<div>      // we don&#8217;t block indefinitely</div>
<div>      newPartitions = unassignedPartitionsQueue.getBatchBlocking();</div>
<div>   }</div>
<div>   if (newPartitions != null) {</div>
<div>      reassignPartitions(newPartitions);</div>
<div>   }</div>
<div>} catch (AbortedReassignmentException e) {</div>
<div>   continue;</div>
<div>}</div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
<div>那么kafka的这个offsetsForTimes的接口为何不能返回结果呢 ？</div>
<div></div>
<div>private static void testConsumer() {</div>
<div>    Properties props = new Properties();</div>
<div>    props.put(&#8220;bootstrap.servers&#8221;, &#8220;localhost:9092&#8221;);</div>
<div>    props.put(&#8220;group.id&#8221;, &#8220;test&#8221;);</div>
<div>    props.put(&#8220;key.deserializer&#8221;, &#8220;org.apache.kafka.common.serialization.StringDeserializer&#8221;);</div>
<div>    props.put(&#8220;value.deserializer&#8221;, &#8220;org.apache.kafka.common.serialization.StringDeserializer&#8221;);</div>
<div>    KafkaConsumer&lt;String, String&gt; consumer = new KafkaConsumer&lt;&gt;(props);</div>
<div>    consumer.subscribe(Collections.singletonList(&#8220;test&#8221;));</div>
<div>    TopicPartition topicPartition = new TopicPartition(&#8220;test&#8221;, 0);</div>
<div>    long current = System.currentTimeMillis();</div>
<div>    for (int i=0; i&lt;10000; i++) {</div>
<div>        Map&lt;TopicPartition, Long&gt; map = new HashMap&lt;&gt;();</div>
<div>        map.put(topicPartition, current &#8211; i*1000);</div>
<div>        Map&lt;TopicPartition, OffsetAndTimestamp&gt; result  = consumer.offsetsForTimes(map);</div>
<div>        System.out.println(&#8220;===================test : &#8221; + i + &#8220;==================&#8221;);</div>
<div>        System.out.println(new Gson().toJson(result));</div>
<div>    }</div>
<div>    while (true) {</div>
<div>        ConsumerRecords&lt;String, String&gt; records = consumer.poll(100);</div>
<div>        for (ConsumerRecord&lt;String, String&gt; record : records)</div>
<div>            System.out.printf(&#8220;offset = %d, key = %s, value = %s%n&#8221;, record.offset(), record.key(), record.value());</div>
<div>    }</div>
<div>}</div>
<div></div>
<div></div>
<div>通过如上代码我们发现，如果这个timestamp之后有数据产出，那么就能正确的拿到offset，否则就拿不到。</div>
<div></div>
<div>也就是我们最后一条数据如果是18：00产生的，那么如果你的时间戳早于18:00是能正确的拿到offset的，如果比18:00晚，那么就拿不到了。</div>
<div></div>
<div></div>
<div>总结，问题在于flink和kafka的配合。kafka的特征是，时间戳之后如果没有消息，那么就不返回offset(我认为合理的应该是返回last offset + 1) , 那么flink发现没有返回offset是怎么处理的呢？那就不消费数据了，因为他觉得返回的数据并不符合自己的预期，他也不知道从哪里开始取了。如果从offset+1开始取，可能会出错，干脆就不取了。</div>
<div></div>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/708.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink通过jdbc读取postgresql数据库里的数据</title>
		<link>https://huster.top/htmls/706.html</link>
		<comments>https://huster.top/htmls/706.html#respond</comments>
		<pubDate>Thu, 17 Oct 2019 08:49:32 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=706</guid>
		<description><![CDATA[问题1： 从postgresql里使用flink-jdbc读取数据的问题, 数据类型不匹配，不支持jsonb等 &#8230; <a href="https://huster.top/htmls/706.html" class="more-link">继续阅读<span class="screen-reader-text">“flink通过jdbc读取postgresql数据库里的数据”</span></a>]]></description>
				<content:encoded><![CDATA[<div></div>
<div></div>
<div></div>
<div>问题1： 从postgresql里使用flink-jdbc读取数据的问题, 数据类型不匹配，不支持jsonb等其他类型.</div>
<div></div>
<div></div>
<p><span id="more-706"></span></p>
<div></div>
<div>        使用create table 语句来读取，由于postgresql里设置的是jsonb的类型, 他又不让你输入sql语句(语句里需要写CAST函数),所以就抛错了</div>
<div>Caused by: java.lang.ClassCastException: org.postgresql.util.PGobject cannot be cast to java.lang.String</div>
<div>Caused by: java.lang.ClassCastException: org.postgresql.util.PGobject cannot be cast to java.lang.String</div>
<div>    at <a href="http://org.apache.flink.api.common.typeutils.base.stringserializer.copy(stringserializer.java:33/">org.apache.flink.api.common.typeutils.base.StringSerializer.copy(StringSerializer.java:33</a>)</div>
<div>    at org.apache.flink.api.java.typeutils.runtime.RowSerializer.copy(RowSerializer.java:93)</div>
<div>    at org.apache.flink.api.java.typeutils.runtime.RowSerializer.copy(RowSerializer.java:44)</div>
<div>    at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.pushToOperator(OperatorChain.java:635)</div>
<div>    &#8230; 9 more</div>
<div></div>
<div></div>
<div>问题2: partition必须是数字类型的字段</div>
<div></div>
<div></div>
<div> 另外，因为connector.read.partition.column他使用的是between语句，所以只能是数字，时间戳等，否则也会报错</div>
<div>. partition.column must be a numeric,</div>
<div> &#8212; date, or timestamp column from the table in question.</div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
<div>Exception in thread &#8220;main&#8221; org.apache.flink.runtime.client.JobExecutionException: Job execution failed.</div>
<div>    at org.apache.flink.runtime.jobmaster.JobResult.toJobExecutionResult(JobResult.java:146)</div>
<div>    at org.apache.flink.runtime.minicluster.MiniCluster.executeJobBlocking(MiniCluster.java:627)</div>
<div>    at org.apache.flink.streaming.api.environment.LocalStreamEnvironment.execute(LocalStreamEnvironment.java:117)</div>
<div>    at org.apache.flink.streaming.api.environment.StreamExecutionEnvironment.execute(StreamExecutionEnvironment.java:1507)</div>
<div>    at com.hellobike.search.flink.task.FullIndexBuilderTask.main(FullIndexBuilderTask.java:92)</div>
<div>Caused by: java.lang.Exception: java.lang.IllegalArgumentException: open() failed.ERROR: operator does not exist: character varying &gt;= bigint</div>
<div>  建议：No operator matches the given name and argument type(s). You might need to add explicit type casts.</div>
<div>  位置：514</div>
<div>    at org.apache.flink.streaming.runtime.tasks.SourceStreamTask$LegacySourceFunctionThread.checkThrowSourceExecutionException(SourceStreamTask.java:212)</div>
<div>    at org.apache.flink.streaming.runtime.tasks.SourceStreamTask.performDefaultAction(SourceStreamTask.java:132)</div>
<div>    at org.apache.flink.streaming.runtime.tasks.StreamTask.run(StreamTask.java:298)</div>
<div>    at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:403)</div>
<div>    at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:705)</div>
<div>    at org.apache.flink.runtime.taskmanager.Task.run(Task.java:530)</div>
<div>    at java.lang.Thread.run(Thread.java:748)</div>
<div>Caused by: java.lang.IllegalArgumentException: open() failed.ERROR: operator does not exist: character varying &gt;= bigint</div>
<div>  建议：No operator matches the given name and argument type(s). You might need to add explicit type casts.</div>
<div>  位置：514</div>
<div>    at org.apache.flink.api.java.io.jdbc.JDBCInputFormat.open(JDBCInputFormat.java:250)</div>
<div>    at org.apache.flink.streaming.api.functions.source.InputFormatSourceFunction.run(InputFormatSourceFunction.java:85)</div>
<div>    at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:100)</div>
<div>    at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:63)</div>
<div>    at org.apache.flink.streaming.runtime.tasks.SourceStreamTask$LegacySourceFunctionThread.run(SourceStreamTask.java:202)</div>
<div>Caused by: org.postgresql.util.PSQLException: ERROR: operator does not exist: character varying &gt;= bigint</div>
<div>  建议：No operator matches the given name and argument type(s). You might need to add explicit type casts.</div>
<div>  位置：514</div>
<div>    at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2103)</div>
<div>    at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:1836)</div>
<div>    at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:257)</div>
<div>    at org.postgresql.jdbc2.AbstractJdbc2Statement.execute(AbstractJdbc2Statement.java:512)</div>
<div>    at org.postgresql.jdbc2.AbstractJdbc2Statement.executeWithFlags(AbstractJdbc2Statement.java:388)</div>
<div>    at org.postgresql.jdbc2.AbstractJdbc2Statement.executeQuery(AbstractJdbc2Statement.java:273)</div>
<div>    at org.apache.flink.api.java.io.jdbc.JDBCInputFormat.open(JDBCInputFormat.java:247)</div>
<div>    &#8230; 4 more</div>
<div>
<div></div>
</div>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/706.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink相关 &#8211; 通过Table API写入ElasticSearch的部分源码分析</title>
		<link>https://huster.top/htmls/704.html</link>
		<comments>https://huster.top/htmls/704.html#respond</comments>
		<pubDate>Thu, 17 Oct 2019 08:49:06 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=704</guid>
		<description><![CDATA[New ElasticSearch()…xxx&#8230;registerTableSink(); Elas &#8230; <a href="https://huster.top/htmls/704.html" class="more-link">继续阅读<span class="screen-reader-text">“flink相关 &#8211; 通过Table API写入ElasticSearch的部分源码分析”</span></a>]]></description>
				<content:encoded><![CDATA[<div>New ElasticSearch()…xxx&#8230;registerTableSink();</div>
<div></div>
<div>ElasticSearch是一个ConnectorDescriptor: 最关键的就是一个toConnectorProperties就是一个配置的map,传给factory使用，他其实是一个配置收集器.</div>
<div></div>
<div></div>
<p><span id="more-704"></span></p>
<div></div>
<div>TableFactoryUtils :  生成一个TableFactory的工具类，</div>
<div>findAndCreateTableSink( ) 通过一个描述来生成一个工厂类.//描述里有必要的配置.</div>
<div></div>
<div>先找到合适的工厂类，然后创建一个TableSink.</div>
<div></div>
<div>第一步，A先找到合适的工厂类，通过properties里的配置来寻找,</div>
<div>TableFactoryService.find(TableSinkFactory.class, properties)</div>
<div>findSingleInternal()里的两个代码是关键代码</div>
<div></div>
<div>A.1 : List&lt;TableFactory&gt; tableFactories = discoverFactories(classLoader);    通过classLoader(可以传入, 否则使用默认)找到所有的Factory.</div>
<div>A.2:  然后开始过滤， List&lt;T&gt; filtered = filter(tableFactories, factoryClass, properties)</div>
<div>        A.2.1 : 首先检查类型, TableSinkFactory.class   filterByFactoryClass(factoryClass,properties,foundFactories)</div>
<div>        A.2.2 : 然后检查必须的配置是不是设置了, List&lt;T&gt; contextFactories = filterByContext(factoryClass,properties,foundFactories,classFactories);</div>
<div>                    其中必备的配置是在factory里配置和定义的，必须不能为空.这个是有TableFactory的requiredContext()方法定义的.</div>
<div>       A.2.3 : 经过以上两轮的过滤，然后再继续检查，依然是TableFactoryService.java，这里面的</div>
<div>   private static &lt;T extends TableFactory&gt; List&lt;T&gt; filterBySupportedProperties(</div>
<div>            Class&lt;T&gt; factoryClass,</div>
<div>            Map&lt;String, String&gt; properties,</div>
<div>            List&lt;TableFactory&gt; foundFactories,</div>
<div>            List&lt;T&gt; classFactories) 方法</div>
<div></div>
<div>            这里主要是TableFactory里的两个方法定义的属性</div>
<div>                    Map&lt;String, String&gt; requiredContext();</div>
<div>                    List&lt;String&gt; supportedProperties();</div>
<div>            然后和用户Descriptor（如 ElasticSearch）里设置的属性匹配，其中有字符忽略大小写，星号匹配等细节，不再研究.</div>
<div></div>
<div>然后这就找到了工厂类，接下来要生成TableSink了。例如 ElasticSearch找到的就是Elasticsearch6UpsertTableSinkFactory.</div>
<div></div>
<div>第二步，生成TableSink.在ElasticSearch中，他是直接的new了一个Elasticsearch6UpsertTableSink.而这个对象又是一个StreamTableSink，这样就生成了一个StreamTableSink, 这个sink可以交给flink直接使用了。在ElasticSearch这个TableSink里，最关键的是实现了consumeDataStream，这个决定了sink的写逻辑.注意区分的是一个是StreamTableSink是给Table接口使用的，另一个是DataStreamSink是给DataStream使用的。这里是连接Table和Stream接口的地方。所以说，Table的API其实还是基于Stream的API的。</div>
<div></div>
<div></div>
<div>生成了Elasticsearch的TableSink之后，可以看到到这个类的用途是为了向es写入数据，他的作用是生成一个createSinkFunction。</div>
<div>createSinkFunction是具体的连接es，向es写入数据的逻辑，具体的实现是ElasticsearchUpsertSinkFunction的process的方法。是由ElasticsearchSinkBase发起的调用。</div>
<div></div>
<div></div>
<div></div>
<div>在写入ElasticSearch的时候，如何让_id使用数据里的指定的field的值？</div>
<div>在ES2.0之后，mapping里设置_id就被移除了这个特性。目的是为了让业务方不需要关心es的实现细节。在es connector里，他会根据你的table的primary key来生成这个_id的值。一般情况下，在append模式下，因为只是insert，所以他都是随机的。只有在update的时候，才需要根据primary key查找到元素并且进行更新。具体的实现在processUpsert方法。</div>
<div></div>
<div>        private void processUpsert(Row row, RequestIndexer indexer) {</div>
<div>            final byte[] document = serializationSchema.serialize(row);</div>
<div>            if (keyFieldIndices.length == 0) {</div>
<div>                final IndexRequest indexRequest = requestFactory.createIndexRequest(</div>
<div>                    index,</div>
<div>                    docType,</div>
<div>                    contentType,</div>
<div>                    document);</div>
<div>                indexer.add(indexRequest);</div>
<div>            } else {</div>
<div>                final String key = createKey(row);</div>
<div>                final UpdateRequest updateRequest = requestFactory.createUpdateRequest(</div>
<div>                    index,</div>
<div>                    docType,</div>
<div>                    key,</div>
<div>                    contentType,</div>
<div>                    document);</div>
<div>                indexer.add(updateRequest);</div>
<div>            }</div>
<div>        }</div>
<div></div>
<div>这个方法的关键是keyFieldIndices这个属性。如果这个属性没值，那么久不指定key，让他自动生成_id，否则就从元数据里拿到这个字段值，再拼接成_id.而这个值是由方法</div>
<div>public void setKeyFields(String[] keyNames) {} 来设置的。这个就是tablesink接口里定义的方法。这个方法可不是给业务方调用的，这个是flink框架调用的。所以你显示的调用这个方法也没用，他flink最终会覆盖掉你的配置。</div>
<div>/**</div>
<div>* Configures the unique key fields of the {@linkTable} to write.</div>
<div>* The method is called after {@linkTableSink#configure(String[], TypeInformation[])}.</div>
<div>*</div>
<div>*&lt;p&gt;The keys array might be empty, if the table consists of a single (updated) record.</div>
<div>* If the table does not have a key and is append-only, the keys attribute is null.</div>
<div>*</div>
<div>*@paramkeysthe field names of the table&#8217;s keys, an empty array if the table has a single</div>
<div>*             row, and null if the table is append-only and has no key.</div>
<div>*/</div>
<div>voidsetKeyFields(String[] keys);</div>
<div></div>
<div>说明在这里。说的很清楚了，如果是append-only的模式，传入的keys就为空，否则就用table 的 primary key. 所以你可以定义一个table，指定主键。</div>
<div></div>
<div>找了一圈发现并没有定义table 的 primary的语法，翻看flink的源码发现他是自动判断的，具体的是根据你的sql语句来判断的。</div>
<div></div>
<div>UpdatingPlanChecker.scala是一个scala的不太好看明白，具体的在.private class UniqueKeyExtractor {} 这个类里面。他的寻找方式是，如果你是group by 语句，那么group by 就是你的key.如果你是join，那就看你左边的表和你右边的表来分别递归计算。</div>
<div></div>
<div>// Output of join must have keys if left and right both contain key(s).</div>
<div>// Key groups from both side will be merged by join equi-predicates</div>
<div>val lInNames: Seq[String] = j.getLeft.getRowType.getFieldNames</div>
<div>val rInNames: Seq[String] = j.getRight.getRowType.getFieldNames</div>
<div>val joinNames = j.getRowType.getFieldNames</div>
<div>// if right field names equal to left field names, calcite will rename right</div>
<div>// field names. For example, T1(pk, a) join T2(pk, b), calcite will rename T2(pk, b)</div>
<div></div>
<div></div>
<div>总之就是，只有在聚合计算的时候才会有key, 也就是group by 后面的内容。那这不就扯了吗？ ElasticSearch connector 不就只支持插入操作了吗？</div>
<div></div>
<div></div>
<div>Ps： flink后续会支持在table schema里定义primary key, 已经提交了pr，<a href="https://github.com/apache/flink/pull/8736">https://github.com/apache/flink/pull/8736</a> 可惜现在还没有。pat ~</div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/704.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink的动态表格</title>
		<link>https://huster.top/htmls/700.html</link>
		<comments>https://huster.top/htmls/700.html#respond</comments>
		<pubDate>Thu, 17 Oct 2019 08:48:28 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=700</guid>
		<description><![CDATA[目的： 订阅kafka的消息(kafka的消息是从postgresql来的)，将kafka的消息作为Table &#8230; <a href="https://huster.top/htmls/700.html" class="more-link">继续阅读<span class="screen-reader-text">“flink的动态表格”</span></a>]]></description>
				<content:encoded><![CDATA[<div>目的： 订阅kafka的消息(kafka的消息是从postgresql来的)，将kafka的消息作为TableSource，执行sql，将结果输出到ElasticSearch中</div>
<div></div>
<div>动态表格</div>
<div></div>
<div>    flink的概念里，stream的输入是一个insert的模式。类似于点击日志这种，是源源不断的产出的新数据。而postgresql到kafka的消息包含了insert,update和delete的操作。</div>
<div>在点击日志的概率里，如果统计点击次数，比较好理解。一种是表格不断的更新(update mode)。如果unique key第一次出现，则插入，否则做累加，类似下面这种</div>
<div><a href="https://huster.top/wp-content/uploads/2019/10/5.png"><img class="alignnone size-full wp-image-701" src="https://huster.top/wp-content/uploads/2019/10/5.png" alt="" width="850" height="370" /></a></div>
<div></div>
<div>还有一种则是基于窗口的统计，每一个窗口期插入一系列的数据，所以这个是insert模式</div>
<div><a href="https://huster.top/wp-content/uploads/2019/10/6.png"><img class="alignnone size-full wp-image-702" src="https://huster.top/wp-content/uploads/2019/10/6.png" alt="" width="872" height="350" /></a></div>
<div></div>
<div></div>
<div></div>
<div>但是在我们的场景里面，kafka里的消息不仅仅是插入的数据，还有可能是更新的数据。也就是有个维表，里面的数据在不断的更新。</div>
<div></div>
<div>那么现在就是要搞清楚一件事。如果我定义了一个Table，接受Stream data数据不断流入。如果我这个table里不存在这表数据(定义primary key)，那么他就会执行插入。否则他会执行update操作。我们写代码来试验一下这个想法， 看看是不是这样。如果没有group by 语句，你连primary key 都定义不了，也就没办法实现更新了…..所以要区分情况，如果你是上面的例子，通过group by 计算count, 因为有primary key，所以可以形成动态表格，可以自动update.如果你仅仅是接受kafka的消息，scan模式的话，由于表格没有primary key，所以是不支持update,而只支持insert的。</div>
<div></div>
<div></div>
<div>所以针对update 和 delete 还需要单独处理….</div>
<div></div>
<div></div>
<div></div>
<div>在Table convert to DataStream一章里，使用了Tuple2&lt;Boolean, Row&gt;这个数据结构来区分Reactor Mode. 其中那个Boolean//   True is INSERT, false is DELETE.</div>
<div></div>
<div></div>
<div></div>
<div></div>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/700.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink相关 &#8211; 读入kafka数据源</title>
		<link>https://huster.top/htmls/696.html</link>
		<comments>https://huster.top/htmls/696.html#respond</comments>
		<pubDate>Thu, 17 Oct 2019 08:47:14 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=696</guid>
		<description><![CDATA[业务代码如下 : fsTableEnv.connect(        newKafka()          &#8230; <a href="https://huster.top/htmls/696.html" class="more-link">继续阅读<span class="screen-reader-text">“flink相关 &#8211; 读入kafka数据源”</span></a>]]></description>
				<content:encoded><![CDATA[<div>业务代码如下 :</div>
<div>fsTableEnv.connect(</div>
<div>       newKafka()</div>
<div>                .version(&#8220;0.11&#8221;)</div>
<div>                .topic(&#8220;xxxx&#8221;)</div>
<div>                .property(&#8220;bootstrap.servers”,”<a href="http://newdev-kafka1.ttbike.com.cn:9092/">x</a>xxxx:xxxx&#8221;)</div>
<div>                .property(&#8220;<a href="http://group.id/">group.id</a>&#8220;,&#8221;test4444&#8221;)</div>
<div>                .startFromEarliest()//测试需要</div>
<div>)</div>
<div>        .withSchema(newSchema().schema(newTableSchema(fields, types)))</div>
<div>        .withFormat(newJson().schema(newRowTypeInfo(types, fields)))</div>
<div>        .inAppendMode()</div>
<div>        .registerTableSource(“testTable”);</div>
<div></div>
<div></div>
<div>问题是：读出来的数据总是null</div>
<div>DataStream&lt;Row&gt; table = fsTableEnv.toAppendStream(fsTableEnv.sqlQuery(&#8220;select * from testTable&#8221;),Row.class);</div>
<div>table.print();</div>
<div></div>
<div></div>
<p><span id="more-696"></span></p>
<div></div>
<div></div>
<div><a href="https://huster.top/wp-content/uploads/2019/10/3.png"><img class="alignnone size-full wp-image-697" src="https://huster.top/wp-content/uploads/2019/10/3.png" alt="" width="1810" height="219" /></a></div>
<div></div>
<div></div>
<div>Kafka.java 这个类依然是一个配置收集器，就是为了收集一堆配置，然后给后面的工厂方法使用。依然通过FactoryService找到了Kafka011TableSourceSinkFactory这个工厂类。</div>
<div></div>
<div>Kafka011TableSourceSinkFactory : 作用是为了生成Kafka011TableSource这个TableSource。</div>
<div></div>
<div>Kafka011TableSource: 这个类的主要功效还是一个TableSource除了定义了TableSchema和ReturnType，最主要的是完成了他的核心功能，getDataStream()方法</div>
<div></div>
<div>FlinkKafkaConsumerBase : 由上一步的getDataStream方法，其实是为了生成这个类。这个类是一个SourceFunction，其中弹出信息的方法是run方法，我们继续看他的run方法</div>
<div></div>
<div></div>
<div>最后跟踪定位到convert那个地方，才发现，原来解析的时候，他使用的是完整的json schema，而不是仅仅是data里的field字段，例如你传给kafka的json schema是包含了data平级的那些字段,table,operation等。而我传过去的是data里的field字段，当然就错了。</div>
<div></div>
<div>{</div>
<div>    &#8220;schema&#8221;: “44444&#8243;,</div>
<div>    &#8220;table&#8221;: &#8220;safs&#8221;,</div>
<div>    &#8220;operation&#8221;: &#8220;INSERT&#8221;,</div>
<div>    &#8220;data&#8221;: {</div>
<div>        &#8220;start_time&#8221;: &#8220;2019-10-10 23:00:00&#8221;,</div>
<div>        &#8220;end_point&#8221;: &#8220;0101000020E61000008BDEA9807B545E4062D9CC21A9313F40&#8221;,</div>
<div>        &#8220;start_point&#8221;: &#8220;0101000020E61000002250FD8348575E40C284D1AC6C1F3F40&#8221;,</div>
<div>        &#8220;user_new_id&#8221;: 1200001917,</div>
<div>        &#8220;end_adcode&#8221;: null,</div>
<div>        &#8220;end_time&#8221;: null,</div>
<div>        &#8220;distance&#8221;: null,</div>
<div>        &#8220;seat_count&#8221;: 4</div>
<div>    },</div>
<div>    &#8220;operateTime&#8221;: 1570602631926</div>
<div>}</div>
<div></div>
<div></div>
<div>跟踪调试，发现具体的是在Kafka09Fetcher的runFetchLoop方法里有一段，final T value = deserializer.deserialize(record);解析出来就出错了，就空了。继续跟踪调试，发现是在 JsonRowDeserializationSchema类的</div>
<div>@Override</div>
<div>public Row deserialize(byte[] message) throws IOException {</div>
<div>   try {</div>
<div>      final JsonNode root = objectMapper.readTree(message);</div>
<div>      return (Row) runtimeConverter.convert(objectMapper, root);</div>
<div>   } catch (Throwable t) {</div>
<div>      throw new IOException(&#8220;Failed to deserialize JSON object.&#8221;, t);</div>
<div>   }</div>
<div>}</div>
<div>这段代码里，root解析出来是好的，然后他开始convert.</div>
<div></div>
<div>private DeserializationRuntimeConverter assembleRowConverter(</div>
<div>   String[] fieldNames,</div>
<div>   List&lt;DeserializationRuntimeConverter&gt; fieldConverters) {</div>
<div>   return (mapper, jsonNode) -&gt; {</div>
<div>      ObjectNode node = (ObjectNode) jsonNode;</div>
<div>      int arity = fieldNames.length;</div>
<div>      Row row = new Row(arity);</div>
<div>      for (int i = 0; i &lt; arity; i++) {</div>
<div>         String fieldName = fieldNames[i];</div>
<div>         JsonNode field = node.get(fieldName);</div>
<div>         Object convertField = convertField(mapper, fieldConverters.get(i), fieldName, field);</div>
<div>         row.setField(i, convertField);</div>
<div>      }</div>
<div>      return row;</div>
<div>   };</div>
<div>}</div>
<div></div>
<div>其中有这么一段JsonNode field = node.get(fieldName);他拿着你的fieldName去json数据里get,因为少了一个data层，所以就出错了。</div>
<div></div>
<div></div>
<div>这个kafka的连接器的依赖也挺奇葩的 。</div>
<div><a href="https://huster.top/wp-content/uploads/2019/10/4.png"><img class="alignnone size-full wp-image-698" src="https://huster.top/wp-content/uploads/2019/10/4.png" alt="" width="1141" height="132" /></a></div>
<div></div>
<div>0.11版本依赖0.10.再依赖0.9……..让人很迷惑.</div>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/696.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>flink学习笔记(一)</title>
		<link>https://huster.top/htmls/691.html</link>
		<comments>https://huster.top/htmls/691.html#respond</comments>
		<pubDate>Thu, 17 Oct 2019 08:45:30 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[flink]]></category>

		<guid isPermaLink="false">https://huster.top/?p=691</guid>
		<description><![CDATA[架构  什么是flink flink是一个框架或者叫流式计算引擎，他可以用来处理有界(批处理，mapReduc &#8230; <a href="https://huster.top/htmls/691.html" class="more-link">继续阅读<span class="screen-reader-text">“flink学习笔记(一)”</span></a>]]></description>
				<content:encoded><![CDATA[<div>架构</div>
<ol>
<li>
<div> 什么是flink</div>
</li>
</ol>
<div>flink是一个框架或者叫流式计算引擎，他可以用来处理有界(批处理，mapReduce)数据和无界数据。他的特点是具有内存的速度和分布式的横向扩展能力。由于是分布式的，所以他可以处理任意规模的数据。另外，他是有状态的，表现为上一步的结算结果可以为下一步使用。</div>
<div></div>
<p><span id="more-691"></span></p>
<div>有界和无界的解释，见下面的图。</div>
<div><a href="https://huster.top/wp-content/uploads/2019/10/1.png"><img class="alignnone size-full wp-image-692" src="https://huster.top/wp-content/uploads/2019/10/1.png" alt="" width="2220" height="526" /></a></div>
<ol start="2">
<li>
<div>    如何解释内存般的访问速度。</div>
</li>
</ol>
<div>是指用户的逻辑始终需要不断的访问记录的状态，而这些状态被记录在内存里，这样访问就很快。当内存放不下的时候，会固化到硬盘里。另外，会定期的异步将当前的快照存放到硬盘里，以防止任务的重启能接着上次的终止的地方继续运算。如下图所示</div>
<div><a href="https://huster.top/wp-content/uploads/2019/10/2.png"><img class="alignnone size-full wp-image-693" src="https://huster.top/wp-content/uploads/2019/10/2.png" alt="" width="2784" height="630" /></a></div>
<div>运维</div>
<div>   1. flink的时间和特点</div>
<div>    flink提供了事件事件模式，即用事件发生时自身的时间戳来进行统计。好处是计算结果一定正确，坏处是可能有延迟。也就是即使是数据到达的不及时，也要保证结果的正确性。还有一种是处理时间模式，也就是用的是事件到达工作机的机器时间作为统计时间。这样做的好处是低延迟，坏处是可能结果不是那么的准确。</div>
<div>        2. flink的checkpoint和savepoint</div>
<div>checkpoint是异步的增量的持久化的保存着，是为了机器故障的恢复。而savepoint则是为了集群的迁移，版本的升级而设计。在流式应用中，一个很大的难点是如何在线平滑的升级你的flink应用(业务代码，业务发布)。如果你的业务代码都重新发布了，那以前的计算的中间结果如何承接过来。总不能你一升级，用户的点击数就从0开始计算吧？flink使用savepoint很好的解决了这个难题。另外，还支持flink版本的平滑升级。</div>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/691.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Java字节码增强应用</title>
		<link>https://huster.top/htmls/686.html</link>
		<comments>https://huster.top/htmls/686.html#respond</comments>
		<pubDate>Tue, 09 Jul 2019 12:55:59 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[Java学习]]></category>

		<guid isPermaLink="false">https://huster.top/?p=686</guid>
		<description><![CDATA[Java字节码增强技术 认识Instrumentation &#160; 基本用法: 方法 作用 addTra &#8230; <a href="https://huster.top/htmls/686.html" class="more-link">继续阅读<span class="screen-reader-text">“Java字节码增强应用”</span></a>]]></description>
				<content:encoded><![CDATA[<h1>Java字节码增强技术</h1>
<h1 id="N9W6r">认识Instrumentation</h1>
<p>&nbsp;</p>
<p>基本用法:</p>
<table class="lake-table" style="width: 722px;">
<colgroup>
<col width="240" />
<col width="240" />
<col width="241" /> </colgroup>
<tbody>
<tr>
<td>方法</td>
<td>作用</td>
<td></td>
</tr>
<tr>
<td>addTransformer</td>
<td>织入一段代码</td>
<td></td>
</tr>
<tr>
<td>removeTransformer</td>
<td>移除被织入的代码</td>
<td></td>
</tr>
<tr>
<td style="background-color: #ffffff;" colspan="1">retransformClasses</td>
<td style="background-color: #ffffff;" colspan="1">用于已经载入的类重新植入</td>
<td style="background-color: #ffffff;" colspan="1">Class&lt;?&gt;&#8230; classes</td>
</tr>
</tbody>
</table>
<p><span id="more-686"></span></p>
<p>其他用法:</p>
<table class="lake-table" style="width: 722px;">
<colgroup>
<col width="240" />
<col width="240" />
<col width="241" /> </colgroup>
<tbody>
<tr>
<td>方法</td>
<td>作用</td>
<td></td>
</tr>
<tr>
<td>appendToBootstrapClassLoaderSearch</td>
<td>将指定路径的jar包用bootstrapclassloader查找路径</td>
<td></td>
</tr>
<tr>
<td>getAllLoadedClasses</td>
<td>获取所有已加载的类</td>
<td></td>
</tr>
<tr>
<td style="background-color: #ffffff;" colspan="1">getObjectSize</td>
<td style="background-color: #ffffff;" colspan="1">获取指定的对象的大小</td>
<td style="background-color: #ffffff;" colspan="1"></td>
</tr>
<tr>
<td style="background-color: #ffffff;" colspan="1">isNativeMethodPrefixSupported</td>
<td style="background-color: #ffffff;" colspan="1">是否拦截本地方法</td>
<td style="background-color: #ffffff;" colspan="1"></td>
</tr>
</tbody>
</table>
<h1 id="txjJI">Permain的方式植入代码</h1>
<h2 id="5KeNr">程序测试代码</h2>
<p>&nbsp;</p>
<pre data-lang="java"><code>package huster.top;

/**
 * Created by longan.rtb on 2019/7/8.
 */
public class JavaAgentTest {

    public String helloWorld() {
        for (int i = 0; i&lt;5; i++) {
            System.out.println("Hello world!");
        }
        return "ok";
    }

    public static void main(String[] args) {
        JavaAgentTest javaAgentTest = new JavaAgentTest();
        javaAgentTest.helloWorld();
    }
}
</code></pre>
<p>&nbsp;</p>
<h2 id="5O1RN">Agent代码(permain方式)</h2>
<p>&nbsp;</p>
<pre data-lang="java"><code>package huster.top;

import java.lang.instrument.Instrumentation;

/**
 * Created by longan.rtb on 2019/7/8.
 */
public class AgentMain  {

    public static void premain(String args, Instrumentation inst) {
       System.out.println("permain has been called, arguments is : " + args);
       inst.addTransformer(new AOPImplement());
    }
}
</code></pre>
<p>&nbsp;</p>
<pre data-lang="java"><code>public class AOPImplement implements ClassFileTransformer {

    private final static String methodName = "helloWorld";

    private final static String targetClassName = "huster.top.JavaAgentTest";

   public byte[]
    transform(  ClassLoader         loader,
                String              className,
                Class&lt;?&gt;            classBeingRedefined,
                ProtectionDomain protectionDomain,
                byte[]              classfileBuffer)
            throws IllegalClassFormatException {
       className = className.replace("/", ".");
       if (!className.equals(targetClassName)) {
           //只监控需要的类
           return classfileBuffer;
       }

       CtClass ctclass = null;
       try {
           ctclass = ClassPool.getDefault().get(className);
           //只监控需要的方法
           CtMethod ctmethod = ctclass.getDeclaredMethod(methodName);
           //旧方法改个名字
           String oldMethod = methodName + "_____old____";
           ctmethod.setName(oldMethod);
           CtMethod newMethod = CtNewMethod.copy(ctmethod, methodName, ctclass, null);
           String methodBody = "{" +
                        "System.out.println(\"before called!!\");\n" +
                        "String a = " + oldMethod + "($$);\n" +
                        "System.out.println(\"after method called!!\");\n" +
                        "return a;" +
                   "}";
           newMethod.setBody(methodBody);
           ctclass.addMethod(newMethod);
           return ctclass.toBytecode();
       } catch (Exception e) {
           e.printStackTrace();
           return classfileBuffer;
       }

   }
}</code></pre>
<p>&nbsp;</p>
<p>pom.xml</p>
<p>&nbsp;</p>
<pre data-lang="java"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;javaagent-demo&lt;/artifactId&gt;
        &lt;groupId&gt;huster.top&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;original-agent&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javassist&lt;/groupId&gt;
            &lt;artifactId&gt;javassist&lt;/artifactId&gt;
            &lt;version&gt;3.12.1.GA&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;finalName&gt;original-agent&lt;/finalName&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                    &lt;encoding&gt;utf-8&lt;/encoding&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.0.0&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;archive&gt;
                        &lt;manifest&gt;
                            &lt;addClasspath&gt;true&lt;/addClasspath&gt;
                        &lt;/manifest&gt;
                        &lt;manifestEntries&gt;
                            &lt;Premain-Class&gt;huster.top.AgentMain&lt;/Premain-Class&gt;
                        &lt;/manifestEntries&gt;
                    &lt;/archive&gt;
                    &lt;descriptorRefs&gt;
                        &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;
                    &lt;/descriptorRefs&gt;
                &lt;/configuration&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;id&gt;make-assembly&lt;/id&gt;
                        &lt;phase&gt;package&lt;/phase&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;single&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>然后在测试代码的vm参数里增加：</p>
<p>-javaagent:/Users/longan.rtb/JavaProject/javaagentdemo/originalagent/target/original-agent-jar-with-dependencies.jar=args1;args2;args3</p>
<p>&nbsp;</p>
<p>运行结果如下：</p>
<p><a href="https://huster.top/wp-content/uploads/2019/07/123.png"><img class="alignnone size-full wp-image-687" src="https://huster.top/wp-content/uploads/2019/07/123.png" alt="" width="800" height="169" /></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1 id="03SBv">Attach的方式植入代码</h1>
<h2 id="7ste8">attach的程序</h2>
<p>&nbsp;</p>
<pre data-lang="java"><code>public class AttachAgent {

    public static void main(String[] args)  throws Exception {
        String pid = args[0];
        String jar = args[1];
        if (jar == null  || "".equals(jar)) {
            jar = "/Users/longan.rtb/JavaProject/javaagentdemo/originalagent/target/original-agent-jar-with-dependencies.jar";
        }
        VirtualMachine vmObj = null;
        try {
            vmObj = VirtualMachine.attach(pid);
            vmObj.loadAgent(jar,
                    "this is arguments");
        } finally {
            if (vmObj != null) {
                vmObj.detach();
            }

        }
    }
}
</code></pre>
<p>&nbsp;</p>
<h2 id="Fi6f1">agent的代码修改为</h2>
<p>&nbsp;</p>
<pre data-lang="java"><code>public class AgentMain  {

    public static void premain(String args, Instrumentation inst) {
       System.out.println("permain has been called, arguments is : " + args);
       inst.addTransformer(new AOPImplement());
    }

    //attach方式.
    public static void agentmain(String args, Instrumentation inst){
        System.out.println("444agentmain has been called, arguments is : " + args);
        System.out.println("is enable :" + String.valueOf(inst.isRetransformClassesSupported()));
        inst.addTransformer(new AOPImplement2(),true);
        try {
            inst.retransformClasses(Class.forName("huster.top.JavaAgentTest"));
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}</code></pre>
<p>&nbsp;</p>
<h2 id="LrlOT">坑1: 始终报UnsupportedOperationException错误</h2>
<p>是因为我们在植入代码的时候，使用了新增函数的方法，这种方法的是不允许的在Retrans的时候</p>
<p>* Caused by: java.lang.UnsupportedOperationException: class redefinition failed: attempted to add a method* The retransformation may change method bodies, the constant pool and attributes.* The retransformation must not add, remove or rename fields or methods, change the* signatures of methods, or change inheritance.  These restrictions maybe be* lifted in future versions.  The class file bytes are not checked, verified and installed* until after the transformations have been applied, if the resultant bytes are in* error this method will throw an exception.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="ja8jv">将attach程序打包成jar运行</h2>
<p>pom.xml</p>
<p>&nbsp;</p>
<pre data-lang="java"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;javaagent-demo&lt;/artifactId&gt;
        &lt;groupId&gt;huster.top&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;


    &lt;artifactId&gt;attach-agent&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.sun&lt;/groupId&gt;
            &lt;artifactId&gt;tools&lt;/artifactId&gt;
            &lt;version&gt;1.8&lt;/version&gt;
            &lt;scope&gt;system&lt;/scope&gt;
            &lt;systemPath&gt;${java.home}/../lib/tools.jar&lt;/systemPath&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;attached&lt;/goal&gt;
                        &lt;/goals&gt;
                        &lt;phase&gt;package&lt;/phase&gt;
                        &lt;configuration&gt;
                            &lt;descriptorRefs&gt;
                                &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;
                            &lt;/descriptorRefs&gt;
                            &lt;archive&gt;
                                &lt;manifest&gt;
                                    &lt;mainClass&gt;huster.top.AttachAgent&lt;/mainClass&gt;
                                &lt;/manifest&gt;
                            &lt;/archive&gt;
                        &lt;/configuration&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre>
<p>&nbsp;</p>
<h2 id="Bs2jY">坑2: VirtualMachine找不到的问题</h2>
<p>需要我们在运行的时候指明tool.jar的位置</p>
<p>/Library/Java/JavaVirtualMachines/jdk1.8.0_111.jdk/Contents/Home/bin/java -jar -Xbootclasspath/a:/Library/Java/JavaVirtualMachines/jdk1.8.0_111.jdk/Contents/Home/lib/tools.jar /Users/longan.rtb/JavaProject/javaagentdemo/attachagent/target/attach-agent-1.0-SNAPSHOT-jar-with-dependencies.jar 29808</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/686.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>JVM Sandbox 源码分析（一）基础篇: Instrumentation和ClassFileTransformer作用</title>
		<link>https://huster.top/htmls/662.html</link>
		<comments>https://huster.top/htmls/662.html#respond</comments>
		<pubDate>Mon, 03 Jun 2019 12:41:44 +0000</pubDate>
		<dc:creator><![CDATA[龙安_任天兵]]></dc:creator>
				<category><![CDATA[Java学习]]></category>
		<category><![CDATA[java agent]]></category>
		<category><![CDATA[jvm sandbox]]></category>

		<guid isPermaLink="false">http://huster.top/?p=662</guid>
		<description><![CDATA[背景 jvm sandbox是一个开源项目https://github.com/alibaba/jvm-san &#8230; <a href="https://huster.top/htmls/662.html" class="more-link">继续阅读<span class="screen-reader-text">“JVM Sandbox 源码分析（一）基础篇: Instrumentation和ClassFileTransformer作用”</span></a>]]></description>
				<content:encoded><![CDATA[<h1>背景</h1>
<p>jvm sandbox是一个开源项目https://github.com/alibaba/jvm-sandbox/wiki/FIRST-MODULE，他是对java agent的一个应用，他将agent发扬光大，让你可以不用用户改代码的情况下，进行代码增强，实现AOP，切面编程的功能，非常强大。但是他的代码量其实不大，文档清晰，所以读起来不是太费劲。他最最基础和核心的功能是使用了Java 提供的 Instrumenttation和ClassFileTransformer来实现的，我们先来了解下这个两个类的API，了解他们都提供了什么功能。</p>
<p>&nbsp;</p>
<p><span id="more-662"></span></p>
<h1 id="0Pnqw">Instrumentation类用途</h1>
<p>提供Java代码增强功能。例如为了提供收集数据的功能，可以通过字节码增强技术，对类的方法进行增强。由于代码是添加的，所以他不会修改原来的状态。通过这个API，我们可以开发各种工具，例如监控的客户端，profiles，代码覆盖率分析工具以及事件的日志埋点工具。</p>
<p>有两种方式来获取Instrumentation实例。一种是在java启动的时候添加参数-javaagent将你的增强包加载进来，另外一种是使用VirtualMachine的API来进行。具体的做法是调用VirtualMachine.attach(java pid). 前者会在permain里把Instrumentation传过来，后者会在agentmain方法里把Instrumentation实例传过来。</p>
<p>一旦拿到了Instrumentation实例，你就可以在任何时候对原来的java代码进行代码增强。</p>
<h2 id="xzOdu"><span>addTransformer</span>(ClassFileTransformer transformer,<span> </span><strong>boolean<span> </span></strong>canRetransform)</h2>
<p>函数的作用是注册一段代码增强逻辑，他能对所有已定义的类生效<span>(除了通过依赖的</span><span>transformer进行定义的类?????)。当一个类被加载的时候，或者</span><span>是</span><span>redefineClasses方法被调用的时候，或者是</span><span>retransformClasses方法被调用的时候(前提是canRetransform的参数是true)，这个函数里注册的transformer就被调用了。至于transformer之间调用的顺序，则是由添加</span><span>的先后顺序来决定的的(假设有多个agent对同一个类的方法进行了增强，他们是按照先后顺序来执行的。)，可以想象一下管道命令，是一样的。</span></p>
<p><span>异常问题，值得注意的是，如果这个方法在执行的时候发生了异常，jvm不会中断，他会继续进行下一个transformer的执行。</span></p>
<p><span>重复add的问题，同一个transformer可能会被add多次，这个是不被推荐的，add多次最好new新的对象进行。</span></p>
<p>当传入的transformer是null的时候，这个方法会抛出NullPointException的异常，当canRetransform被设为true，而JVM虚拟机被设置为不可被reTransfrom的时候(参见<span>isRetransformClassesSupported方法</span>)，会抛出<span>UnsupportedOperationException异常。</span></p>
<h2 id="Gq9la"><span><br />
</span><span>addTransformer</span>(ClassFileTransformer transformer)</h2>
<p>等同于addTranformer(transformer,false);</p>
<h2 id="waQUQ"><span>removeTransformer</span>(ClassFileTransformer transformer)</h2>
<p><span>移除已注册的transformer。未来被定义的类将不会被应用这个transformer。由于类加载的多线程语义性，可能被移除的transformer还会依然生效，所以业务方在编写的时候要处理好，做好防御性编程。</span></p>
<h2 id="Mys7v"><span>isRetransformClassesSupported</span>()</h2>
<p>返回当前的JVM配置是否支持类的reTransform。这个取决于你的javaagent里manifest的配置项<span>的</span><span>Can-</span><span>Retransform-Classes配置，示例如下</span></p>
<p><span>​<span data-card-element="center" contenteditable="false"><span class="lake-image"><span class="lake-image-content lake-image-content-isvalid"><span data-role="detail" class="lake-image-detail"><span class="lake-image-meta"><img data-role="image" src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/1831/1559554109168-85b8888a-e4ed-4c7d-91bf-4ae19d1b3ece.png" data-raw-src="" class="image lake-drag-image" alt="image.png" title="image.png" />                            </span>       </span>     </span>   </span></span>​</span></p>
<h2 id="U0Gra"><span>retransformClasses</span>(Class&lt;?&gt;&#8230; classes) throws UnmodifiableClassException</h2>
<p>函数的用途是对传入的classes执行transform，一般用于agentmain的方式。因为agentmain的方式是在class已经被加载完了之后attch到jvm上的，这个时候只有通过这种方式来修改原来的类的行为。</p>
<p>所以在add的时候，canTransform设置为false的将会被忽略，只有设置为true的才会被执行。如果你的jvm的<span>Can-</span><span>Retransform-Classes被设置为false，会抛出异常。同时如果你的类有问题，可能会抛出ClassFormatError，NoClassDefFoundError，</span><span>ClassCircularityError，LinkageError异常，如果传入的是null，会报NullPointerException</span></p>
<h2 id="CcbjG">isRedefineClassesSupported();</h2>
<p><span>同</span><span>isRetransformClassesSupported，在manifest里配置的</span></p>
<p><span>​<span data-card-element="center" contenteditable="false"><span class="lake-image"><span class="lake-image-content lake-image-content-isvalid"><span data-role="detail" class="lake-image-detail"><span class="lake-image-meta"><img data-role="image" src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/1831/1559555920501-e7da66a6-082e-487b-a8e8-10a3d901fd8a.png" data-raw-src="" class="image lake-drag-image" alt="image.png" title="image.png" />                            </span>       </span>     </span>   </span></span>​</span></p>
<h2 id="vkc6n">redefineClasses(ClassDefinition&#8230; definitions) throws  ClassNotFoundException, UnmodifiableClassException;</h2>
<p>这个和retransformClasses非常的相似。也有人在openjdk里问过这个问题，http://mail.openjdk.java.net/pipermail/serviceability-dev/2008-May/000131.html，大概的解释是，retransformClasses是fix-and-continues，而redefined则是直接替换掉了。尤其是有多个agent同时工作的时候，更加推荐retransform。</p>
<h2 id="gXuF8">isModifiableClass(Class&lt;?&gt; theClass)</h2>
<p>这个类是否能够被transform，如果可以则返回true。</p>
<h2 id="QnROe">getAllLoadedClasses()</h2>
<p>获取所有被JVM加载的类，这个是诊断的好帮手</p>
<h2 id="lbkW8">getInitiatedClasses(ClassLoader loader)‘</h2>
<p>获取所有被指定的classloader加载的类，如果传入null则返回由BootstrapClassl返回的类。</p>
<h2 id="KOwfz">getObjectSize(Object objectToSize)</h2>
<p>获取一个对象消耗的空间大小</p>
<h2 id="I87RV">appendToBootstrapClassLoaderSearch(JarFile jarfile)</h2>
<p>将指定的jar包加载给BootstrapClassLoader，可以被执行多次从而加载多个jar包。查找类的时候会先去BootStrapLoader里去找，如果找不到就到这个jar包里面去找。</p>
<p>需要小心处理的是，包名不要重复。例如，在ClassLoader L里加载了一个类C，他有一个私有类是C$1，如果你的jar包里正好也有个类C$1，他会先去BootstrapClassLoader里去找，发现找到了，然后去load，接着发现没有权限，就会直接报出IllegalAccessError错误。</p>
<h2 id="D2O9z">appendToSystemClassLoaderSearch(JarFile jarfile)</h2>
<p>特性和appendToBootstrapClassLoader类似，不过区别是这个是用于SystemClassLoader的类的查找的(回忆一下双亲委派机制)。</p>
<h2 id="4Gjci">isNativeMethodPrefixSupported()</h2>
<p>是否设置了本地方法的拦截，由manifest设置的。Can-Set-Native-Method-Prefix属性，具体set native method prefix的用途参考nativeMethodPrefix()</p>
<h2 id="sdkq9">setNativeMethodPrefix(ClassFileTransformer transformer, String prefix)</h2>
<p>对本地方法进行代码增强。但是由于本地方法是没有字节码的，所以他的办法是重新定义一个同名的函数(原来native method)的名称，然后将原来的本地方法使用prefix进行重命名。</p>
<p>举例，以前有一个本地方法 native boolean foo(String x),他的做法是先将native的方法重命名，例如改成</p>
<p>native boolean wapped_foo(String x), 然后再定义一个方法叫 boolean foo(String x) { &#8212;你的代码&#8212; ; prefix_foo(x)}。为了防止重复，所以你的prefix最好考虑到方法重复的情况。</p>
<p>正常情况下，按照上面顺序执行，但是如果有问题的时候他的执行顺序分别是</p>
<ol start="1">
<li><span>method(foo) -&gt; nativeImplementation(foo)</span></li>
<li> method(wrapped_foo) -&gt; nativeImplementation(foo)</li>
<li>method(wrapped_foo) -&gt; nativeImplementation(wrapped_foo)</li>
<li> method(wrapped_foo) -&gt; nativeImplementation(foo）</li>
</ol>
<p>按照以上的顺序来尝试执行。</p>
<h1 id="XvwqP">ClassFileTransformer类用途</h1>
<p>用来让用户来实现代码增强逻辑的接口。他只有一个方法，方法的参数是原来的类的字节码以及这个类的classloader对象，返回值则是被增强之后的类的字节码。所以你的代码是通过已有的类信息，植入代码之后，形成新的代码(类的字节码)。</p>
<h2 id="0SssK"> transform（ClassLoader,ClassName,classBeingRedefined,protectionDomain,classfileBuffer）</h2>
<p>这里的来源有两个，分别是Instrumentation的两个addInstrumentation()方法。</p>
<p>这个函数被调用的时机有如下几种情况</p>
<ol start="1">
<li>这个类第一次被加载，当ClassLoader的defineClass()方法(这个方法是classloader将字节码解析成类并且放入metaspace的过程)被调用的时候，这个方法会被call</li>
<li>Instrumentation#redefineClasses被调用了这个方法的时候，这个方法也会被调用</li>
<li>Instrumentation#retransformClasses当这个方法被调用的时候，这个方法也会被调用</li>
</ol>
<p>他们的执行是按照addInstrumentation的顺序来执行的。而reTransformClasses和redefineClasses被执行的时候，他们修改的字节码是在之前已经被增强的基础上进行的。</p>
<p>例如原始方法是foo(String x), 然后在类加载的时候进行了一些增强，插入了一段代码，那么在下次retransformClasses执行，这个方法被调用的时候，增加的字节码是在上一次的基础上进行的。换句话说，classfileBuffer永远都是最后增强执行完成之后的版本。</p>
<p>关于异常和返回值。如果返回值是null，代表这次调用什么都没做，没有任何增强代码加入。他的效果和抛出异常是一样的，如果在执行这个函数的过程中抛出了异常，则代表本次调用什么都不做，和返回null值的效果是一样的。</p>
]]></content:encoded>
			<wfw:commentRss>https://huster.top/htmls/662.html/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
