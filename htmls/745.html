<!DOCTYPE html>
<html lang="zh-CN" class="no-js"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script><title>又一起GC问题排查过程 – 三两带走</title><link rel="amphtml" href="https://huster.top/htmls/745.html/amp"><link rel="dns-prefetch" href="//rentb.vicp.net"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//s.w.org"><link rel="stylesheet" id="dashicons-css" href="https://huster.top/wp-includes/css/dashicons.min.css" type="text/css" media="all"><link rel="stylesheet" id="obfx-module-pub-css-menu-icons-0-css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=2.8.4" type="text/css" media="all"><link rel="stylesheet" id="obfx-module-pub-css-menu-icons-1-css" href="https://huster.top/wp-content/plugins/themeisle-companion/obfx_modules/menu-icons/css/public.css" type="text/css" media="all"><style id="md-style-inline-css" type="text/css">
 
</style><link rel="stylesheet" id="genericons-css" href="https://huster.top/wp-content/themes/twentysixteen/genericons/genericons.css" type="text/css" media="all"><link rel="stylesheet" id="twentysixteen-style-css" href="https://huster.top/wp-content/themes/twentysixteen/style.css" type="text/css" media="all"><style id="twentysixteen-style-inline-css" type="text/css">
	    
		body.page-template-builder-fullwidth.elementor-page,
		body.page-template-builder-fullwidth-std.elementor-page {
			background: transparent;
		}
		.page-template-builder-fullwidth-std .site {
			margin: 0;
		}
		.page-template-builder-fullwidth .elementor-page,
        .page-template-builder-fullwidth-std .elementor-page {
	        overflow: hidden;
        }
		.page-template-builder-fullwidth .full-width,
        .page-template-builder-fullwidth-std .full-width {
	        width: 100%;
        }
        .page-template-builder-fullwidth .site-inner,
        .page-template-builder-fullwidth-std .site-inner {
            max-width: 100%;
        }
        .page-template-builder-fullwidth .site-content,
        .page-template-builder-fullwidth-std .site-content {
            padding: 0;
        }
        .page-template-builder-fullwidth header#masthead,
        .page-template-builder-fullwidth footer#colophon,
        .page-template-builder-fullwidth-std header#masthead,
        .page-template-builder-fullwidth-std footer#colophon {
	        margin: 0 auto;
	        max-width: 1320px;
        } 
        .page-template-builder-fullwidth .entry-content,
        .page-template-builder-fullwidth-std .entry-content {
	        margin-right: auto;
	        margin-left: auto;
        }
        @media screen and (min-width: 56.875em) {
	        .admin-bar .anchor-menu {
		        top: 20px;
	        }	
			.admin-bar .anchor-menu-fixed.anchor-menu, .admin-bar .anchor-menu-fixed.elementor-widget-wp-widget-nav_menu {
				top: 54px !important;
			}			
			.page-template-builder-fullwidth .entry-content,
            .page-template-builder-fullwidth-std .entry-content	{
	            margin-right: auto;
	            margin-left: auto;
	        }
        }
        @media screen and (min-width: 44.375em) {	        
			.page-template-builder-fullwidth .entry-content,
            .page-template-builder-fullwidth-std .entry-content {
	            margin-right: auto;;
	        }
        }
	
</style><script type="text/javascript" src="https://huster.top/wp-includes/js/jquery/jquery.js"></script><script type="text/javascript" src="https://huster.top/wp-includes/js/jquery/jquery-migrate.min.js"></script><style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style><link rel="preload" as="style" href="https://huster.top/wp-content/plugins/code-prettify/prettify/prettify.css"><style type="text/css" id="syntaxhighlighteranchor"></style><link rel="icon" href="https://huster.top/wp-content/uploads/2018/09/cropped-fish_112.18181818182px_1208536_easyicon.net_-32x32.png" sizes="32x32"><link rel="icon" href="https://huster.top/wp-content/uploads/2018/09/cropped-fish_112.18181818182px_1208536_easyicon.net_-192x192.png" sizes="192x192"><link rel="apple-touch-icon-precomposed" href="https://huster.top/wp-content/uploads/2018/09/cropped-fish_112.18181818182px_1208536_easyicon.net_-180x180.png"><meta name="msapplication-TileImage" content="https://huster.top/wp-content/uploads/2018/09/cropped-fish_112.18181818182px_1208536_easyicon.net_-270x270.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script></head><body class="post-template-default single single-post postid-745 single-format-standard">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="#content">跳至内容</a>

		<header id="masthead" class="site-header" role="banner"><div class="site-header-main">
				<div class="site-branding">
					
											<p class="site-title"><a href="https://huster.top/" rel="home">三两带走</a></p>
											<p class="site-description">(任天兵)龙安的博客</p>
									</div>

							</div>

					</header><div id="content" class="site-content">

<div id="primary" class="content-area">
	<main id="main" class="site-main" role="main"><article id="post-745" class="post-745 post type-post status-publish format-standard hentry category-java"><header class="entry-header"><h1 class="entry-title">又一起GC问题排查过程</h1>	</header><div class="entry-content">
		<h2 id="ggbT8" data-lake-id="9f3c08a1f9fb9f3501aad6053e1c2122">背景</h2>
<p data-lake-id="f03a859e570b282b5d3e38ddf074e5b5">继上次找到redis导致的gc问题之后，又有一个应用发生了gc时间长的问题。每次gc的大概1s的停顿时间，导致这1s的请求全部超时，经常被业务方投诉。因为G1有更好的并行度，更短和确定的并行时间，因此负责的开发将应用从CMS升级到G1，然而问题依然没有解决. 这是一个网关类型的应用，负责接受rpc的调用，将请求转发到后端的http请求，将封装好的数据，转发给业务使用。所以实际上是</p>
<p data-lake-id="a00cddf79ea31d40896e0b20ef03866d">Application---->rpc-->GateWay(问题应用)-----http client ---> 其他服务.</p>
<p data-lake-id="a00cddf79ea31d40896e0b20ef03866d">
</p><p data-lake-id="a00cddf79ea31d40896e0b20ef03866d">
</p><p data-lake-id="a00cddf79ea31d40896e0b20ef03866d"><span id="more-745"></span></p>
<h2 id="mICr2" data-lake-id="f39930be57bdf13856e2cc9487ab82c8">分析</h2>
<p data-lake-id="09b9b6fb2cc34f916d9a631b03774fc3">解决GC问题的思路，还是先要了解下你这个gc的特性和阶段，然后结合gc日志排查到底是哪里有问题。是频繁的youngGC还是oldGC，针对具体的问题，再配合jmap工具dump内存的heap下来分析。找到内存泄露或者是代码或者是配置不合理的地方。</p>
<h2 id="n4qX3" data-lake-id="e3133626794e7d711d1092283b766225">尝试的方法</h2>
<ol start="1" data-lake-id="263e944e080eb29a93d0c2e1aa75b2f4"><li data-lake-id="e635180d7c5df27a2693f30178b666cf">首先是将CMS改为G1, 并且设定预期的时间为200ms，然而并没有解决问题</li>
</ol><div id="VQjnO" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%22Garbage_collector%3D%5C%22G1%5C%22%5CnGC_OPTS%3D%5C%22%24GC_OPTS%20-XX%3A%2BUseG1GC%20%5C%5C%5Cn-XX%3AMaxGCPauseMillis%3D200%20%5C%5C%5Cn-XX%3A%2BParallelRefProcEnabled%20-XX%3AParallelGCThreads%3D4%20-XX%3AConcGCThreads%3D4%20%5C%5C%5Cn-XX%3A%2BHeapDumpOnOutOfMemoryError%20%5C%5C%5Cn-XX%3A%2BPrintClassHistogramBeforeFullGC%20%5C%5C%5Cn-XX%3A%2BPrintClassHistogramAfterFullGC%20%20%5C%5C%5Cn-XX%3A%2BPrintGCApplicationConcurrentTime%20%20%5C%5C%5Cn-XX%3A%2BPrintGCApplicationStoppedTime%20%5C%5C%5Cn-XX%3A%2BPrintTenuringDistribution%20%5C%5C%5Cn-XX%3A%2BPrintReferenceGC%20%5C%5C%5Cn-XX%3A%2BPrintHeapAtGC%5C%22%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%22VQjnO%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-def">Garbage_collector</span><span class="cm-operator">=</span><span class="cm-string">"G1"</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-def">GC_OPTS</span><span class="cm-operator">=</span><span class="cm-string">"</span><span class="cm-def">$GC_OPTS</span><span class="cm-string"> -XX:+UseG1GC \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:MaxGCPauseMillis=200 \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+ParallelRefProcEnabled -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+HeapDumpOnOutOfMemoryError \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintClassHistogramBeforeFullGC \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintClassHistogramAfterFullGC  \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintGCApplicationConcurrentTime  \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintGCApplicationStoppedTime \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintTenuringDistribution \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintReferenceGC \</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-string">-XX:+PrintHeapAtGC"</span></span></span></pre>
</div>
</div>
</div>
<p data-lake-id="ccd857f387da6271e301f15a02ef787b">过2~3天，又会因为gc问题发生一波超时.</p>
<h2 id="yr0YE" data-lake-id="229a5ed9e620956bcc04875b8e828edd">G1日志分析</h2>
<h3 id="JfoAw" data-lake-id="18fd851195b09dad5e57fa88a6dd6884">G1了解</h3>
<p data-lake-id="31fadf830484526c4e7a4ba818e8eb92">要看懂g1日志，首先得知道这个G1的原理。总结无非这几点, G1使用的是Region作为内存单元来存储数据(大小可以设置)，然后他模糊了youngGC区和old区的概念，这个只作为一个逻辑分区。因此在他yonggc发生的时候，可以顺带的回收old区的内容，而不用像cms一样，等到一个百分比的时候，再触发一次oldgc，来一个全区的扫描，那个当然就费时间了</p>
<p data-lake-id="e0c9872bc981c4be4e937ab7cd234790">另外，就是他的核心RSet的设计，记录了跨区的引用，以此来防止全区的一个扫描。</p>
<p data-lake-id="01026feeddbc240578640b2a5c360a8e">G1的gc分为以下几个阶段:</p>
<h4 id="55be9bff" data-lake-id="0c0348102e9ddca690d983a2a9b46821">YoungGC阶段</h4>
<p data-lake-id="3bc2df7d01e1d054a2dbaf400fe1056e">触发时机 : 当Eden空间被占满之后，就会触发YGC,在G1中YGC依然采用复制存活对象到survivor空间的方式。他虽然是stop wold的，但是他是并发执行的，日志类似于这样：</p>
<p data-lake-id="c405f6142066414d75a2a162cbff513b">youngGC不需要扫描老年代，因为他通过RSet就知道哪些年轻代的对象是被老年代引用的.</p>
<div id="Vnq5M" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-07-28T18%3A29%3A37.235%2B0800%3A%2078143.812%3A%20%5BSoftReference%2C%200%20refs%2C%200.0005405%20secs%5D2020-07-28T18%3A29%3A37.236%2B0800%3A%2078143.813%3A%20%5BWeakReference%2C%20650%20refs%2C%200.0004000%20secs%5D2020-07-28T18%3A29%3A37.236%2B0800%3A%2078143.813%3A%20%5BFinalReference%2C%2056137%20refs%2C%200.0136734%20secs%5D2020-07-28T18%3A29%3A37.250%2B0800%3A%2078143.827%3A%20%5BPhantomReference%2C%200%20refs%2C%2010%20refs%2C%200.0006262%20secs%5D2020-07-28T18%3A29%3A37.251%2B0800%3A%2078143.828%3A%20%5BJNI%20Weak%20Reference%2C%200.0000456%20secs%5D%2C%200.0872782%20secs%5D%5Cn%20%20%20%5BParallel%20Time%3A%2061.9%20ms%2C%20GC%20Workers%3A%204%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20Start%20(ms)%3A%20Min%3A%2078143750.0%2C%20Avg%3A%2078143750.0%2C%20Max%3A%2078143750.0%2C%20Diff%3A%200.1%5D%5Cn%20%20%20%20%20%20%5BExt%20Root%20Scanning%20(ms)%3A%20Min%3A%2010.0%2C%20Avg%3A%2010.2%2C%20Max%3A%2010.3%2C%20Diff%3A%200.3%2C%20Sum%3A%2040.9%5D%5Cn%20%20%20%20%20%20%5BUpdate%20RS%20(ms)%3A%20Min%3A%2021.1%2C%20Avg%3A%2021.2%2C%20Max%3A%2021.2%2C%20Diff%3A%200.1%2C%20Sum%3A%2084.8%5D%5Cn%20%20%20%20%20%20%20%20%20%5BProcessed%20Buffers%3A%20Min%3A%20451%2C%20Avg%3A%20484.8%2C%20Max%3A%20516%2C%20Diff%3A%2065%2C%20Sum%3A%201939%5D%5Cn%20%20%20%20%20%20%5BScan%20RS%20(ms)%3A%20Min%3A%205.9%2C%20Avg%3A%206.0%2C%20Max%3A%206.0%2C%20Diff%3A%200.1%2C%20Sum%3A%2023.8%5D%5Cn%20%20%20%20%20%20%5BCode%20Root%20Scanning%20(ms)%3A%20Min%3A%200.0%2C%20Avg%3A%200.0%2C%20Max%3A%200.0%2C%20Diff%3A%200.0%2C%20Sum%3A%200.1%5D%5Cn%20%20%20%20%20%20%5BObject%20Copy%20(ms)%3A%20Min%3A%2024.0%2C%20Avg%3A%2024.2%2C%20Max%3A%2024.4%2C%20Diff%3A%200.4%2C%20Sum%3A%2096.9%5D%5Cn%20%20%20%20%20%20%5BTermination%20(ms)%3A%20Min%3A%200.0%2C%20Avg%3A%200.0%2C%20Max%3A%200.0%2C%20Diff%3A%200.0%2C%20Sum%3A%200.0%5D%5Cn%20%20%20%20%20%20%20%20%20%5BTermination%20Attempts%3A%20Min%3A%201%2C%20Avg%3A%208.8%2C%20Max%3A%2017%2C%20Diff%3A%2016%2C%20Sum%3A%2035%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20Other%20(ms)%3A%20Min%3A%200.0%2C%20Avg%3A%200.1%2C%20Max%3A%200.1%2C%20Diff%3A%200.1%2C%20Sum%3A%200.3%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20Total%20(ms)%3A%20Min%3A%2061.6%2C%20Avg%3A%2061.7%2C%20Max%3A%2061.7%2C%20Diff%3A%200.1%2C%20Sum%3A%20246.8%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20End%20(ms)%3A%20Min%3A%2078143811.7%2C%20Avg%3A%2078143811.7%2C%20Max%3A%2078143811.8%2C%20Diff%3A%200.1%5D%5Cn%20%20%20%5BCode%20Root%20Fixup%3A%200.2%20ms%5D%5Cn%20%20%20%5BCode%20Root%20Purge%3A%200.0%20ms%5D%5Cn%20%20%20%5BClear%20CT%3A%201.8%20ms%5D%5Cn%20%20%20%5BOther%3A%2023.4%20ms%5D%5Cn%20%20%20%20%20%20%5BChoose%20CSet%3A%200.0%20ms%5D%5Cn%20%20%20%20%20%20%5BRef%20Proc%3A%2015.6%20ms%5D%5Cn%20%20%20%20%20%20%5BRef%20Enq%3A%200.4%20ms%5D%5Cn%20%20%20%20%20%20%5BRedirty%20Cards%3A%200.5%20ms%5D%5Cn%20%20%20%20%20%20%5BHumongous%20Register%3A%200.1%20ms%5D%5Cn%20%20%20%20%20%20%5BHumongous%20Reclaim%3A%200.0%20ms%5D%5Cn%20%20%20%20%20%20%5BFree%20CSet%3A%202.7%20ms%5D%5Cn%20%20%20%5BEden%3A%206084.0M(6084.0M)-%3E0.0B(6080.0M)%20Survivors%3A%2060.0M-%3E64.0M%20Heap%3A%208179.6M(10.0G)-%3E2102.0M(10.0G)%5D%5CnHeap%20after%20GC%20invocations%3D1261%20(full%200)%3A%5Cn%20garbage-first%20heap%20%20%20total%2010485760K%2C%20used%202152475K%20%5B0x0000000540000000%2C%200x0000000540405000%2C%200x00000007c0000000)%5Cn%20%20region%20size%204096K%2C%2016%20young%20(65536K)%2C%2016%20survivors%20(65536K)%5Cn%20Metaspace%20%20%20%20%20%20%20used%2082266K%2C%20capacity%2085616K%2C%20committed%2085760K%2C%20reserved%201124352K%5Cn%20%20class%20space%20%20%20%20used%209546K%2C%20capacity%2010192K%2C%20committed%2010240K%2C%20reserved%201048576K%5Cn%7D%5Cn%20%5BTimes%3A%20user%3D0.30%20sys%3D0.00%2C%20real%3D0.08%20secs%5D%20%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%22Vnq5M%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:37.235<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78143</span>.812: [SoftReference, <span class="cm-number">0</span> refs, <span class="cm-number">0</span>.0005405 secs]2020-07-28T18:29:37.236<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78143</span>.813: [WeakReference, <span class="cm-number">650</span> refs, <span class="cm-number">0</span>.0004000 secs]2020-07-28T18:29:37.236<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78143</span>.813: [FinalReference, <span class="cm-number">56137</span> refs, <span class="cm-number">0</span>.0136734 secs]2020-07-28T18:29:37.250<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78143</span>.827: [PhantomReference, <span class="cm-number">0</span> refs, <span class="cm-number">10</span> refs, <span class="cm-number">0</span>.0006262 secs]2020-07-28T18:29:37.251<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78143</span>.828: [JNI Weak Reference, <span class="cm-number">0</span>.0000456 secs], <span class="cm-number">0</span>.0872782 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Parallel Time: <span class="cm-number">61</span>.9 ms, GC Workers: <span class="cm-number">4</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker Start (ms): Min: <span class="cm-number">78143750</span>.0, Avg: <span class="cm-number">78143750</span>.0, Max: <span class="cm-number">78143750</span>.0, Diff: <span class="cm-number">0</span>.1]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Ext Root Scanning (ms): Min: <span class="cm-number">10</span>.0, Avg: <span class="cm-number">10</span>.2, Max: <span class="cm-number">10</span>.3, Diff: <span class="cm-number">0</span>.3, Sum: <span class="cm-number">40</span>.9]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Update RS (ms): Min: <span class="cm-number">21</span>.1, Avg: <span class="cm-number">21</span>.2, Max: <span class="cm-number">21</span>.2, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">84</span>.8]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">         [Processed Buffers: Min: <span class="cm-number">451</span>, Avg: <span class="cm-number">484</span>.8, Max: <span class="cm-number">516</span>, Diff: <span class="cm-number">65</span>, Sum: <span class="cm-number">1939</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Scan RS (ms): Min: <span class="cm-number">5</span>.9, Avg: <span class="cm-number">6</span>.0, Max: <span class="cm-number">6</span>.0, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">23</span>.8]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Code Root Scanning (ms): Min: <span class="cm-number">0</span>.0, Avg: <span class="cm-number">0</span>.0, Max: <span class="cm-number">0</span>.0, Diff: <span class="cm-number">0</span>.0, Sum: <span class="cm-number">0</span>.1]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Object Copy (ms): Min: <span class="cm-number">24</span>.0, Avg: <span class="cm-number">24</span>.2, Max: <span class="cm-number">24</span>.4, Diff: <span class="cm-number">0</span>.4, Sum: <span class="cm-number">96</span>.9]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Termination (ms): Min: <span class="cm-number">0</span>.0, Avg: <span class="cm-number">0</span>.0, Max: <span class="cm-number">0</span>.0, Diff: <span class="cm-number">0</span>.0, Sum: <span class="cm-number">0</span>.0]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">         [Termination Attempts: Min: <span class="cm-number">1</span>, Avg: <span class="cm-number">8</span>.8, Max: <span class="cm-number">17</span>, Diff: <span class="cm-number">16</span>, Sum: <span class="cm-number">35</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker Other (ms): Min: <span class="cm-number">0</span>.0, Avg: <span class="cm-number">0</span>.1, Max: <span class="cm-number">0</span>.1, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">0</span>.3]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker Total (ms): Min: <span class="cm-number">61</span>.6, Avg: <span class="cm-number">61</span>.7, Max: <span class="cm-number">61</span>.7, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">246</span>.8]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker End (ms): Min: <span class="cm-number">78143811</span>.7, Avg: <span class="cm-number">78143811</span>.7, Max: <span class="cm-number">78143811</span>.8, Diff: <span class="cm-number">0</span>.1]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Code Root Fixup: <span class="cm-number">0</span>.2 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Code Root Purge: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Clear CT: <span class="cm-number">1</span>.8 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Other: <span class="cm-number">23</span>.4 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Choose CSet: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Ref Proc: <span class="cm-number">15</span>.6 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Ref Enq: <span class="cm-number">0</span>.4 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Redirty Cards: <span class="cm-number">0</span>.5 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Humongous Register: <span class="cm-number">0</span>.1 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Humongous Reclaim: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Free CSet: <span class="cm-number">2</span>.7 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Eden: <span class="cm-number">6084</span>.0M(6084.0M)->0.0B(6080.0M) Survivors: <span class="cm-number">60</span>.0M->64.0M Heap: <span class="cm-number">8179</span>.6M(10.0G)->2102.0M(10.0G)]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">Heap after GC <span class="cm-def">invocations</span><span class="cm-operator">=</span><span class="cm-number">1261</span> (full <span class="cm-number">0</span>):
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> garbage-first heap   total 10485760K, used 2152475K [0x0000000540000000, 0x0000000540405000, 0x00000007c0000000)
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">  region size 4096K, <span class="cm-number">16</span> young (65536K), <span class="cm-number">16</span> survivors (65536K)
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> Metaspace       used 82266K, capacity 85616K, committed 85760K, reserved 1124352K
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">  class space    used 9546K, capacity 10192K, committed 10240K, reserved 1048576K
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">}
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> [Times: <span class="cm-def">user</span><span class="cm-operator">=</span><span class="cm-number">0</span>.30 <span class="cm-def">sys</span><span class="cm-operator">=</span><span class="cm-number">0</span>.00, <span class="cm-def">real</span><span class="cm-operator">=</span><span class="cm-number">0</span>.08 secs] </span></span></pre>
</div>
</div>
</div>
<p data-lake-id="ed17263922f1a2b65579acbc3af8cbdf">然后我们可以看到这个并发交替的过程如下，他是一会执行用户程序，一会执行gc任务，清楚的看到他的交替过程:</p>
<div id="MAb9X" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-07-28T18%3A29%3A37.259%2B0800%3A%2078143.836%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0960241%20seconds%2C%20Stopping%20threads%20took%3A%200.0009531%20seconds%5Cn2020-07-28T18%3A29%3A39.182%2B0800%3A%2078145.759%3A%20Application%20time%3A%201.9228829%20seconds%5Cn2020-07-28T18%3A29%3A39.190%2B0800%3A%2078145.767%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0079957%20seconds%2C%20Stopping%20threads%20took%3A%200.0009701%20seconds%5Cn2020-07-28T18%3A29%3A39.190%2B0800%3A%2078145.767%3A%20Application%20time%3A%200.0002209%20seconds%5Cn2020-07-28T18%3A29%3A39.195%2B0800%3A%2078145.772%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0047948%20seconds%2C%20Stopping%20threads%20took%3A%200.0003450%20seconds%5Cn2020-07-28T18%3A29%3A39.195%2B0800%3A%2078145.772%3A%20Application%20time%3A%200.0003185%20seconds%5Cn2020-07-28T18%3A29%3A39.199%2B0800%3A%2078145.776%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0038102%20seconds%2C%20Stopping%20threads%20took%3A%200.0002901%20seconds%5Cn2020-07-28T18%3A29%3A39.200%2B0800%3A%2078145.776%3A%20Application%20time%3A%200.0004269%20seconds%5Cn2020-07-28T18%3A29%3A39.203%2B0800%3A%2078145.780%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0036949%20seconds%2C%20Stopping%20threads%20took%3A%200.0003017%20seconds%5Cn2020-07-28T18%3A29%3A39.204%2B0800%3A%2078145.780%3A%20Application%20time%3A%200.0003345%20seconds%5Cn2020-07-28T18%3A29%3A39.207%2B0800%3A%2078145.784%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0037270%20seconds%2C%20Stopping%20threads%20took%3A%200.0002750%20seconds%5Cn2020-07-28T18%3A29%3A39.208%2B0800%3A%2078145.784%3A%20Application%20time%3A%200.0002432%20seconds%5Cn2020-07-28T18%3A29%3A39.211%2B0800%3A%2078145.788%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0034454%20seconds%2C%20Stopping%20threads%20took%3A%200.0002974%20seconds%5Cn2020-07-28T18%3A29%3A39.211%2B0800%3A%2078145.788%3A%20Application%20time%3A%200.0002809%20seconds%5Cn2020-07-28T18%3A29%3A39.215%2B0800%3A%2078145.792%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0034799%20seconds%2C%20Stopping%20threads%20took%3A%200.0003126%20seconds%5Cn2020-07-28T18%3A29%3A39.215%2B0800%3A%2078145.792%3A%20Application%20time%3A%200.0001971%20seconds%5Cn2020-07-28T18%3A29%3A39.218%2B0800%3A%2078145.795%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0033639%20seconds%2C%20Stopping%20threads%20took%3A%200.0002907%20seconds%5Cn2020-07-28T18%3A29%3A39.219%2B0800%3A%2078145.795%3A%20Application%20time%3A%200.0002002%20seconds%5Cn2020-07-28T18%3A29%3A39.222%2B0800%3A%2078145.799%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0034734%20seconds%2C%20Stopping%20threads%20took%3A%200.0002560%20seconds%5Cn2020-07-28T18%3A29%3A39.223%2B0800%3A%2078145.799%3A%20Application%20time%3A%200.0004148%20seconds%5Cn2020-07-28T18%3A29%3A39.230%2B0800%3A%2078145.807%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0078923%20seconds%2C%20Stopping%20threads%20took%3A%200.0007479%20seconds%5Cn2020-07-28T18%3A29%3A39.231%2B0800%3A%2078145.807%3A%20Application%20time%3A%200.0002697%20seconds%5Cn2020-07-28T18%3A29%3A39.239%2B0800%3A%2078145.816%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0080425%20seconds%2C%20Stopping%20threads%20took%3A%200.0005797%20seconds%5Cn2020-07-28T18%3A29%3A39.239%2B0800%3A%2078145.816%3A%20Application%20time%3A%200.0004746%20seconds%5Cn2020-07-28T18%3A29%3A39.247%2B0800%3A%2078145.824%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0081480%20seconds%2C%20Stopping%20threads%20took%3A%200.0005586%20seconds%5Cn2020-07-28T18%3A29%3A39.248%2B0800%3A%2078145.824%3A%20Application%20time%3A%200.0002206%20seconds%5Cn2020-07-28T18%3A29%3A39.255%2B0800%3A%2078145.832%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0077953%20seconds%2C%20Stopping%20threads%20took%3A%200.0003357%20seconds%5Cn2020-07-28T18%3A29%3A39.256%2B0800%3A%2078145.833%3A%20Application%20time%3A%200.0004123%20seconds%5Cn2020-07-28T18%3A29%3A39.263%2B0800%3A%2078145.840%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0075859%20seconds%2C%20Stopping%20threads%20took%3A%200.0004447%20seconds%5Cn2020-07-28T18%3A29%3A39.264%2B0800%3A%2078145.840%3A%20Application%20time%3A%200.0001576%20seconds%5Cn2020-07-28T18%3A29%3A39.271%2B0800%3A%2078145.847%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0070406%20seconds%2C%20Stopping%20threads%20took%3A%200.0003025%20seconds%5Cn2020-07-28T18%3A29%3A39.271%2B0800%3A%2078145.848%3A%20Application%20time%3A%200.0003462%20seconds%5Cn2020-07-28T18%3A29%3A39.278%2B0800%3A%2078145.855%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0071142%20seconds%2C%20Stopping%20threads%20took%3A%200.0004311%20seconds%5Cn2020-07-28T18%3A29%3A39.278%2B0800%3A%2078145.855%3A%20Application%20time%3A%200.0001479%20seconds%5Cn2020-07-28T18%3A29%3A39.285%2B0800%3A%2078145.862%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0071285%20seconds%2C%20Stopping%20threads%20took%3A%200.0003712%20seconds%5Cn2020-07-28T18%3A29%3A39.287%2B0800%3A%2078145.864%3A%20Application%20time%3A%200.0018179%20seconds%5Cn2020-07-28T18%3A29%3A39.295%2B0800%3A%2078145.872%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0075329%20seconds%2C%20Stopping%20threads%20took%3A%200.0005250%20seconds%5Cn2020-07-28T18%3A29%3A39.296%2B0800%3A%2078145.872%3A%20Application%20time%3A%200.0008192%20seconds%5Cn2020-07-28T18%3A29%3A39.303%2B0800%3A%2078145.880%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0072368%20seconds%2C%20Stopping%20threads%20took%3A%200.0002966%20seconds%5Cn2020-07-28T18%3A29%3A39.303%2B0800%3A%2078145.880%3A%20Application%20time%3A%200.0006276%20seconds%5Cn2020-07-28T18%3A29%3A39.324%2B0800%3A%2078145.901%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0202434%20seconds%2C%20Stopping%20threads%20took%3A%200.0002417%20seconds%5Cn2020-07-28T18%3A30%3A04.065%2B0800%3A%2078170.642%3A%20Application%20time%3A%2024.7410815%20seconds%5Cn2020-07-28T18%3A30%3A04.073%2B0800%3A%2078170.650%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0082734%20seconds%2C%20Stopping%20threads%20took%3A%200.0009748%20seconds%5Cn2020-07-28T18%3A30%3A14.002%2B0800%3A%2078180.578%3A%20Application%20time%3A%209.9284404%20seconds%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%22MAb9X%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:37.259<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78143</span>.836: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0960241 seconds, Stopping threads took: <span class="cm-number">0</span>.0009531 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.182<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.759: Application time: <span class="cm-number">1</span>.9228829 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.190<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.767: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0079957 seconds, Stopping threads took: <span class="cm-number">0</span>.0009701 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.190<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.767: Application time: <span class="cm-number">0</span>.0002209 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.195<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.772: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0047948 seconds, Stopping threads took: <span class="cm-number">0</span>.0003450 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.195<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.772: Application time: <span class="cm-number">0</span>.0003185 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.199<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.776: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0038102 seconds, Stopping threads took: <span class="cm-number">0</span>.0002901 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.200<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.776: Application time: <span class="cm-number">0</span>.0004269 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.203<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.780: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0036949 seconds, Stopping threads took: <span class="cm-number">0</span>.0003017 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.204<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.780: Application time: <span class="cm-number">0</span>.0003345 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.207<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.784: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0037270 seconds, Stopping threads took: <span class="cm-number">0</span>.0002750 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.208<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.784: Application time: <span class="cm-number">0</span>.0002432 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.211<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.788: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0034454 seconds, Stopping threads took: <span class="cm-number">0</span>.0002974 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.211<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.788: Application time: <span class="cm-number">0</span>.0002809 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.215<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.792: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0034799 seconds, Stopping threads took: <span class="cm-number">0</span>.0003126 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.215<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.792: Application time: <span class="cm-number">0</span>.0001971 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.218<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.795: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0033639 seconds, Stopping threads took: <span class="cm-number">0</span>.0002907 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.219<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.795: Application time: <span class="cm-number">0</span>.0002002 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.222<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.799: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0034734 seconds, Stopping threads took: <span class="cm-number">0</span>.0002560 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.223<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.799: Application time: <span class="cm-number">0</span>.0004148 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.230<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.807: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0078923 seconds, Stopping threads took: <span class="cm-number">0</span>.0007479 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.231<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.807: Application time: <span class="cm-number">0</span>.0002697 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.239<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.816: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0080425 seconds, Stopping threads took: <span class="cm-number">0</span>.0005797 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.239<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.816: Application time: <span class="cm-number">0</span>.0004746 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.247<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.824: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0081480 seconds, Stopping threads took: <span class="cm-number">0</span>.0005586 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.248<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.824: Application time: <span class="cm-number">0</span>.0002206 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.255<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.832: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0077953 seconds, Stopping threads took: <span class="cm-number">0</span>.0003357 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.256<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.833: Application time: <span class="cm-number">0</span>.0004123 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.263<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.840: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0075859 seconds, Stopping threads took: <span class="cm-number">0</span>.0004447 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.264<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.840: Application time: <span class="cm-number">0</span>.0001576 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.271<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.847: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0070406 seconds, Stopping threads took: <span class="cm-number">0</span>.0003025 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.271<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.848: Application time: <span class="cm-number">0</span>.0003462 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.278<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.855: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0071142 seconds, Stopping threads took: <span class="cm-number">0</span>.0004311 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.278<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.855: Application time: <span class="cm-number">0</span>.0001479 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.285<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.862: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0071285 seconds, Stopping threads took: <span class="cm-number">0</span>.0003712 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.287<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.864: Application time: <span class="cm-number">0</span>.0018179 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.295<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.872: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0075329 seconds, Stopping threads took: <span class="cm-number">0</span>.0005250 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.296<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.872: Application time: <span class="cm-number">0</span>.0008192 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.303<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.880: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0072368 seconds, Stopping threads took: <span class="cm-number">0</span>.0002966 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.303<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.880: Application time: <span class="cm-number">0</span>.0006276 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:29:39.324<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78145</span>.901: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0202434 seconds, Stopping threads took: <span class="cm-number">0</span>.0002417 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:04.065<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78170</span>.642: Application time: <span class="cm-number">24</span>.7410815 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:04.073<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78170</span>.650: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0082734 seconds, Stopping threads took: <span class="cm-number">0</span>.0009748 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.002<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.578: Application time: <span class="cm-number">9</span>.9284404 seconds</span></span></pre>
</div>
</div>
</div>
<h4 id="yFv5d" data-lake-id="a7122d8d63e4cbd9e3441d4b01963e1f">MIXGC混合GC阶段</h4>
<p data-lake-id="3bb7e2e512755dd1631dda9667a66995">G1中的MIXGC选定所有新生代里的Region，外加根据global concurrent marking统计得出收集收益高的若干老年代Region，在用户指定的开销目标范围内尽可能选择收益高的老年代Region进行回收。所以MIXGC回收的内存区域是新生代+老年代</p>
<h4 id="ymvMf" data-lake-id="8624c1293c13bbe78bc1c05750a95007">FullGC</h4>
<p data-lake-id="06be1af386281321031577d50e4c42d0">G1一般不会发生FullGC，如果发生了，基本上就是有灾难了.</p>
<p data-lake-id="f720229fe302ae296b1013186887f94a"><a href="https://zhuanlan.zhihu.com/p/52841787" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/52841787</a></p>
<h3 id="RSo39" data-lake-id="66c7ba5c0bf76b88efb1e763d6bb7441">G1日志分析</h3>
<p data-lake-id="61ee6ee6fafd528107b991284246c54d">引用: g1日志格式分析 ：<a href="https://segmentfault.com/a/1190000018885417" target="_blank" rel="noopener">https://segmentfault.com/a/1190000018885417</a></p>
<p data-lake-id="014603d9e0a61e3760977f6446d3a8d4"><a href="https://matt33.com/2018/07/28/jvm-cms/" target="_blank" rel="noopener">https://matt33.com/2018/07/28/jvm-cms/</a></p>
<p data-lake-id="d17d0cd8f3296aa6125e97b8dd0ddc00">我们通过jvm的参数，打开gc日志详情,我们可以看到，出问题的时间点的日志如下:</p>
<div id="7CCPt" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-07-28T18%3A30%3A14.107%2B0800%3A%2078180.684%3A%20%5BGC%20concurrent-root-region-scan-start%5D%5Cn2020-07-28T18%3A30%3A14.108%2B0800%3A%2078180.685%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.1065961%20seconds%2C%20Stopping%20threads%20took%3A%200.0010147%20seconds%5Cn2020-07-28T18%3A30%3A14.223%2B0800%3A%2078180.800%3A%20%5BGC%20concurrent-root-region-scan-end%2C%200.1157296%20secs%5D%5Cn2020-07-28T18%3A30%3A14.223%2B0800%3A%2078180.800%3A%20%5BGC%20concurrent-mark-start%5D%5Cn2020-07-28T18%3A30%3A15.297%2B0800%3A%2078181.873%3A%20%5BGC%20concurrent-mark-end%2C%201.0732893%20secs%5D%5Cn2020-07-28T18%3A30%3A15.297%2B0800%3A%2078181.873%3A%20Application%20time%3A%201.1884735%20seconds%5Cn2020-07-28T18%3A30%3A15.304%2B0800%3A%2078181.881%3A%20%5BGC%20remark%202020-07-28T18%3A30%3A15.304%2B0800%3A%2078181.881%3A%20%5BFinalize%20Marking%2C%200.0042761%20secs%5D%202020-07-28T18%3A30%3A15.309%2B0800%3A%2078181.885%3A%20%5BGC%20ref-proc2020-07-28T18%3A30%3A15.309%2B0800%3A%2078181.885%3A%20%5BSoftReference%2C%20434351%20refs%2C%200.0672266%20secs%5D2020-07-28T18%3A30%3A15.376%2B0800%3A%2078181.953%3A%20%5BWeakReference%2C%20376%20refs%2C%200.0004634%20secs%5D2020-07-28T18%3A30%3A15.376%2B0800%3A%2078181.953%3A%20%5BFinalReference%2C%20435363%20refs%2C%200.3004894%20secs%5D2020-07-28T18%3A30%3A15.677%2B0800%3A%2078182.254%3A%20%5BPhantomReference%2C%200%20refs%2C%20331%20refs%2C%200.0009668%20secs%5D2020-07-28T18%3A30%3A15.678%2B0800%3A%2078182.255%3A%20%5BJNI%20Weak%20Reference%2C%200.0002237%20secs%5D%2C%200.4895046%20secs%5D%202020-07-28T18%3A30%3A15.798%2B0800%3A%2078182.375%3A%20%5BUnloading%2C%200.0347793%20secs%5D%2C%200.5384580%20secs%5D%5Cn%20%5BTimes%3A%20user%3D1.65%20sys%3D0.24%2C%20real%3D0.54%20secs%5D%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%227CCPt%22%2C%22height%22%3A230%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.107<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.684: [GC concurrent-root-region-scan-start]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.108<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.685: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.1065961 seconds, Stopping threads took: <span class="cm-number">0</span>.0010147 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.223<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.800: [GC concurrent-root-region-scan-end, <span class="cm-number">0</span>.1157296 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.223<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.800: [GC concurrent-mark-start]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.297<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.873: [GC concurrent-mark-end, <span class="cm-number">1</span>.0732893 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.297<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.873: Application time: <span class="cm-number">1</span>.1884735 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.304<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.881: [GC remark <span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.304<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.881: [Finalize Marking, <span class="cm-number">0</span>.0042761 secs] <span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.309<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.885: [GC ref-proc2020-07-28T18:30:15.309<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.885: [SoftReference, <span class="cm-number">434351</span> refs, <span class="cm-number">0</span>.0672266 secs]2020-07-28T18:30:15.376<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.953: [WeakReference, <span class="cm-number">376</span> refs, <span class="cm-number">0</span>.0004634 secs]2020-07-28T18:30:15.376<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.953: [FinalReference, <span class="cm-number">435363</span> refs, <span class="cm-number">0</span>.3004894 secs]2020-07-28T18:30:15.677<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78182</span>.254: [PhantomReference, <span class="cm-number">0</span> refs, <span class="cm-number">331</span> refs, <span class="cm-number">0</span>.0009668 secs]2020-07-28T18:30:15.678<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78182</span>.255: [JNI Weak Reference, <span class="cm-number">0</span>.0002237 secs], <span class="cm-number">0</span>.4895046 secs] <span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.798<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78182</span>.375: [Unloading, <span class="cm-number">0</span>.0347793 secs], <span class="cm-number">0</span>.5384580 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> [Times: <span class="cm-def">user</span><span class="cm-operator">=</span><span class="cm-number">1</span>.65 <span class="cm-def">sys</span><span class="cm-operator">=</span><span class="cm-number">0</span>.24, <span class="cm-def">real</span><span class="cm-operator">=</span><span class="cm-number">0</span>.54 secs]</span></span></pre>
</div>
</div>
</div>
<p data-lake-id="e6b4747013c989366490dcbcff4549b2">我们看到GC ref-proc这个阶段耗时很长，这个是个stop the world的过程，再看看 FinalReference居然有40多万，平时是6万多(也不少)</p>
<p data-lake-id="fc3e553b94b2d4b8012db4c118e6dbe2">再来学习下这个并发标记是什么意思.</p>
<h4 id="ab01eebf" data-lake-id="cf32c95e8e0a647ebca41bd9190ad1d3">认识全局并发标记</h4>
<p data-lake-id="942d75b9fb466931476ce6d0ff184e06">全局并发标记过程分为五个阶段</p>
<p data-lake-id="6cd3ca540e34760ffd620b0735d6f8c7">(1) Initial Mark初始标记 STW</p>
<p data-lake-id="7951e7b90d468bf7d35d38f6e02f4372">Initial Mark初始标记是一个STW事件，其完成工作是标记GC ROOTS 直接可达的对象。并将它们的字段压入扫描栈（marking stack）中等到后续扫描。G1使用外部的bitmap来记录mark信息，而不使用对象头的mark word里的mark bit。因为 STW，所以通常YGC的时候借用YGC的STW顺便启动Initial Mark，也就是启动全局并发标记，全局并发标记与YGC在逻辑上独立。</p>
<p data-lake-id="55b2bd1448449b57ca62ad9c55af065b">(2)Root Region Scanning 根区域扫描</p>
<p data-lake-id="4428c8dc679bb57a2ed2a5f78757c07a">根区域扫描是从Survior区的对象出发，标记被引用到老年代中的对象，并把它们的字段在压入扫描栈（marking stack）中等到后续扫描。与Initial Mark不一样的是，Root Region Scanning不需要STW与应用程序是并发运行。Root Region Scanning必须在YGC开始前完成。</p>
<p data-lake-id="4649162dd632e9b388c5f7f511524ace">(3)Concurrent Marking 并发标记</p>
<p data-lake-id="1f48202c4059eb7c7c8046821f618e16">不需要STW。不断从扫描栈取出引用递归扫描整个堆里的对象。每扫描到一个对象就会对其标记，并将其字段压入扫描栈。重复扫描过程直到扫描栈清空。过程中还会扫描SATB write barrier所记录下的引用。Concurrent Marking 可以被YGC中断</p>
<p data-lake-id="950c410d3f7afe2684461a3f6c268332">就是日志这里的内容:</p>
<div id="HE47y" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-07-28T18%3A30%3A14.107%2B0800%3A%2078180.684%3A%20%5BGC%20concurrent-root-region-scan-start%5D%5Cn2020-07-28T18%3A30%3A14.108%2B0800%3A%2078180.685%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.1065961%20seconds%2C%20Stopping%20threads%20took%3A%200.0010147%20seconds%5Cn2020-07-28T18%3A30%3A14.223%2B0800%3A%2078180.800%3A%20%5BGC%20concurrent-root-region-scan-end%2C%200.1157296%20secs%5D%5Cn2020-07-28T18%3A30%3A14.223%2B0800%3A%2078180.800%3A%20%5BGC%20concurrent-mark-start%5D%5Cn2020-07-28T18%3A30%3A15.297%2B0800%3A%2078181.873%3A%20%5BGC%20concurrent-mark-end%2C%201.0732893%20secs%5D%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%22HE47y%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.107<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.684: [GC concurrent-root-region-scan-start]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.108<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.685: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.1065961 seconds, Stopping threads took: <span class="cm-number">0</span>.0010147 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.223<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.800: [GC concurrent-root-region-scan-end, <span class="cm-number">0</span>.1157296 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:14.223<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78180</span>.800: [GC concurrent-mark-start]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.297<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.873: [GC concurrent-mark-end, <span class="cm-number">1</span>.0732893 secs]</span></span></pre>
</div>
</div>
</div>
<p data-lake-id="6ca4618527b765da705dc98e9b8b72d2">(4)Remark 最终标记 STW</p>
<p data-lake-id="7c79f903d97c1f76f1bd488dbeaad587">STW操作。在完成并发标记后，每个Java线程还会有一些剩下的SATB write barrier记录的引用尚未处理。这个阶段就负责把剩下的引用处理完。同时这个阶段也进行弱引用处理（reference processing）。注意这个暂停与CMS的remark有一个本质上的区别，那就是这个暂停只需要扫描SATB buffer，而CMS的remark需要重新扫描mod-union table里的dirty card外加整个根集合，而此时整个young gen（不管对象死活）都会被当作根集合的一部分，因而CMS remark有可能会非常慢。</p>
<p data-lake-id="606be955cc69b2fb6eb3451214417e2b">就是出问题的地方</p>
<div id="8hSO9" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-07-28T18%3A30%3A15.304%2B0800%3A%2078181.881%3A%20%5BGC%20remark%202020-07-28T18%3A30%3A15.304%2B0800%3A%2078181.881%3A%20%5BFinalize%20Marking%2C%200.0042761%20secs%5D%202020-07-28T18%3A30%3A15.309%2B0800%3A%2078181.885%3A%20%5BGC%20ref-proc2020-07-28T18%3A30%3A15.309%2B0800%3A%2078181.885%3A%20%5BSoftReference%2C%20434351%20refs%2C%200.0672266%20secs%5D2020-07-28T18%3A30%3A15.376%2B0800%3A%2078181.953%3A%20%5BWeakReference%2C%20376%20refs%2C%200.0004634%20secs%5D2020-07-28T18%3A30%3A15.376%2B0800%3A%2078181.953%3A%20%5BFinalReference%2C%20435363%20refs%2C%200.3004894%20secs%5D2020-07-28T18%3A30%3A15.677%2B0800%3A%2078182.254%3A%20%5BPhantomReference%2C%200%20refs%2C%20331%20refs%2C%200.0009668%20secs%5D2020-07-28T18%3A30%3A15.678%2B0800%3A%2078182.255%3A%20%5BJNI%20Weak%20Reference%2C%200.0002237%20secs%5D%2C%200.4895046%20secs%5D%202020-07-28T18%3A30%3A15.798%2B0800%3A%2078182.375%3A%20%5BUnloading%2C%200.0347793%20secs%5D%2C%200.5384580%20secs%5D%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%228hSO9%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.304<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.881: [GC remark <span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.304<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.881: [Finalize Marking, <span class="cm-number">0</span>.0042761 secs] <span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.309<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.885: [GC ref-proc2020-07-28T18:30:15.309<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.885: [SoftReference, <span class="cm-number">434351</span> refs, <span class="cm-number">0</span>.0672266 secs]2020-07-28T18:30:15.376<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.953: [WeakReference, <span class="cm-number">376</span> refs, <span class="cm-number">0</span>.0004634 secs]2020-07-28T18:30:15.376<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78181</span>.953: [FinalReference, <span class="cm-number">435363</span> refs, <span class="cm-number">0</span>.3004894 secs]2020-07-28T18:30:15.677<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78182</span>.254: [PhantomReference, <span class="cm-number">0</span> refs, <span class="cm-number">331</span> refs, <span class="cm-number">0</span>.0009668 secs]2020-07-28T18:30:15.678<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78182</span>.255: [JNI Weak Reference, <span class="cm-number">0</span>.0002237 secs], <span class="cm-number">0</span>.4895046 secs] <span class="cm-number">2020</span><span class="cm-attribute">-07</span><span class="cm-attribute">-28T18</span>:30:15.798<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">78182</span>.375: [Unloading, <span class="cm-number">0</span>.0347793 secs], <span class="cm-number">0</span>.5384580 secs]</span></span></pre>
</div>
</div>
</div>
<p data-lake-id="2c1329c18125ecd556f4190497feb8b5">(5)Cleanup 清除 STW AND<em> Concurrent</em></p>
<p data-lake-id="c3bdcc667c9af3026dd25e7362502540">STW操作，清点出有存活对象的Region和没有存活对象的Region(Empty Region)</p>
<p data-lake-id="3c8e180eac9dd9b4f9a3df70d429bfb3">STW操作，更新Rset</p>
<p data-lake-id="cbfa4abe0d5feb3b8fe03b27bb8fa6a2">通过以上分析我们基本上断定了，就是因为并发FinalReference太多了，导致标记的时候，花费了很长的时间，造成了应用的暂停和抖动。</p>
<p data-lake-id="89d0a79afe6125f3435293248b6451ed">定位到这个问题之后，就尝试着去分析，为啥会有这么多的FinalReference这玩意儿呢? 能不能减少呢？</p>
<h2 id="wSv76" data-lake-id="a7fea7d2bbfcbf3b705bdc9d0827d183">heap分析</h2>
<p data-lake-id="02da64d0730e3438a4ecae1ca7838bb9">通过jmap -dump:format=b,file=heapdump.phrof 把生产的内存区下载下来之后，再去分析，也没发现什么有用的信息, 果然是发现这个东西很多<span class="lake-card-margin-top lake-card-margin-bottom lake-selected" data-card-type="inline" data-lake-card="image" data-card-value="data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2020%2Fpng%2F180554%2F1599556958375-49d136b6-f770-42ff-8123-9699b67ed521.png%22%2C%22originWidth%22%3A912%2C%22originHeight%22%3A359%2C%22name%22%3A%22image.png%22%2C%22size%22%3A232806%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A98.65999%2C%22y%22%3A17.615725%2C%22width%22%3A88.13296%2C%22height%22%3A12.299191999999998%2C%22text%22%3A%22dominatortree%22%7D%2C%7B%22x%22%3A27.516315%2C%22y%22%3A18.118801%2C%22width%22%3A50.625745%2C%22height%22%3A11.574691999999999%2C%22text%22%3A%22Overview%22%7D%2C%7B%22x%22%3A7.26933%2C%22y%22%3A36.5102%2C%22width%22%3A62.26341000000001%2C%22height%22%3A11.412957000000006%2C%22text%22%3A%22ClassName%22%7D%2C%7B%22x%22%3A520.552%2C%22y%22%3A36.591743%2C%22width%22%3A71.22500000000002%2C%22height%22%3A10.918877000000002%2C%22text%22%3A%22ShallowHeap%22%7D%2C%7B%22x%22%3A608.4108%2C%22y%22%3A36.79788%2C%22width%22%3A91.47850000000005%2C%22height%22%3A10.324826999999999%2C%22text%22%3A%22RetainedHeap%22%7D%2C%7B%22x%22%3A728.1165%2C%22y%22%3A36.96813%2C%22width%22%3A61.76819999999998%2C%22height%22%3A10.834209999999999%2C%22text%22%3A%22Percentage%22%7D%2C%7B%22x%22%3A731.2339%2C%22y%22%3A54.12503%2C%22width%22%3A55.549800000000005%2C%22height%22%3A10.406600000000005%2C%22text%22%3A%22%3CNumeric%3E%22%7D%2C%7B%22x%22%3A638.754%2C%22y%22%3A54.17504%2C%22width%22%3A58.90649999999994%2C%22height%22%3A10.595869999999998%2C%22text%22%3A%22%3CNumeric%3E%22%7D%2C%7B%22x%22%3A533.41034%2C%22y%22%3A54.333603%2C%22width%22%3A56.445659999999975%2C%22height%22%3A10.044077000000001%2C%22text%22%3A%22%3CNumeric%3E%22%7D%2C%7B%22x%22%3A753.1623%2C%22y%22%3A70.044075%2C%22width%22%3A34.38040000000001%2C%22height%22%3A10.87013499999999%2C%22text%22%3A%223.06%25%22%7D%2C%7B%22x%22%3A635.1424%2C%22y%22%3A70.47033%2C%22width%22%3A64.14020000000005%2C%22height%22%3A10.84836%2C%22text%22%3A%2225%2C756%2C040%22%7D%2C%7B%22x%22%3A38.61448%2C%22y%22%3A71.89185%2C%22width%22%3A283.56482%2C%22height%22%3A11.598279999999988%2C%22text%22%3A%22classjava.langinlizx7%22%7D%2C%7B%22x%22%3A316.52676%2C%22y%22%3A72.36007%2C%22width%22%3A40.63092%2C%22height%22%3A11.041070000000005%2C%22text%22%3A%22nclass%22%7D%2C%7B%22x%22%3A754.00287%2C%22y%22%3A86.566185%2C%22width%22%3A34.65258999999992%2C%22height%22%3A11.382114999999999%2C%22text%22%3A%223.06%25%22%7D%2C%7B%22x%22%3A633.82275%2C%22y%22%3A86.9225%2C%22width%22%3A65.87365%2C%22height%22%3A11.412000000000006%2C%22text%22%3A%2225%2C756%2C008%22%7D%2C%7B%22x%22%3A47.33805%2C%22y%22%3A88.52634%2C%22width%22%3A214.26205%2C%22height%22%3A10.81783%2C%22text%22%3A%22java.lang.ref.Finalizer%40x6c63dabc8%22%7D%2C%7B%22x%22%3A576.1451%2C%22y%22%3A99.123634%2C%22width%22%3A17.622600000000034%2C%22height%22%3A17.622600000000034%2C%22text%22%3A%228%22%7D%2C%7B%22x%22%3A754.89966%2C%22y%22%3A103.34179%2C%22width%22%3A33.22863999999993%2C%22height%22%3A10.976579999999998%2C%22text%22%3A%223.06%25%22%7D%2C%7B%22x%22%3A634.2653%2C%22y%22%3A104.63223%2C%22width%22%3A64.1137%2C%22height%22%3A11.056929999999994%2C%22text%22%3A%2225%2C755%2C968%22%7D%2C%7B%22x%22%3A78.476555%2C%22y%22%3A106.23136%2C%22width%22%3A200.68451499999998%2C%22height%22%3A11.506906%2C%22text%22%3A%22java.langref.Finalize%40ox6c63da9c8%22%7D%2C%7B%22x%22%3A754.3249%2C%22y%22%3A120.64545%2C%22width%22%3A33.33140000000003%2C%22height%22%3A10.500240000000005%2C%22text%22%3A%223%2C06%25%22%7D%2C%7B%22x%22%3A634.4754%2C%22y%22%3A121.4482%2C%22width%22%3A63.74860000000001%2C%22height%22%3A11.470600000000005%2C%22text%22%3A%2225%2C755%2C928%22%7D%2C%7B%22x%22%3A89.96585%2C%22y%22%3A121.797226%2C%22width%22%3A206.26274999999998%2C%22height%22%3A13.092714%2C%22text%22%3A%22java.lang.ret.Finalize%40ox6c6179a70%22%7D%2C%7B%22x%22%3A754.20526%2C%22y%22%3A137.74982%2C%22width%22%3A34.170240000000035%2C%22height%22%3A11.383510000000001%2C%22text%22%3A%223.06%25%22%7D%2C%7B%22x%22%3A633.493%2C%22y%22%3A138.36172%2C%22width%22%3A65.0435%2C%22height%22%3A11.534230000000008%2C%22text%22%3A%2225%2C755%2C888%22%7D%2C%7B%22x%22%3A102.948715%2C%22y%22%3A138.3827%2C%22width%22%3A207.09040500000003%2C%22height%22%3A13.38678999999999%2C%22text%22%3A%22javalang.ret.Finalizer%40x6c63da7c8%22%7D%2C%7B%22x%22%3A753.6116%2C%22y%22%3A154.59015%2C%22width%22%3A36.554700000000025%2C%22height%22%3A13.079740000000015%2C%22text%22%3A%223.06%25%22%7D%2C%7B%22x%22%3A632.8418%2C%22y%22%3A155.15968%2C%22width%22%3A67.27850000000001%2C%22height%22%3A12.508499999999998%2C%22text%22%3A%2225%2C755%2C336%22%7D%2C%7B%22x%22%3A120.776825%2C%22y%22%3A154.85799%2C%22width%22%3A203.32522500000002%2C%22height%22%3A13.42828%2C%22text%22%3A%22java.lang.re.Finalizor%40Ox6c63da5c8%22%7D%2C%7B%22x%22%3A753.8039%2C%22y%22%3A171.33548%2C%22width%22%3A36.490999999999985%2C%22height%22%3A12.777860000000004%2C%22text%22%3A%220.00%25%22%7D%2C%7B%22x%22%3A122.21285%2C%22y%22%3A171.53555%2C%22width%22%3A225.61890999999997%2C%22height%22%3A13.120200000000011%2C%22text%22%3A%22javanet.SocksSocketImpl%40Ox6c63da758%22%7D%2C%7B%22x%22%3A571.18494%2C%22y%22%3A171.89272%2C%22width%22%3A22.795709999999985%2C%22height%22%3A12.303809999999999%2C%22text%22%3A%22112%22%7D%2C%7B%22x%22%3A676.18787%2C%22y%22%3A172.83818%2C%22width%22%3A24.269430000000057%2C%22height%22%3A11.186049999999994%2C%22text%22%3A%22512%22%7D%2C%7B%22x%22%3A114.40913%2C%22y%22%3A188.89816%2C%22width%22%3A93.98047%2C%22height%22%3A11.920110000000022%2C%22text%22%3A%22Total%3A2entries%22%7D%2C%7B%22x%22%3A753.114%2C%22y%22%3A204.25812%2C%22width%22%3A34.71943999999996%2C%22height%22%3A13.262720000000002%2C%22text%22%3A%220.00%25%22%7D%2C%7B%22x%22%3A577.5196%2C%22y%22%3A205.18141%2C%22width%22%3A13.742799999999988%2C%22height%22%3A11.931610000000006%2C%22text%22%3A%2216%22%7D%2C%7B%22x%22%3A684.1707%2C%22y%22%3A205.39677%2C%22width%22%3A14.157240000000002%2C%22height%22%3A12.867159999999984%2C%22text%22%3A%2216%22%7D%2C%7B%22x%22%3A53.721397%2C%22y%22%3A205.6704%2C%22width%22%3A183.484263%2C%22height%22%3A14.940120000000007%2C%22text%22%3A%22java.lang.obiject%40Ox5400a2b3o%22%7D%2C%7B%22x%22%3A42.402977%2C%22y%22%3A220.42873%2C%22width%22%3A113.137493%2C%22height%22%3A16.22398000000001%2C%22text%22%3A%22TOTAL%3A2CNtrIES%22%7D%2C%7B%22x%22%3A755.92896%2C%22y%22%3A239.27107%2C%22width%22%3A33.49724000000003%2C%22height%22%3A12.36042999999998%2C%22text%22%3A%221.58%25%22%7D%2C%7B%22x%22%3A635.9074%2C%22y%22%3A239.31331%2C%22width%22%3A63.12489999999991%2C%22height%22%3A12.83323999999999%2C%22text%22%3A%2213%2C294%2C640%22%7D%2C%7B%22x%22%3A572.6236%2C%22y%22%3A240.29793%2C%22width%22%3A19.15809999999999%2C%22height%22%3A10.816270000000003%2C%22text%22%3A%22128%22%7D%2C%7B%22x%22%3A38.92121%2C%22y%22%3A239.42406%2C%22width%22%3A467.70754%2C%22height%22%3A16.888809999999978%2C%22text%22%3A%22og.springtramework.contextanaton.nacocacoe%22%7D%2C%7B%22x%22%3A754.67224%2C%22y%22%3A256.10248%2C%22width%22%3A34.27326000000005%2C%22height%22%3A11.639819999999986%2C%22text%22%3A%220.80%25%22%7D%2C%7B%22x%22%3A640.46594%2C%22y%22%3A256.44992%2C%22width%22%3A58.361209999999915%2C%22height%22%3A12.333010000000002%2C%22text%22%3A%226%2C698%2C960%22%7D%2C%7B%22x%22%3A38.95774%2C%22y%22%3A257.78708%2C%22width%22%3A293.5751%2C%22height%22%3A14.118819999999971%2C%22text%22%3A%22sun.misc.LauchrsAppclassLoader%40ox540000000%22%7D%2C%7B%22x%22%3A642.38275%2C%22y%22%3A273.43124%2C%22width%22%3A55.83869000000004%2C%22height%22%3A12.48529000000002%2C%22text%22%3A%221%2C418%2C824%22%7D%2C%7B%22x%22%3A754.52356%2C%22y%22%3A273.45502%2C%22width%22%3A34.1087%2C%22height%22%3A11.57763%2C%22text%22%3A%220.17%25%22%7D%2C%7B%22x%22%3A577.6854%2C%22y%22%3A273.5149%2C%22width%22%3A12.979150000000004%2C%22height%22%3A12.194479999999999%2C%22text%22%3A%2280%22%7D%2C%7B%22x%22%3A40.23149%2C%22y%22%3A273.59384%2C%22width%22%3A279.84139%2C%22height%22%3A15.716340000000002%2C%22text%22%3A%22sun.net.www.protocoljarURLJarFil%40Ox5409f0cf8%22%7D%2C%7B%22x%22%3A642.4233%2C%22y%22%3A290.6466%2C%22width%22%3A55.51816999999994%2C%22height%22%3A12.379580000000033%2C%22text%22%3A%221%2C389%2C656%22%7D%2C%7B%22x%22%3A755.29034%2C%22y%22%3A290.90332%2C%22width%22%3A32.61761999999999%2C%22height%22%3A10.677399999999977%2C%22text%22%3A%220.17%25%22%7D%2C%7B%22x%22%3A39.931904%2C%22y%22%3A291.38345%2C%22width%22%3A201.816016%2C%22height%22%3A14.12360000000001%2C%22text%22%3A%22java.util.jarJarFile%40Ox540618co%22%7D%2C%7B%22x%22%3A40.78678%2C%22y%22%3A305.96628%2C%22width%22%3A341.62257999999997%2C%22height%22%3A15.75305000000003%2C%22text%22%3A%22com.fasterxmljackson.databind.ObjctMapper0x542600390%22%7D%2C%7B%22x%22%3A577.0516%2C%22y%22%3A307.34702%2C%22width%22%3A14.028999999999996%2C%22height%22%3A12.889479999999992%2C%22text%22%3A%2264%22%7D%2C%7B%22x%22%3A645.1148%2C%22y%22%3A307.37213%2C%22width%22%3A53.332340000000045%2C%22height%22%3A12.552949999999953%2C%22text%22%3A%221%2C0835%22%7D%2C%7B%22x%22%3A754.6296%2C%22y%22%3A307.89584%2C%22width%22%3A34.15055000000007%2C%22height%22%3A11.029729999999972%2C%22text%22%3A%220.12%25%22%7D%2C%7B%22x%22%3A650.8912%2C%22y%22%3A325.37177%2C%22width%22%3A48.24563999999998%2C%22height%22%3A10.829729999999984%2C%22text%22%3A%22901%2C816%22%7D%2C%7B%22x%22%3A39.72683%2C%22y%22%3A323.745%2C%22width%22%3A339.53129%2C%22height%22%3A15.29113000000001%2C%22text%22%3A%22org.apache.http.co.uliuihx0290%22%7D%2C%7B%22x%22%3A753.80536%2C%22y%22%3A325.56653%2C%22width%22%3A35.55749000000003%2C%22height%22%3A9.940920000000006%2C%22text%22%3A%220.11%25%22%7D%2C%7B%22x%22%3A571.0014%2C%22y%22%3A341.94644%2C%22width%22%3A22.173599999999965%2C%22height%22%3A12.032989999999984%2C%22text%22%3A%22120%22%7D%2C%7B%22x%22%3A651.6472%2C%22y%22%3A341.96573%2C%22width%22%3A47.245559999999955%2C%22height%22%3A11.490139999999997%2C%22text%22%3A%22842%2C552%22%7D%2C%7B%22x%22%3A753.2987%2C%22y%22%3A342.33893%2C%22width%22%3A34.918499999999995%2C%22height%22%3A10.833340000000021%2C%22text%22%3A%220.10%25%22%7D%2C%7B%22x%22%3A39.10348%2C%22y%22%3A343.21628%2C%22width%22%3A468.13105%2C%22height%22%3A12.831389999999999%2C%22text%22%3A%22juvalbng.th%3A%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22dominatortree%20Overview%20ClassName%20ShallowHeap%20RetainedHeap%20Percentage%20%3CNumeric%3E%20%3CNumeric%3E%20%3CNumeric%3E%203.06%25%2025%2C756%2C040%20classjava.langinlizx7%20nclass%203.06%25%2025%2C756%2C008%20java.lang.ref.Finalizer%40x6c63dabc8%208%203.06%25%2025%2C755%2C968%20java.langref.Finalize%40ox6c63da9c8%203%2C06%25%2025%2C755%2C928%20java.lang.ret.Finalize%40ox6c6179a70%203.06%25%2025%2C755%2C888%20javalang.ret.Finalizer%40x6c63da7c8%203.06%25%2025%2C755%2C336%20java.lang.re.Finalizor%40Ox6c63da5c8%200.00%25%20javanet.SocksSocketImpl%40Ox6c63da758%20112%20512%20Total%3A2entries%200.00%25%2016%2016%20java.lang.obiject%40Ox5400a2b3o%20TOTAL%3A2CNtrIES%201.58%25%2013%2C294%2C640%20128%20og.springtramework.contextanaton.nacocacoe%200.80%25%206%2C698%2C960%20sun.misc.LauchrsAppclassLoader%40ox540000000%201%2C418%2C824%200.17%25%2080%20sun.net.www.protocoljarURLJarFil%40Ox5409f0cf8%201%2C389%2C656%200.17%25%20java.util.jarJarFile%40Ox540618co%20com.fasterxmljackson.databind.ObjctMapper0x542600390%2064%201%2C0835%200.12%25%20901%2C816%20org.apache.http.co.uliuihx0290%200.11%25%20120%20842%2C552%200.10%25%20juvalbng.th%3A%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A912%2C%22height%22%3A359%7D"><img class="image lake-drag-image" title="image.png" src="https://cdn.nlark.com/yuque/0/2020/png/180554/1599556958375-49d136b6-f770-42ff-8123-9699b67ed521.png" alt="image.png" data-role="image" data-raw-src="" data-height="359px"></span>, 看起来依然是跟SocksSocketImpl有关系</p>
<h2 id="efb2e858" data-lake-id="0288b39dd6bdbcd5a381f386d7e9f794">问题定位</h2>
<h3 id="jNN10" data-lake-id="64679c38b059277a46dfcfcd2b52bea1">查找new SocksSoketImpl()的来源</h3>
<p data-lake-id="697850ec7b5e599b4e2d62e9d03cbd7e">我们看看为什么会有这么多java.net.SocksSoketImpl呢？通过以前的手段，我们继续使用阿尔萨斯来定位。通过监控SocksSoketImpl的构造方法，我们发现不断的被创建新的连接。</p>
<h4 id="e71de7df" data-lake-id="57b1787c0a6e0b1f0c0ce03ba0de2e60">尝试1: 关闭JMX收集</h4>
<p data-lake-id="fe84c2e257280b05120cfcfb4dd408d4">我们发现不少的连接是来自JMX的信息收集，我先把这个关闭了看看，结果并没有任何改观</p>
<h4 id="ebfd4a5a" data-lake-id="399c82649e65cde6a4f92863a0666f1a">尝试2: httpclient的短连接问题?</h4>
<p data-lake-id="006a3b025aa2086108231b7bb7899e57">开始试着查找为什么不断的new 新的连接呢？是不是连接未能复用呢?网上很多人也遇到了同样的问题，很多是因为错误的使用了短连接造成的。</p>
<p data-lake-id="570983ffd7800dbaf10e01295780d343">我开始质疑是不是公司的中间件有问题。公司的httpclient统一使用的是中间件封装的一层，目的是为了便于统计和跟踪。在本地测试的时候，发现连接是能够保持的。是不是生产网络的连接无法保持呢？</p>
<h4 id="sBaZY" data-lake-id="33b2ea7772707a65a27831c06051d85f">搞清楚httpclient,调整httpclient连接池参数</h4>
<p data-lake-id="a2d3b179ea744aec618fb4fd03a94277">我们内部调用http的服务，一般是这么调的</p>
<p data-lake-id="ff60ae60dab40ca8444a93d4b5b75eb5">JSONObject obj = restTemplate.getForObject(realUrl, JSONObject.class);</p>
<p data-lake-id="4229f497eb212b309b1eb6d092578040">这个其实是spring给你封装的一个模板方法，大大的减少了使用httpclient的成本。还记得以前使用httpclient都会自己封装一层，使用连接池，使用idle线程踢出不再使用的线程等等。</p>
<p data-lake-id="01a8b2bb6f7804af944b8570103dd258">而公司的中间利用的是模板方法里提供的插入自己逻辑的机会，增加了埋点。另外就是把配置暴露到application.yml里给你可以配置。</p>
<h4 id="tN4nA" data-lake-id="664ce334adc07bcc2520859513441485">PoolingHttpClientConnectionManager的分析</h4>
<p data-lake-id="6b92c904d710acc1c6b6faa49649b461">去爬了一遍PoolingHttpClientConnectionManager的源代码，了解下连接池管理这一段，去找找到底为什么连接无法保持呢?分析的过程如下</p>
<p data-lake-id="70b6d1e1a4b7fb9949caeaed9c839314">涉及的类</p>
<p data-lake-id="4856b14d635d54980e689f12131e134c">CPoolEntry: Pool的一个单元，包含了route信息和connect的连接</p>
<p data-lake-id="5c3622c2f3e240a4d055e0b8e60431f9">Cpool: lease 尝试去租用一个连接, 此方法会获取一个Future的对象.</p>
<p data-lake-id="5a4e6c1b9e3d5b5b41751a72e81c40c4">Future<CPoolEntry> 具体的能力是无阻塞的获取一个Pool单元.</p>
<p data-lake-id="ace73116b83359b2c0960670a116c345">那么这个Future是怎么获取连接的，调用他get方法, 会拿到上一次的连接，如果没拿到，会调用</p>
<p data-lake-id="1909cb630676aa5550eb861224ed8362">getPoolEntryBlocking方法，进一步的获取连接单元.</p>
<p data-lake-id="aab543f5731d2403866172fddc13b3b6">这个方法调用了RouteSpecificPool.getFree.//拿到一个可用的连接.</p>
<p data-lake-id="ca99fa9fd1e10b3e219f10b27cc35095">RouteSpecificPool: 里面是两个链表, 存储的是route维度的连接信息. 如果是getFree方法，那就从avaiable里拿一个元素出来，并且放到lease的链表里，代表成功lease了一个连接。</p>
<p data-lake-id="426d4f85f44bdb21f39aa136265017fb">  try {</p>
<p data-lake-id="915fc8d33ec55dc9a51d5c0f7d66ccfe">           final RouteSpecificPool<T, C, E> pool = getPool(route);</p>
<p data-lake-id="0e5583255fb0070be41e72dc8ef9f55a">           E entry;</p>
<p data-lake-id="080b4d0056badae556f9dc5584e5b464">           for (;;) {</p>
<p data-lake-id="f251e386587cdeebc2cfab0c50fdd0b9">               Asserts.check(!this.isShutDown, "Connection pool shut down");</p>
<p data-lake-id="990e7c1b9eea18c7f47a1bf2a2efdd04">               for (;;) {</p>
<p data-lake-id="42567f3dce1845583f3bf39b5ae67d25">                   //从avaiable的队列里取出来一个并且放到lease的队列里</p>
<p data-lake-id="de76584a5d858a611ede485d262f4052">                   //获取一个可用</p>
<p data-lake-id="c499b6fc9bf58915795b871d7175bd54">                   entry = pool.getFree(state);</p>
<p data-lake-id="e7400dfa18c274a9cf25fa3c600e9b41">                   if (entry == null) {</p>
<p data-lake-id="b6c5fabfe6f2a2be1f43341c677bcc35">                       break;</p>
<p data-lake-id="c5068c2d7b6e7fca3269f3d2e98eb145">                   }</p>
<p data-lake-id="73ddbdf3a0493eb630701407a6446969">                   if (entry.isExpired(System.currentTimeMillis())) {</p>
<p data-lake-id="c4209c7468b7ad990536a6e6fbab37d1">                       entry.close();</p>
<p data-lake-id="9d2f98ac598a724bda1db43cb6c82a3b">                   }</p>
<p data-lake-id="5ea94f160a05a9ababa918a08e429b44">                   //如果连接是关闭的,过期了会自动关闭</p>
<p data-lake-id="a4793b2281a10b68defc7a4958c4cc41">                   if (entry.isClosed()) {</p>
<p data-lake-id="f3ecf6d4328fdaf9fd97ad1f780023f5">                       //因为这个连接已经不可用了, 把他从可用列表里移除</p>
<p data-lake-id="6ead79d53ee8127c4d0ca68a3e567a6e">                       this.available.remove(entry);</p>
<p data-lake-id="076c2e856889d4d12b7979086f4b44f2">                       //再从pool里的lease的队列里取一个放到available的队列列</p>
<p data-lake-id="0e2600e70db83f908f1e7fe279579afc">                       //因为是false,所以不会放到avaiable里</p>
<p data-lake-id="47ed83d1e3e3e21740a7e5f1288c43b1">                       pool.free(entry, false);</p>
<p data-lake-id="d2b52f27f022a48bc33a7c98009245dd">                   } else {</p>
<p data-lake-id="24b6b6b71732f7cf350c8820a08401bc">                       break;</p>
<p data-lake-id="32d7c738de691bc1b1c8df34d8cdfead">                   }</p>
<p data-lake-id="9595c1a92ba2f6820c06591c4d7a692d">                   //第一个for完了,得到了一个entry(可用)或者null</p>
<p data-lake-id="f9fd98b38b91c811f9236d1852e34270">                  if (entry != null) {</p>
<p data-lake-id="7f97dd811959d74f57f4fc2edc830528">                      //成功的获取到了，记录一下从可用里移除,并且结束进程</p>
<p data-lake-id="91fef1c0db6208db7c3fb80bdd9ac59e">                   this.available.remove(entry);</p>
<p data-lake-id="009d8589cfeecb564392f9edbf395e98">                      //放到lease的里面去</p>
<p data-lake-id="53c0c25568479d9e9acf6bc855766805">                   this.leased.add(entry);</p>
<p data-lake-id="23a98647c1001f772690479b6ca8beb2">                      //标记为可重复使用</p>
<p data-lake-id="d74518a92b1dffd4012842450476f96a">                   onReuse(entry);</p>
<p data-lake-id="def3c63d3c045704a08664c09c36321f">                   return entry;</p>
<p data-lake-id="6c235bfa3d86822df34acbfab9cb4363">               }</p>
<p data-lake-id="c8d81eb9c7565da2d94417fd4179f925">                        // 如果为null则需要重新构建一个连接.</p>
<p data-lake-id="d40e17c265215331cb19915ed93b35da">               final int maxPerRoute = getMax(route);</p>
<p data-lake-id="e34bcb12d2a5616ea252b019544e7402">               // Shrink the pool prior to allocating a new connection</p>
<p data-lake-id="0ae305270c476cd4068513b3269d232a">               final int excess = Math.max(0, pool.getAllocatedCount() + 1 - maxPerRoute);</p>
<p data-lake-id="043a8c29c8260f97df266e72bbe382ea">                   //这个excess恒大于1?</p>
<p data-lake-id="8d8ad59f3fccb6dd9e126968369f11cb">                   if (excess > 0) {</p>
<p data-lake-id="589b3b9ab7d2d6a0abc06d77c684b6f3">                   for (int i = 0; i < excess; i++) {</p>
<p data-lake-id="8af13cd24812485777aa62b7f6e14dbf">                       final E lastUsed = pool.getLastUsed();</p>
<p data-lake-id="70814456fbc643c4e5ee5c60689770e0">                       if (lastUsed == null) {</p>
<p data-lake-id="a60c88d405b9cf816825c3b86ff3464b">                           break;</p>
<p data-lake-id="175931a97516114cbca09466f4727412">                       }</p>
<p data-lake-id="0a9558385759379e544e7479c23d8d67">                       lastUsed.close();</p>
<p data-lake-id="2970222bc1e405a27948051e9c4edcfb">                       this.available.remove(lastUsed);</p>
<p data-lake-id="bd2d83b609b9eb5aaba1548c504a4730">                       pool.remove(lastUsed);</p>
<p data-lake-id="3ef2532a31edf3a280a9a3c3536ff527">                   }</p>
<p data-lake-id="bb872f11bdd3d0a992457e94eb8b321b">               }</p>
<p data-lake-id="5d27a5b6829f4ae109d20cd7285c5c87">
</p><p data-lake-id="91c8e74a204446f005ce468e0d00d4e2">                   //如果还有容量, 则新建一个连接</p>
<p data-lake-id="705f16c2772c106fc822adc2c8b72c90">
</p><p data-lake-id="952722c5123ef12d46efda2be5e79ff5">                     if (pool.getAllocatedCount() < maxPerRoute) {</p>
<p data-lake-id="33879a733cdeb3f1331b30b3758bc6ec">                   final int totalUsed = this.leased.size();</p>
<p data-lake-id="1a3dfc197e195f664b9a4e28fe2bef18">                   final int freeCapacity = Math.max(this.maxTotal - totalUsed, 0);</p>
<p data-lake-id="c6cc30619b2d6275f04ae40e48658b3d">                   if (freeCapacity > 0) {</p>
<p data-lake-id="f7b38a99cd93057983a36e3103fc3c99">                       final int totalAvailable = this.available.size();</p>
<p data-lake-id="7417d4af38a55666ad341ba739737d2f">                       if (totalAvailable > freeCapacity - 1) {</p>
<p data-lake-id="95180eb2b42aa0406ec48d8c335e22c6">                           if (!this.available.isEmpty()) {</p>
<p data-lake-id="e340006d44f88ff55c8e5c40f47ee9f5">                               final E lastUsed = this.available.removeLast();</p>
<p data-lake-id="1eed268466053d5b88688f4838454da4">                               lastUsed.close();</p>
<p data-lake-id="7119f00c8fdc299b841ed1dec45debb7">                               final RouteSpecificPool<T, C, E> otherpool = getPool(lastUsed.getRoute());</p>
<p data-lake-id="ded24b8ad1b539d062310bb64ad2e2e7">                               otherpool.remove(lastUsed);</p>
<p data-lake-id="001774f4657b006e441c34a395985e2a">                           }</p>
<p data-lake-id="2b145ab5ae2888efc709fd9dfbce7154">                       }</p>
<p data-lake-id="90502ba49cea82bb7a7898993022eae9">                       final C conn = this.connFactory.create(route);</p>
<p data-lake-id="2f79e503e279a361d29308941cb276ba">                       entry = pool.add(conn);</p>
<p data-lake-id="446d193fe8def0a1ed8f67077ce85532">                       this.leased.add(entry);</p>
<p data-lake-id="3fead4d7e82b1afa32e6966f92fab149">                       return entry;</p>
<p data-lake-id="b204f0cadf2aaab341e1d45c19a8f77e">                   }</p>
<p data-lake-id="98920e0d271722fee122e3ccbfdde178">               }</p>
<p data-lake-id="31333ffa4ff08950a8d646990792f799">
</p><p data-lake-id="74e0a7b576a112e265057fd42e1f823f">
</p><p data-lake-id="a2087a17fe52454d39fa21a91460eca7">               }</p>
<p data-lake-id="5bc8edf0f2339e03da752e8650df3870">通过这个可以清楚的了解到，这些配置参数的含义。</p>
<p data-lake-id="2905be5d296743bd985687c444a4d8c2">max-total: 连接池最大的连接数量</p>
<p data-lake-id="1669704fba0bff875aa3e19c0e3695ab">max-per-route: 连接池里每个域名的最大连接数量</p>
<p data-lake-id="22a3f6f51d7c367981a419224629d029">default-max-per-route: 没找到对应的域名的配置时候，使用的连接数量</p>
<p data-lake-id="2496366f1a3b2b57414446365a9fa218">公司的中间还封装了一个逻辑，默认全局只有一个连接池，使用的是上面的配置。他封装了一个逻辑，可以一个域名配置一个连接池。配置格式类似如下，下面就有两个连接池，每个连接池用自己的配置。</p>
<div id="0ocg8" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%22httpclient%3A%5Cn%20%20default-pool%3A%5Cn%20%20%20%20default-max-per-route%3A%2020%5Cn%20%20%20%20max-total%3A%20100%5Cn%20%20%20%20max-per-route%3A%2050%5Cn%20%20%20%20keep-alive-time%3A%2060%5Cn%20%20%20%20connect-timeout%3A%205000%5Cn%20%20%20%20connection-request-timeout%3A%205000%5Cn%20%20%20%20socket-timeout%3A%201000%5Cn%20%20%20%20idle-connections-timeout%3A%2030%5Cn%20%20%20%20idle-connections-check-schedule%3A%205000%5Cn%20%20pool-configs%3A%5Cn%20%20%20%20%20%20%5C%22%5Bhttp%3A%2F%2F10.69.3.58%3A9003%5D%5C%22%3A%5Cn%20%20%20%20%20%20%20%20max-total%3A%20213%5Cn%20%20%20%20%20%20%20%20max-per-route%3A%20123%5Cn%20%20%20%20%20%20%20%20keep-alive-time%3A%20900%5Cn%20%20%20%20%20%20%20%20connect-timeout%3A%20450%5Cn%20%20%20%20%20%20%20%20connection-request-timeout%3A%20450%5Cn%20%20%20%20%20%20%20%20socket-timeout%3A%20450%5Cn%20%20%20%20%20%20%20%20idle-connections-timeout%3A%2030%5Cn%20%20%20%20%20%20%20%20idle-connections-check-schedule%3A%205000%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%220ocg8%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content">httpclient:
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">  default-pool:
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    default-max-per-route: <span class="cm-number">20</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    max-total: <span class="cm-number">100</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    max-per-route: <span class="cm-number">50</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    keep-alive-time: <span class="cm-number">60</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    connect-timeout: <span class="cm-number">5000</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    connection-request-timeout: <span class="cm-number">5000</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    socket-timeout: <span class="cm-number">1000</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    idle-connections-timeout: <span class="cm-number">30</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">    idle-connections-check-schedule: <span class="cm-number">5000</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">  pool-configs:
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      <span class="cm-string">"[http://10.69.3.58:9003]"</span>:
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        max-total: <span class="cm-number">213</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        max-per-route: <span class="cm-number">123</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        keep-alive-time: <span class="cm-number">900</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        connect-timeout: <span class="cm-number">450</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        connection-request-timeout: <span class="cm-number">450</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        socket-timeout: <span class="cm-number">450</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        idle-connections-timeout: <span class="cm-number">30</span>
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">        idle-connections-check-schedule: <span class="cm-number">5000</span></span></span></pre>
</div>
</div>
</div>
<h4 id="rHfOp" data-lake-id="08f4816707efce6f1b85c38590c0a592">生产问题定位</h4>
<p data-lake-id="7038f43cec5ab5704619cb400b2116b0">了解了PoolingHttpClientConnectionManager之后，其实我们可以把日志打开看一看，到底是什么情况？</p>
<p data-lake-id="9160fc8ce98db43369a83870642de5fe">  <Logger name="org.apache.http.impl.conn.PoolingHttpClientConnectionManager" level="DEBUG"></p>
<p data-lake-id="ced18afe925bcc2be351101553369fad">       </Logger></p>
<p data-lake-id="037551fe2db85f904ff64a404bc3f0b4">我把这个类的info日志打开，发现日志如下:</p>
<div id="VHJSj" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-08-26%2016%3A47%3A36%20%5Cu001b%5B36mDEBUG%5Cu001b%5Bm%5Bpool-7-thread-149%5D%20%5Bo.a.h.i.c.PoolingHttpClientConnectionManager.requestConnection%3A266%5D%20%5B154ee4edcd6d1152%2C154ee4edcd6d1152%2C0%5D%20Connection%20request%3A%20%5Broute%3A%20%7Bs%7D-%3Ehttps%3A%2F%2Faiengine-hellomap-route-inner.hellobike.cn%3A9003%5D%5Btotal%20kept%20alive%3A%200%3B%20route%20allocated%3A%2050%20of%2050%3B%20total%20allocated%3A%2050%20of%20100%5D%5Cn2020-08-26%2016%3A47%3A36%20%5Cu001b%5B36mDEBUG%5Cu001b%5Bm%5Bpool-7-thread-219%5D%20%5Bo.a.h.i.c.PoolingHttpClientConnectionManager.leaseConnection%3A310%5D%20%5B8f2ce76435c397c6%2C8f2ce76435c397c6%2C0%5D%20Connection%20leased%3A%20%5Bid%3A%20607%5D%5Broute%3A%20%7Bs%7D-%3Ehttps%3A%2F%2Faiengine-hellomap-route-inner.hellobike.cn%3A9003%5D%5Btotal%20kept%20alive%3A%200%3B%20route%20allocated%3A%2050%20of%2050%3B%20total%20allocated%3A%2050%20of%20100%5D%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%22VHJSj%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-08</span><span class="cm-attribute">-26</span> <span class="cm-number">16</span>:47:36 [36mDEBUG[m[pool-7-thread-149] [o.a.h.i.c.PoolingHttpClientConnectionManager.requestConnection:266] [154ee4edcd6d1152,154ee4edcd6d1152,0] Connection request: [route: {s}->https://aiengine-hellomap-route-inner.hellobike.cn:9003][total kept alive: <span class="cm-number">0</span>; route allocated: <span class="cm-number">50</span> of <span class="cm-number">50</span>; total allocated: <span class="cm-number">50</span> of <span class="cm-number">100</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-08</span><span class="cm-attribute">-26</span> <span class="cm-number">16</span>:47:36 [36mDEBUG[m[pool-7-thread-219] [o.a.h.i.c.PoolingHttpClientConnectionManager.leaseConnection:310] [8f2ce76435c397c6,8f2ce76435c397c6,0] Connection leased: [id: <span class="cm-number">607</span>][route: {s}->https://aiengine-hellomap-route-inner.hellobike.cn:9003][total kept alive: <span class="cm-number">0</span>; route allocated: <span class="cm-number">50</span> of <span class="cm-number">50</span>; total allocated: <span class="cm-number">50</span> of <span class="cm-number">100</span>]</span></span></pre>
</div>
</div>
</div>
<p data-lake-id="54fc37e9c0d6b38e9f14c6590234a327">这个结合着PoolingHttpClientConnectionManager源代码还是比较容易理解的。</p>
<p data-lake-id="f396d11de88d57dd12a364413f4b0d28">这里为啥是 50 of 50跟我配置的不一样？ 后来发现是中间件的bug!!! 在https的时候就有bug，用户自己配的 max-per-route是无效的..这个是后话了</p>
<p data-lake-id="ec635aefb27842d9c5a96aab79ac8a3a">通过这个日志可以很清楚的知道，不仅使用了连接池，而且还能够保持连接。所以这个猜想是错误的。</p>
<h3 id="zGDLl" data-lake-id="4d0edbdb3f8ae679516d993387eefbf5">是不是有突增的流量进来呢</h3>
<p data-lake-id="8c6d38bf8149755e5d5a654ed257c5c0">我们这个应用还给另外一个特殊的定时任务类型的应用使用，会不会是他带来的巨大的流量，导致了很多连接的创建，最终导致了FinalReference过多呢？ 我们尝试把这部分流量切出去，然而问题依旧。</p>
<h3 id="cDk3v" data-lake-id="4ec115dbec91820013af436b3548cda9">是不是sslsession的问题导致的呢</h3>
<p data-lake-id="3288baa28d694459985bc24859b86a7a">期间还听说另外一个开放也遇到gc的问题，是因为jdk的bug导致的</p>
<p data-lake-id="0f0bbecf59c434801872e6dedfeaa0c8"><a href="https://bugs.openjdk.java.net/browse/JDK-8210985" target="_blank" rel="noopener">https://bugs.openjdk.java.net/browse/JDK-8210985</a></p>
<p data-lake-id="924129d048b905dd0bb22d0ee8b34be0">-Djavax.net.ssl.sessionCacheSize=101 通过设置他的大小来控制队列的长度，通过修改这个参数，依然没什么效果。</p>
<h2 id="HMq1s" data-lake-id="b3316fefdf366881f57b9f80963283e2">另类的解决方法</h2>
<p data-lake-id="e9ea8ac7df7ed2c629a5bfc7bf2f143e">查找FinalReference过多是查不到了，可能这个应用就是这么个特性。因为并发高，后端逻辑是纯http request，所以连接比较多是正常的。至于为啥FinalReference突然从6万多到了40多万，带来了gc的停顿，至今也没想明白。</p>
<p data-lake-id="1d905dde162df39c09d9aa8183a99c9f">但是生产的问题依然存在，必须火速解决。既然解决不了问题，我们就解决提出问题的人！回到问题的本质，是因为在并发标记阶段FinalReference太多了导致的。每次出问题都是并发标记带来的，那么我是不是可以通过增加并发标记的次数，主动的去干这个事，而不是让他累积到一定的量导致爆发呢？</p>
<h4 id="oWEdT" data-lake-id="441949dac66419bfd72911384df338e5">增加并发标记的次数</h4>
<p data-lake-id="4fe473dcf86bf1fe24127bb938110c6a">说干就干，我们通过增加参数-XX:InitiatingHeapOccupancyPercent=7来达到主动的触发并发标记的目的。这个参数的默认是45，也就是达到了45%会触发一次并发标记。同时我们把4核的机器换成8核，把并发标记的线程从4个提升到6个，我给你更多的计算资源，让你帮我把FinalReference主动的减少，行不行呢？</p>
<p data-lake-id="69630b344b36adfbbab7447c239e916c">参数修改之后，观察效果，发现并发标记的次数确实变多了，每次并发标记之后，FinalReference也如期减少了，达到了预期的效果。经过一周的观察，gc问题解决了，再也没有gc带来的超时问题.</p>
<p data-lake-id="2b7dee8b3903a5bb7728ff15000876f2">从日志上看7万多的FinalReference经过并发标记之后，到了5000多，目的达到了。</p>
<div id="bT011" class="lake-card-margin lake-selected" data-card-type="block" data-lake-card="codeblock" data-card-value="data:%7B%22mode%22%3A%22shell%22%2C%22code%22%3A%222020-09-08T18%3A26%3A29.601%2B0800%3A%20509725.355%3A%20%5BSoftReference%2C%200%20refs%2C%200.0005530%20secs%5D2020-09-08T18%3A26%3A29.602%2B0800%3A%20509725.355%3A%20%5BWeakReference%2C%20651%20refs%2C%200.0003417%20secs%5D2020-09-08T18%3A26%3A29.602%2B0800%3A%20509725.356%3A%20%5BFinalReference%2C%2059425%20refs%2C%200.0084187%20secs%5D2020-09-08T18%3A26%3A29.611%2B0800%3A%20509725.364%3A%20%5BPhantomReference%2C%200%20refs%2C%200%20refs%2C%200.0007736%20secs%5D2020-09-08T18%3A26%3A29.611%2B0800%3A%20509725.365%3A%20%5BJNI%20Weak%20Reference%2C%200.0000406%20secs%5D%2C%200.0485472%20secs%5D%5Cn%20%20%20%5BParallel%20Time%3A%2031.2%20ms%2C%20GC%20Workers%3A%206%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20Start%20(ms)%3A%20Min%3A%20509725323.3%2C%20Avg%3A%20509725323.4%2C%20Max%3A%20509725323.5%2C%20Diff%3A%200.1%5D%5Cn%20%20%20%20%20%20%5BExt%20Root%20Scanning%20(ms)%3A%20Min%3A%203.8%2C%20Avg%3A%205.3%2C%20Max%3A%2011.4%2C%20Diff%3A%207.6%2C%20Sum%3A%2031.7%5D%5Cn%20%20%20%20%20%20%5BUpdate%20RS%20(ms)%3A%20Min%3A%203.6%2C%20Avg%3A%209.6%2C%20Max%3A%2011.0%2C%20Diff%3A%207.3%2C%20Sum%3A%2057.7%5D%5Cn%20%20%20%20%20%20%20%20%20%5BProcessed%20Buffers%3A%20Min%3A%20256%2C%20Avg%3A%20319.7%2C%20Max%3A%20376%2C%20Diff%3A%20120%2C%20Sum%3A%201918%5D%5Cn%20%20%20%20%20%20%5BScan%20RS%20(ms)%3A%20Min%3A%200.1%2C%20Avg%3A%200.3%2C%20Max%3A%200.3%2C%20Diff%3A%200.2%2C%20Sum%3A%201.6%5D%5Cn%20%20%20%20%20%20%5BCode%20Root%20Scanning%20(ms)%3A%20Min%3A%200.0%2C%20Avg%3A%200.0%2C%20Max%3A%200.0%2C%20Diff%3A%200.0%2C%20Sum%3A%200.1%5D%5Cn%20%20%20%20%20%20%5BObject%20Copy%20(ms)%3A%20Min%3A%2015.2%2C%20Avg%3A%2015.5%2C%20Max%3A%2015.8%2C%20Diff%3A%200.5%2C%20Sum%3A%2093.2%5D%5Cn%20%20%20%20%20%20%5BTermination%20(ms)%3A%20Min%3A%200.0%2C%20Avg%3A%200.1%2C%20Max%3A%200.1%2C%20Diff%3A%200.1%2C%20Sum%3A%200.3%5D%5Cn%20%20%20%20%20%20%20%20%20%5BTermination%20Attempts%3A%20Min%3A%201%2C%20Avg%3A%20150.8%2C%20Max%3A%20196%2C%20Diff%3A%20195%2C%20Sum%3A%20905%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20Other%20(ms)%3A%20Min%3A%200.0%2C%20Avg%3A%200.1%2C%20Max%3A%200.1%2C%20Diff%3A%200.1%2C%20Sum%3A%200.5%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20Total%20(ms)%3A%20Min%3A%2030.8%2C%20Avg%3A%2030.8%2C%20Max%3A%2030.9%2C%20Diff%3A%200.1%2C%20Sum%3A%20185.0%5D%5Cn%20%20%20%20%20%20%5BGC%20Worker%20End%20(ms)%3A%20Min%3A%20509725354.2%2C%20Avg%3A%20509725354.2%2C%20Max%3A%20509725354.3%2C%20Diff%3A%200.1%5D%5Cn%20%20%20%5BCode%20Root%20Fixup%3A%200.2%20ms%5D%5Cn%20%20%20%5BCode%20Root%20Purge%3A%200.0%20ms%5D%5Cn%20%20%20%5BClear%20CT%3A%200.6%20ms%5D%5Cn%20%20%20%5BOther%3A%2016.6%20ms%5D%5Cn%20%20%20%20%20%20%5BChoose%20CSet%3A%200.0%20ms%5D%5Cn%20%20%20%20%20%20%5BRef%20Proc%3A%2010.4%20ms%5D%5Cn%20%20%20%20%20%20%5BRef%20Enq%3A%200.3%20ms%5D%5Cn%20%20%20%20%20%20%5BRedirty%20Cards%3A%200.1%20ms%5D%5Cn%20%20%20%20%20%20%5BHumongous%20Register%3A%200.0%20ms%5D%5Cn%20%20%20%20%20%20%5BHumongous%20Reclaim%3A%200.0%20ms%5D%5Cn%20%20%20%20%20%20%5BFree%20CSet%3A%201.4%20ms%5D%5Cn%20%20%20%5BEden%3A%206084.0M(6084.0M)-%3E0.0B(6084.0M)%20Survivors%3A%2060.0M-%3E60.0M%20Heap%3A%207811.1M(10.0G)-%3E1725.1M(10.0G)%5D%5CnHeap%20after%20GC%20invocations%3D19624%20(full%200)%3A%5Cn%20garbage-first%20heap%20%20%20total%2010485760K%2C%20used%201766479K%20%5B0x0000000540000000%2C%200x0000000540405000%2C%200x00000007c0000000)%5Cn%20%20region%20size%204096K%2C%2015%20young%20(61440K)%2C%2015%20survivors%20(61440K)%5Cn%20Metaspace%20%20%20%20%20%20%20used%2096904K%2C%20capacity%20100148K%2C%20committed%20101504K%2C%20reserved%201138688K%5Cn%20%20class%20space%20%20%20%20used%2011478K%2C%20capacity%2012106K%2C%20committed%2012416K%2C%20reserved%201048576K%5Cn%7D%5Cn%20%5BTimes%3A%20user%3D0.19%20sys%3D0.06%2C%20real%3D0.05%20secs%5D%5Cn2020-09-08T18%3A26%3A29.616%2B0800%3A%20509725.370%3A%20%5BGC%20concurrent-root-region-scan-start%5D%5Cn2020-09-08T18%3A26%3A29.617%2B0800%3A%20509725.370%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0667356%20seconds%2C%20Stopping%20threads%20took%3A%200.0006084%20seconds%5Cn2020-09-08T18%3A26%3A29.624%2B0800%3A%20509725.377%3A%20%5BGC%20concurrent-root-region-scan-end%2C%200.0075624%20secs%5D%5Cn2020-09-08T18%3A26%3A29.624%2B0800%3A%20509725.377%3A%20%5BGC%20concurrent-mark-start%5D%5Cn2020-09-08T18%3A26%3A29.745%2B0800%3A%20509725.498%3A%20%5BGC%20concurrent-mark-end%2C%200.1212810%20secs%5D%5Cn2020-09-08T18%3A26%3A29.745%2B0800%3A%20509725.499%3A%20Application%20time%3A%200.1284912%20seconds%5Cn2020-09-08T18%3A26%3A29.762%2B0800%3A%20509725.516%3A%20%5BGC%20remark%202020-09-08T18%3A26%3A29.762%2B0800%3A%20509725.516%3A%20%5BFinalize%20Marking%2C%200.0020710%20secs%5D%202020-09-08T18%3A26%3A29.764%2B0800%3A%20509725.518%3A%20%5BGC%20ref-proc2020-09-08T18%3A26%3A29.764%2B0800%3A%20509725.518%3A%20%5BSoftReference%2C%20244%20refs%2C%200.0005201%20secs%5D2020-09-08T18%3A26%3A29.765%2B0800%3A%20509725.518%3A%20%5BWeakReference%2C%202549%20refs%2C%200.0006340%20secs%5D2020-09-08T18%3A26%3A29.766%2B0800%3A%20509725.519%3A%20%5BFinalReference%2C%2034%20refs%2C%200.0003842%20secs%5D2020-09-08T18%3A26%3A29.766%2B0800%3A%20509725.519%3A%20%5BPhantomReference%2C%200%20refs%2C%20772%20refs%2C%200.0008726%20secs%5D2020-09-08T18%3A26%3A29.767%2B0800%3A%20509725.520%3A%20%5BJNI%20Weak%20Reference%2C%200.0002677%20secs%5D%2C%200.0028920%20secs%5D%202020-09-08T18%3A26%3A29.767%2B0800%3A%20509725.521%3A%20%5BUnloading%2C%200.0209432%20secs%5D%2C%200.0292943%20secs%5D%5Cn%20%5BTimes%3A%20user%3D0.10%20sys%3D0.03%2C%20real%3D0.03%20secs%5D%5Cn2020-09-08T18%3A26%3A29.792%2B0800%3A%20509725.546%3A%20Total%20time%20for%20which%20application%20threads%20were%20stopped%3A%200.0473635%20seconds%2C%20Stopping%20threads%20took%3A%200.0005978%20seconds%5Cn2020-09-08T18%3A26%3A29.793%2B0800%3A%20509725.546%3A%20Application%20time%3A%200.0001449%20seconds%5Cn2020-09-08T18%3A26%3A29.809%2B0800%3A%20509725.563%3A%20%5BGC%20cleanup%201797M-%3E1797M(10G)%2C%200.0051662%20secs%5D%5Cn%20%5BTimes%3A%20user%3D0.02%20sys%3D0.00%2C%20real%3D0.00%20secs%5D%22%2C%22heightLimit%22%3Atrue%2C%22margin%22%3Atrue%2C%22id%22%3A%22bT011%22%7D" data-language="shell">
<div class="lake-codeblock-content">
<div class="CodeMirror-sizer">
<pre class="cm-s-default"><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.601<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.355: [SoftReference, <span class="cm-number">0</span> refs, <span class="cm-number">0</span>.0005530 secs]2020-09-08T18:26:29.602<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.355: [WeakReference, <span class="cm-number">651</span> refs, <span class="cm-number">0</span>.0003417 secs]2020-09-08T18:26:29.602<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.356: [FinalReference, <span class="cm-number">59425</span> refs, <span class="cm-number">0</span>.0084187 secs]2020-09-08T18:26:29.611<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.364: [PhantomReference, <span class="cm-number">0</span> refs, <span class="cm-number">0</span> refs, <span class="cm-number">0</span>.0007736 secs]2020-09-08T18:26:29.611<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.365: [JNI Weak Reference, <span class="cm-number">0</span>.0000406 secs], <span class="cm-number">0</span>.0485472 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Parallel Time: <span class="cm-number">31</span>.2 ms, GC Workers: <span class="cm-number">6</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker Start (ms): Min: <span class="cm-number">509725323</span>.3, Avg: <span class="cm-number">509725323</span>.4, Max: <span class="cm-number">509725323</span>.5, Diff: <span class="cm-number">0</span>.1]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Ext Root Scanning (ms): Min: <span class="cm-number">3</span>.8, Avg: <span class="cm-number">5</span>.3, Max: <span class="cm-number">11</span>.4, Diff: <span class="cm-number">7</span>.6, Sum: <span class="cm-number">31</span>.7]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Update RS (ms): Min: <span class="cm-number">3</span>.6, Avg: <span class="cm-number">9</span>.6, Max: <span class="cm-number">11</span>.0, Diff: <span class="cm-number">7</span>.3, Sum: <span class="cm-number">57</span>.7]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">         [Processed Buffers: Min: <span class="cm-number">256</span>, Avg: <span class="cm-number">319</span>.7, Max: <span class="cm-number">376</span>, Diff: <span class="cm-number">120</span>, Sum: <span class="cm-number">1918</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Scan RS (ms): Min: <span class="cm-number">0</span>.1, Avg: <span class="cm-number">0</span>.3, Max: <span class="cm-number">0</span>.3, Diff: <span class="cm-number">0</span>.2, Sum: <span class="cm-number">1</span>.6]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Code Root Scanning (ms): Min: <span class="cm-number">0</span>.0, Avg: <span class="cm-number">0</span>.0, Max: <span class="cm-number">0</span>.0, Diff: <span class="cm-number">0</span>.0, Sum: <span class="cm-number">0</span>.1]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Object Copy (ms): Min: <span class="cm-number">15</span>.2, Avg: <span class="cm-number">15</span>.5, Max: <span class="cm-number">15</span>.8, Diff: <span class="cm-number">0</span>.5, Sum: <span class="cm-number">93</span>.2]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Termination (ms): Min: <span class="cm-number">0</span>.0, Avg: <span class="cm-number">0</span>.1, Max: <span class="cm-number">0</span>.1, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">0</span>.3]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">         [Termination Attempts: Min: <span class="cm-number">1</span>, Avg: <span class="cm-number">150</span>.8, Max: <span class="cm-number">196</span>, Diff: <span class="cm-number">195</span>, Sum: <span class="cm-number">905</span>]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker Other (ms): Min: <span class="cm-number">0</span>.0, Avg: <span class="cm-number">0</span>.1, Max: <span class="cm-number">0</span>.1, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">0</span>.5]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker Total (ms): Min: <span class="cm-number">30</span>.8, Avg: <span class="cm-number">30</span>.8, Max: <span class="cm-number">30</span>.9, Diff: <span class="cm-number">0</span>.1, Sum: <span class="cm-number">185</span>.0]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [GC Worker End (ms): Min: <span class="cm-number">509725354</span>.2, Avg: <span class="cm-number">509725354</span>.2, Max: <span class="cm-number">509725354</span>.3, Diff: <span class="cm-number">0</span>.1]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Code Root Fixup: <span class="cm-number">0</span>.2 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Code Root Purge: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Clear CT: <span class="cm-number">0</span>.6 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Other: <span class="cm-number">16</span>.6 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Choose CSet: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Ref Proc: <span class="cm-number">10</span>.4 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Ref Enq: <span class="cm-number">0</span>.3 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Redirty Cards: <span class="cm-number">0</span>.1 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Humongous Register: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Humongous Reclaim: <span class="cm-number">0</span>.0 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">      [Free CSet: <span class="cm-number">1</span>.4 ms]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">   [Eden: <span class="cm-number">6084</span>.0M(6084.0M)->0.0B(6084.0M) Survivors: <span class="cm-number">60</span>.0M->60.0M Heap: <span class="cm-number">7811</span>.1M(10.0G)->1725.1M(10.0G)]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">Heap after GC <span class="cm-def">invocations</span><span class="cm-operator">=</span><span class="cm-number">19624</span> (full <span class="cm-number">0</span>):
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> garbage-first heap   total 10485760K, used 1766479K [0x0000000540000000, 0x0000000540405000, 0x00000007c0000000)
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">  region size 4096K, <span class="cm-number">15</span> young (61440K), <span class="cm-number">15</span> survivors (61440K)
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> Metaspace       used 96904K, capacity 100148K, committed 101504K, reserved 1138688K
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">  class space    used 11478K, capacity 12106K, committed 12416K, reserved 1048576K
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content">}
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> [Times: <span class="cm-def">user</span><span class="cm-operator">=</span><span class="cm-number">0</span>.19 <span class="cm-def">sys</span><span class="cm-operator">=</span><span class="cm-number">0</span>.06, <span class="cm-def">real</span><span class="cm-operator">=</span><span class="cm-number">0</span>.05 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.616<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.370: [GC concurrent-root-region-scan-start]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.617<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.370: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0667356 seconds, Stopping threads took: <span class="cm-number">0</span>.0006084 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.624<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.377: [GC concurrent-root-region-scan-end, <span class="cm-number">0</span>.0075624 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.624<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.377: [GC concurrent-mark-start]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.745<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.498: [GC concurrent-mark-end, <span class="cm-number">0</span>.1212810 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.745<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.499: Application time: <span class="cm-number">0</span>.1284912 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.762<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.516: [GC remark <span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.762<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.516: [Finalize Marking, <span class="cm-number">0</span>.0020710 secs] <span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.764<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.518: [GC ref-proc2020-09-08T18:26:29.764<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.518: [SoftReference, <span class="cm-number">244</span> refs, <span class="cm-number">0</span>.0005201 secs]2020-09-08T18:26:29.765<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.518: [WeakReference, <span class="cm-number">2549</span> refs, <span class="cm-number">0</span>.0006340 secs]2020-09-08T18:26:29.766<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.519: [FinalReference, <span class="cm-number">34</span> refs, <span class="cm-number">0</span>.0003842 secs]2020-09-08T18:26:29.766<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.519: [PhantomReference, <span class="cm-number">0</span> refs, <span class="cm-number">772</span> refs, <span class="cm-number">0</span>.0008726 secs]2020-09-08T18:26:29.767<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.520: [JNI Weak Reference, <span class="cm-number">0</span>.0002677 secs], <span class="cm-number">0</span>.0028920 secs] <span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.767<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.521: [Unloading, <span class="cm-number">0</span>.0209432 secs], <span class="cm-number">0</span>.0292943 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> [Times: <span class="cm-def">user</span><span class="cm-operator">=</span><span class="cm-number">0</span>.10 <span class="cm-def">sys</span><span class="cm-operator">=</span><span class="cm-number">0</span>.03, <span class="cm-def">real</span><span class="cm-operator">=</span><span class="cm-number">0</span>.03 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.792<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.546: Total time <span class="cm-keyword">for</span> which application threads were stopped: <span class="cm-number">0</span>.0473635 seconds, Stopping threads took: <span class="cm-number">0</span>.0005978 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.793<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.546: Application time: <span class="cm-number">0</span>.0001449 seconds
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"><span class="cm-number">2020</span><span class="cm-attribute">-09</span><span class="cm-attribute">-08T18</span>:26:29.809<span class="cm-operator">+</span><span class="cm-number">0800</span>: <span class="cm-number">509725</span>.563: [GC cleanup 1797M->1797M(10G), <span class="cm-number">0</span>.0051662 secs]
</span></span><span class="lake-preview-line"><span class="lake-preview-codeblock-content"> [Times: <span class="cm-def">user</span><span class="cm-operator">=</span><span class="cm-number">0</span>.02 <span class="cm-def">sys</span><span class="cm-operator">=</span><span class="cm-number">0</span>.00, <span class="cm-def">real</span><span class="cm-operator">=</span><span class="cm-number">0</span>.00 secs]</span></span></pre>
</div>
</div>
</div>
<h1 id="iDFXM" data-lake-id="c94c818c63cb10b1ad93621f3205f1c6">总结</h1>
<p data-lake-id="fb016f2ecf1e966d4eae60fe239e1e63">至此，困扰长达一个多月的gc问题解决了，尽管没有找到FinalReference为什么突然增多的问题，但是通过另外的手段解决了生产的问题，根治了顽固的gc问题。通过整个过程，我们有以下收获</p>
<ol start="1" data-lake-id="87eeac2a340fbbfb475256f53c8ea81a"><li data-lake-id="32de30334f3a2614261124dce53c819e">充分的了解了G1垃圾回收器的原理和细节，为我们以后排查问题打下基础</li>
<li data-lake-id="a8343ec7276d63c1dfb9b28cbaa3b10f">认识了g1的gc日志，这些日志密密麻麻，其实藏了很多关键信息，结合这1所学的知识，看起来也就不费力了，还是需要静下心来，耐心的去看</li>
<li data-lake-id="984ff586c6ed107fe7da2d490a0a44d0">再解决的过程中，我们顺便看了公司的中间的代码，替他们找到一个大bug.另外，我们也了解了apache httpclient的连接池的原理以及分析和看了他的源代码</li>
<li data-lake-id="995a7aab6af0983bae05664686e49e11">再次使用了heap分析工具mat，尽管未能定位到问题</li>
<li data-lake-id="932b9513720c80bb65ef5e96e6d9975f">-Djavax.net.ssl.sessionCacheSize=101的bug问题</li>
</ol><div class="author-info">
	<div class="author-avatar">
			</div>

	<div class="author-description">
		<h2 class="author-title"><span class="author-heading">作者：</span> 龙安_任天兵</h2>

		<p class="author-bio">
			不忘初心，方得始终!			<a class="author-link" href="https://huster.top/htmls/author/admin" rel="author">
				查看龙安_任天兵的所有文章			</a>
		</p>
	</div>
</div>
	</div>

	<footer class="entry-footer"><span class="byline"><span class="author vcard"><span class="screen-reader-text">作者 </span> <a class="url fn n" href="https://huster.top/htmls/author/admin">龙安_任天兵</a></span></span><span class="posted-on"><span class="screen-reader-text">发布于 </span><a href="https://huster.top/htmls/745.html" rel="bookmark"><time class="entry-date published updated" datetime="2020-09-08T19:57:51+00:00">2020 年 9 月 8 日</time></a></span><span class="cat-links"><span class="screen-reader-text">分类 </span><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/java%e5%ad%a6%e4%b9%a0" rel="category tag">Java学习</a></span>			</footer></article><div id="gitalk-container"></div>
  <script type="text/javascript">
    var gitalk = new Gitalk({

    // gitalk的主要参数
		clientID: '95e38b5678bc02f9e4c9',
		clientSecret: '90b5173014cd44667e88ec922467e46ba456b53f',
		repo: 'myblog',
		owner: 'hust419',
		admin: ['hust419'],
		id: 'window.location.pathname',
    
    });
    gitalk.render('gitalk-container');
</script><nav class="navigation post-navigation" role="navigation"><h2 class="screen-reader-text">文章导航</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://huster.top/htmls/720.html" rel="prev"><span class="meta-nav" aria-hidden="true">上一</span> <span class="screen-reader-text">上篇文章：</span> <span class="post-title">生产FullGC问题排查</span></a></div><div class="nav-next"><a href="https://huster.top/htmls/748.html" rel="next"><span class="meta-nav" aria-hidden="true">下一</span> <span class="screen-reader-text">下篇文章：</span> <span class="post-title">CPU异常问题排查</span></a></div></div>
	</nav></main><aside id="content-bottom-widgets" class="content-bottom-widgets" role="complementary"><div class="widget-area">
			<section id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><script src="https://s22.cnzz.com/z_stat.php?id=3943131&web_id=3943131" language="JavaScript"></script></div></section></div>
	
	</aside></div>


	<aside id="secondary" class="sidebar widget-area" role="complementary"><section id="recent-posts-2" class="widget widget_recent_entries"><h2 class="widget-title">近期文章</h2>		<ul><li>
					<a href="https://huster.top/htmls/780.html">如何用java.io.*写一个服务器</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/748.html">CPU异常问题排查</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/745.html">又一起GC问题排查过程</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/720.html">生产FullGC问题排查</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/713.html">flink读取kafka数据未能触发watermark</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/708.html">flink使用时间戳作为起始offset消费kafka的问题</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/706.html">flink通过jdbc读取postgresql数据库里的数据</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/704.html">flink相关 – 通过Table API写入ElasticSearch的部分源码分析</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/700.html">flink的动态表格</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/696.html">flink相关 – 读入kafka数据源</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/691.html">flink学习笔记(一)</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/686.html">Java字节码增强应用</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/662.html">JVM Sandbox 源码分析（一）基础篇: Instrumentation和ClassFileTransformer作用</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/657.html">Java类库设计之日志框架选择</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/649.html">Java多线程知识点（下）</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/645.html">如何写代码来解决生产者消费者问题？</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/642.html">Java多线程总结(上部分)面试题解答</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/637.html">细说Java的内存模型</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/633.html">Java面试题之Java语法的基础知识</a>
									</li>
											<li>
					<a href="https://huster.top/htmls/629.html">Java的锁</a>
									</li>
					</ul></section><section id="archives-2" class="widget widget_archive"><h2 class="widget-title">文章归档</h2>		<ul><li><a href="https://huster.top/htmls/date/2022/04">2022年四月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2021/02">2021年二月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2020/09">2020年九月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2020/06">2020年六月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2020/02">2020年二月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2019/10">2019年十月</a> (6)</li>
	<li><a href="https://huster.top/htmls/date/2019/07">2019年七月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2019/06">2019年六月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2019/05">2019年五月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2018/12">2018年十二月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2018/11">2018年十一月</a> (5)</li>
	<li><a href="https://huster.top/htmls/date/2018/10">2018年十月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2018/08">2018年八月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2018/07">2018年七月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2018/06">2018年六月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2018/04">2018年四月</a> (3)</li>
	<li><a href="https://huster.top/htmls/date/2018/01">2018年一月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2017/10">2017年十月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2017/08">2017年八月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2017/07">2017年七月</a> (6)</li>
	<li><a href="https://huster.top/htmls/date/2017/06">2017年六月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2017/04">2017年四月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2016/12">2016年十二月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2016/11">2016年十一月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2016/10">2016年十月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2016/06">2016年六月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2016/03">2016年三月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2015/11">2015年十一月</a> (4)</li>
	<li><a href="https://huster.top/htmls/date/2015/01">2015年一月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2014/10">2014年十月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2013/08">2013年八月</a> (4)</li>
	<li><a href="https://huster.top/htmls/date/2013/06">2013年六月</a> (4)</li>
	<li><a href="https://huster.top/htmls/date/2013/05">2013年五月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2013/03">2013年三月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2012/12">2012年十二月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2012/09">2012年九月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2012/08">2012年八月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2012/07">2012年七月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2012/06">2012年六月</a> (2)</li>
	<li><a href="https://huster.top/htmls/date/2012/05">2012年五月</a> (1)</li>
	<li><a href="https://huster.top/htmls/date/2012/04">2012年四月</a> (10)</li>
	<li><a href="https://huster.top/htmls/date/2012/03">2012年三月</a> (8)</li>
	<li><a href="https://huster.top/htmls/date/2010/12">2010年十二月</a> (1)</li>
		</ul></section><section id="categories-2" class="widget widget_categories"><h2 class="widget-title">分类目录</h2>		<ul><li class="cat-item cat-item-57"><a href="https://huster.top/htmls/category/nas-%e7%be%a4%e6%99%96">nas-群晖</a> (2)
</li>
	<li class="cat-item cat-item-11"><a href="https://huster.top/htmls/category/php%e5%b7%a5%e5%85%b7">PHP高效编程</a> (6)
<ul class="children"><li class="cat-item cat-item-53"><a href="https://huster.top/htmls/category/php%e5%b7%a5%e5%85%b7/php-tools">PHP的开发工具</a> (3)
</li>
	<li class="cat-item cat-item-6"><a href="https://huster.top/htmls/category/php%e5%b7%a5%e5%85%b7/php%e9%82%a3%e4%ba%9b%e6%9c%89%e8%b6%a3%e7%9a%84%e4%ba%8b%e5%84%bf" title="php那些以前没注意到的，或者很少注意到事情">PHP编程</a> (3)
</li>
</ul></li>
	<li class="cat-item cat-item-74"><a href="https://huster.top/htmls/category/tensortflow">TensortFlow</a> (2)
</li>
	<li class="cat-item cat-item-33"><a href="https://huster.top/htmls/category/web%e5%ae%89%e5%85%a8">WEB安全</a> (3)
</li>
	<li class="cat-item cat-item-28"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0">学习笔记</a> (69)
<ul class="children"><li class="cat-item cat-item-83"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/flink">flink</a> (7)
</li>
	<li class="cat-item cat-item-19"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/http1-1%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0">HTTP/1.1阅读笔记</a> (11)
</li>
	<li class="cat-item cat-item-54"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/java%e5%ad%a6%e4%b9%a0">Java学习</a> (39)
</li>
	<li class="cat-item cat-item-44"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/linux%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0">Linux学习笔记</a> (1)
</li>
	<li class="cat-item cat-item-23"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/%e6%9c%8d%e5%8a%a1">PHP编写服务的研究</a> (1)
</li>
	<li class="cat-item cat-item-40"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/rfc793-tcp%e6%8e%a7%e5%88%b6%e5%8d%8f%e8%ae%ae">RFC793-TCP控制协议</a> (1)
</li>
	<li class="cat-item cat-item-56"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/spring%e6%96%87%e6%a1%a3">Spring文档</a> (3)
</li>
	<li class="cat-item cat-item-1"><a href="https://huster.top/htmls/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/uncategorized">其他</a> (5)
</li>
</ul></li>
	<li class="cat-item cat-item-16"><a href="https://huster.top/htmls/category/%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84">系统架构学习</a> (13)
</li>
	<li class="cat-item cat-item-75"><a href="https://huster.top/htmls/category/%e8%bd%ac%e8%bd%bd">转载</a> (2)
</li>
		</ul></section><section id="tag_cloud-2" class="widget widget_tag_cloud"><h2 class="widget-title">标签</h2><div class="tagcloud"><a href="https://huster.top/htmls/tag/apache" class="tag-cloud-link tag-link-31 tag-link-position-1" style="font-size: 1em;">Apache</a>
<a href="https://huster.top/htmls/tag/codesniffer" class="tag-cloud-link tag-link-12 tag-link-position-2" style="font-size: 1em;">CodeSniffer</a>
<a href="https://huster.top/htmls/tag/ecache" class="tag-cloud-link tag-link-67 tag-link-position-3" style="font-size: 1em;">Ecache</a>
<a href="https://huster.top/htmls/tag/globals" class="tag-cloud-link tag-link-10 tag-link-position-4" style="font-size: 1em;">GLOBALS</a>
<a href="https://huster.top/htmls/tag/hessian" class="tag-cloud-link tag-link-73 tag-link-position-5" style="font-size: 1em;">Hessian</a>
<a href="https://huster.top/htmls/tag/http1-1" class="tag-cloud-link tag-link-22 tag-link-position-6" style="font-size: 1em;">HTTP/1.1</a>
<a href="https://huster.top/htmls/tag/httpurlconnection" class="tag-cloud-link tag-link-71 tag-link-position-7" style="font-size: 1em;">HttpURLConnection</a>
<a href="https://huster.top/htmls/tag/http%e8%af%b7%e6%b1%82" class="tag-cloud-link tag-link-70 tag-link-position-8" style="font-size: 1em;">Http请求</a>
<a href="https://huster.top/htmls/tag/ioc" class="tag-cloud-link tag-link-17 tag-link-position-9" style="font-size: 1em;">IoC</a>
<a href="https://huster.top/htmls/tag/java" class="tag-cloud-link tag-link-58 tag-link-position-10" style="font-size: 1em;">Java</a>
<a href="https://huster.top/htmls/tag/java-spring-petclinic" class="tag-cloud-link tag-link-55 tag-link-position-11" style="font-size: 1em;">Java spring-petclinic</a>
<a href="https://huster.top/htmls/tag/log4j" class="tag-cloud-link tag-link-68 tag-link-position-12" style="font-size: 1em;">log4j</a>
<a href="https://huster.top/htmls/tag/logback" class="tag-cloud-link tag-link-69 tag-link-position-13" style="font-size: 1em;">logback</a>
<a href="https://huster.top/htmls/tag/maven" class="tag-cloud-link tag-link-64 tag-link-position-14" style="font-size: 1em;">Maven</a>
<a href="https://huster.top/htmls/tag/maven-shade-plugin" class="tag-cloud-link tag-link-66 tag-link-position-15" style="font-size: 1em;">maven-shade-plugin</a>
<a href="https://huster.top/htmls/tag/mybatis" class="tag-cloud-link tag-link-72 tag-link-position-16" style="font-size: 1em;">mybatis</a>
<a href="https://huster.top/htmls/tag/php" class="tag-cloud-link tag-link-7 tag-link-position-17" style="font-size: 1em;">PHP</a>
<a href="https://huster.top/htmls/tag/plugin" class="tag-cloud-link tag-link-65 tag-link-position-18" style="font-size: 1em;">Plugin</a>
<a href="https://huster.top/htmls/tag/register_globals" class="tag-cloud-link tag-link-9 tag-link-position-19" style="font-size: 1em;">register_globals</a>
<a href="https://huster.top/htmls/tag/rfc" class="tag-cloud-link tag-link-20 tag-link-position-20" style="font-size: 1em;">RFC</a>
<a href="https://huster.top/htmls/tag/rfc2616" class="tag-cloud-link tag-link-21 tag-link-position-21" style="font-size: 1em;">RFC2616</a>
<a href="https://huster.top/htmls/tag/serializable" class="tag-cloud-link tag-link-59 tag-link-position-22" style="font-size: 1em;">Serializable</a>
<a href="https://huster.top/htmls/tag/spring" class="tag-cloud-link tag-link-63 tag-link-position-23" style="font-size: 1em;">Spring</a>
<a href="https://huster.top/htmls/tag/spring-boot" class="tag-cloud-link tag-link-62 tag-link-position-24" style="font-size: 1em;">Spring boot</a>
<a href="https://huster.top/htmls/tag/thinkphp" class="tag-cloud-link tag-link-34 tag-link-position-25" style="font-size: 1em;">ThinkPHP</a>
<a href="https://huster.top/htmls/tag/vsftp" class="tag-cloud-link tag-link-43 tag-link-position-26" style="font-size: 1em;">VSFTP</a>
<a href="https://huster.top/htmls/tag/wordpress%e6%ba%90%e7%a0%81" class="tag-cloud-link tag-link-8 tag-link-position-27" style="font-size: 1em;">wordpress源码</a>
<a href="https://huster.top/htmls/tag/zeromq" class="tag-cloud-link tag-link-29 tag-link-position-28" style="font-size: 1em;">ZeroMQ</a>
<a href="https://huster.top/htmls/tag/zmq" class="tag-cloud-link tag-link-41 tag-link-position-29" style="font-size: 1em;">zmq</a>
<a href="https://huster.top/htmls/tag/zmq%e7%9a%84%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0" class="tag-cloud-link tag-link-42 tag-link-position-30" style="font-size: 1em;">ZMQ的学习笔记</a>
<a href="https://huster.top/htmls/tag/%e4%ba%92%e8%81%94%e7%bd%91" class="tag-cloud-link tag-link-14 tag-link-position-31" style="font-size: 1em;">互联网</a>
<a href="https://huster.top/htmls/tag/%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" class="tag-cloud-link tag-link-61 tag-link-position-32" style="font-size: 1em;">动态代理</a>
<a href="https://huster.top/htmls/tag/%e5%8f%8c%e5%bc%95%e5%8f%b7" class="tag-cloud-link tag-link-36 tag-link-position-33" style="font-size: 1em;">双引号</a>
<a href="https://huster.top/htmls/tag/%e5%a4%9a%e7%ba%bf%e7%a8%8b" class="tag-cloud-link tag-link-78 tag-link-position-34" style="font-size: 1em;">多线程</a>
<a href="https://huster.top/htmls/tag/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0" class="tag-cloud-link tag-link-28 tag-link-position-35" style="font-size: 1em;">学习笔记</a>
<a href="https://huster.top/htmls/tag/%e5%ae%89%e5%85%a8" class="tag-cloud-link tag-link-35 tag-link-position-36" style="font-size: 1em;">安全</a>
<a href="https://huster.top/htmls/tag/%e6%8a%80%e6%9c%af%e5%80%ba%e5%8a%a1" class="tag-cloud-link tag-link-30 tag-link-position-37" style="font-size: 1em;">技术债务</a>
<a href="https://huster.top/htmls/tag/%e6%97%a5%e5%bf%97" class="tag-cloud-link tag-link-32 tag-link-position-38" style="font-size: 1em;">日志</a>
<a href="https://huster.top/htmls/tag/%e6%9d%83%e5%88%a9" class="tag-cloud-link tag-link-49 tag-link-position-39" style="font-size: 1em;">权利</a>
<a href="https://huster.top/htmls/tag/%e6%9f%b4%e9%9d%99" class="tag-cloud-link tag-link-48 tag-link-position-40" style="font-size: 1em;">柴静</a>
<a href="https://huster.top/htmls/tag/%e6%b3%9b%e5%9e%8b" class="tag-cloud-link tag-link-60 tag-link-position-41" style="font-size: 1em;">泛型</a>
<a href="https://huster.top/htmls/tag/%e6%b5%8f%e8%a7%88%e5%99%a8" class="tag-cloud-link tag-link-15 tag-link-position-42" style="font-size: 1em;">浏览器</a>
<a href="https://huster.top/htmls/tag/%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1" class="tag-cloud-link tag-link-13 tag-link-position-43" style="font-size: 1em;">系统设计</a>
<a href="https://huster.top/htmls/tag/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" class="tag-cloud-link tag-link-47 tag-link-position-44" style="font-size: 1em;">读书笔记</a>
<a href="https://huster.top/htmls/tag/%e8%bd%af%e4%bb%b6%e8%ae%be%e8%ae%a1" class="tag-cloud-link tag-link-18 tag-link-position-45" style="font-size: 1em;">软件设计</a></div>
</section><section id="linkcat-2" class="widget widget_links"><h2 class="widget-title">链接表</h2>
	<ul class="xoxo blogroll"><li><a href="http://blog.sina.com.cn/rentb" rel="me" title="原来的博客地址" target="_blank">博客老地址</a></li>
<li><a href="http://blog.csdn.net/heiyeshuwu" rel="colleague" target="_blank">黑夜路人</a></li>

	</ul></section><section id="recent-comments-2" class="widget widget_recent_comments"><h2 class="widget-title">近期评论</h2><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href="https://huster.top/htmls/645.html" rel="external nofollow" class="url">如何写代码来解决生产者消费者问题？ – 三两带走</a></span>发表在《<a href="https://huster.top/htmls/615.html/comment-page-1#comment-24314">理解Java线程间的通信</a>》</li><li class="recentcomments"><span class="comment-author-link">龙安_任天兵</span>发表在《<a href="https://huster.top/htmls/557.html/comment-page-1#comment-24313">并发编程模型(转载)</a>》</li><li class="recentcomments"><span class="comment-author-link"><a href="https://huster.top/htmls/642.html" rel="external nofollow" class="url">Java多线程总结(上部分)面试题解答 – 三两带走</a></span>发表在《<a href="https://huster.top/htmls/637.html/comment-page-1#comment-24312">细说Java的内存模型</a>》</li><li class="recentcomments"><span class="comment-author-link"><a href="https://huster.top/htmls/642.html" rel="external nofollow" class="url">Java多线程总结(上部分)面试题解答 – 三两带走</a></span>发表在《<a href="https://huster.top/htmls/557.html/comment-page-1#comment-24311">并发编程模型(转载)</a>》</li><li class="recentcomments"><span class="comment-author-link">shanchao</span>发表在《<a href="https://huster.top/htmls/573.html/comment-page-1#comment-24309">spring boot应用在 POST请求的Invalid CORS request的问题</a>》</li><li class="recentcomments"><span class="comment-author-link">adimin</span>发表在《<a href="https://huster.top/htmls/462.html/comment-page-1#comment-24307">介绍spring的两个接口ApplicationContextAware和ApplicationListener</a>》</li><li class="recentcomments"><span class="comment-author-link">匿名</span>发表在《<a href="https://huster.top/htmls/462.html/comment-page-1#comment-24306">介绍spring的两个接口ApplicationContextAware和ApplicationListener</a>》</li><li class="recentcomments"><span class="comment-author-link">匿名</span>发表在《<a href="https://huster.top/htmls/472.html/comment-page-1#comment-24276">Spring boot访问js、css、图片(img)访问404无法访问的问题</a>》</li><li class="recentcomments"><span class="comment-author-link"><a href="http://kailin.li" rel="external nofollow" class="url">kailin</a></span>发表在《<a href="https://huster.top/htmls/472.html/comment-page-1#comment-24275">Spring boot访问js、css、图片(img)访问404无法访问的问题</a>》</li><li class="recentcomments"><span class="comment-author-link">基地华科男</span>发表在《<a href="https://huster.top/about-me/comment-page-2#comment-24271">关于我</a>》</li></ul></section></aside></div>

		<footer id="colophon" class="site-footer" role="contentinfo"><div class="site-info">
								<span class="site-title"><a href="https://huster.top/" rel="home">三两带走</a></span>
				<a href="https://cn.wordpress.org/">自豪地采用WordPress</a>
			</div>
		</footer></div>
</div>

<script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shCore.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushAS3.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushBash.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushColdFusion.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushClojure.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushCpp.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushCSharp.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushCss.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushDelphi.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushDiff.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushErlang.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushGroovy.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushJava.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushJavaFX.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushJScript.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushLatex.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushMatlabKey.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushObjC.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushPerl.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushPhp.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushPlain.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushPowerShell.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushPython.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushR.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushRuby.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushScala.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushSql.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushVb.js"></script><script type="text/javascript" src="https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/shBrushXml.js"></script><script type="text/javascript">
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/styles/shCore.css?ver=2.1.364";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/styles/shThemeRDark.css?ver=2.1.364";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.clipboardSwf = 'https://huster.top/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf';
	SyntaxHighlighter.config.strings.expandSource = 'show source';
	SyntaxHighlighter.config.strings.viewSource = 'view source';
	SyntaxHighlighter.config.strings.copyToClipboard = 'copy to clipboard';
	SyntaxHighlighter.config.strings.copyToClipboardConfirmation = 'The code is in your clipboard now';
	SyntaxHighlighter.config.strings.print = 'print';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['auto-links'] = false;
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	if ( typeof( jQuery ) !== 'undefined' ) {
		jQuery( function( $ ) {
			$( document.body ).on( 'post-load', function() {
				SyntaxHighlighter.highlight();
			} );
		} );
	}
</script><script type="text/javascript">
var codePrettifyLoaderBaseUrl = "https:\/\/huster.top\/wp-content\/plugins\/code-prettify\/prettify";
</script><script type="text/javascript" src="https://huster.top/wp-content/plugins/code-prettify/prettify/run_prettify.js"></script><script type="text/javascript" src="https://huster.top/wp-content/themes/twentysixteen/js/skip-link-focus-fix.js"></script><script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"\u5c55\u5f00\u5b50\u83dc\u5355","collapse":"\u6298\u53e0\u5b50\u83dc\u5355"};
/* ]]> */
</script><script type="text/javascript" src="https://huster.top/wp-content/themes/twentysixteen/js/functions.js"></script></body></html>
